.Net架构师之路(二)

[TOC]



# 14.RabbitMQ

[Course 49-51]



授课环境

1   Windows10企业版
2   Visual Studio2019  16.5
3   AspNetCore3.1
4   RabbitMQ    3.8.3

## 分布式异步队列



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616951417784.png" alt="1616951417784" style="zoom:80%;" />

分布式：多台服务器合作完成业务处理，一个业务流程中，每一个服务器完成一部分；

异步队列：有一个中间者，服务器和服务器之间的中间者



### 大数据高并发架构图

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952717064.png" alt="1616952717064" style="zoom:80%;" />



### 同步架构

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952999299.png" alt="1616952999299" style="zoom:80%;" />

**如果给你500个饺子，你能吃完吗？**
如果说让我一顿吃完，这可定搞不定；
如果是说让我一个月吃完；差不多都能搞定

同步架构是要去你马上去处理完业务



### 分布式异步队列

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616953170515.png" alt="1616953170515" style="zoom:80%;" />

拉长时间来处理业务需求；

以时间换空间

 

#### 分布式异步队列解读

**优点**：

异步处理，响应快，增加了数据库（服务器的承载能力）;
削峰，就是把流量的高峰分解到不同的时间段来处理；
解耦（扩展性就更强），让UI和业务独立演化；
高可用，处理器如果发生故障了，对其他的处理器没有影响；



**缺陷：**
1  增加了复杂性
2  即时性降低了，牺牲了用户的体验---避免不了，业务上也是需要有所牺牲；
3  更加依赖于异步队列了



#### 异步队列应用场景

618抢购，某技术负责人说需要做个需求变更；  UI 和业务逻辑层可以独立演化；
618秒杀，要求只有十件商品参与秒杀 （请求进入队列，取前10个请求，其它作废）



## 常见异步队列组件

ActiveMQ
RocketMQ
Kafka
RabbitMQ
Redis



## RabbitMQ

RabbitMQ是 2007年发布，是一个在AMQP(高级消息队列协议)基础上完成的，由Erlang（专门针对于大数据高并发的语言；）语言开发，可复用的企业消息系统，是当前最主流的消息中间件之一。

- 可靠性
- 灵活的路由
- 消息集群简单
- 队列高可用
- 多种协议的支持
- 服务器端用Erlang语言编写
- 管理界面
- 跟踪机制
- 插件机制



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955108278.png" alt="1616955108278" style="zoom:80%;" />

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955828420.png" alt="1616955828420" style="zoom:80%;" />



### RabbitMQ进程模型

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956611776.png" alt="1616956611776" style="zoom:80%;" />![1616956680213](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956680213.png)

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956611776.png" alt="1616956611776" style="zoom:80%;" />![1616956680213](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956680213.png)



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616964102558.png" alt="1616964102558" style="zoom:80%;" />



### AMQP协议 

**帧组件**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956735688.png" alt="1616956735688" style="zoom:80%;" />

1. 帧类型 

   ```shell
   1  协议头帧：指定是某种协议
   2  方法帧：携带发送给rabbitmq或者从rabbitmq接收到rpc请求或者响应
   3  内容帧： 描述一条消息的大小和属性
   4  消息体帧：消息内容
   5  心跳帧：rabbitmq和客户端直接传输的一个种数据类型；
   ```

   

2. 信道编号 

3. 以字节为单位的帧大小 

4. 帧有效载荷payload 

5. 结束字节标志（ASCII值206）



**消息组合**

如下图，一个完整的消息，由3种帧组成

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957345974.png" alt="1616957345974" style="zoom:80%;" />



### 运行环境

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957646795.png" alt="1616957646795" style="zoom:80%;" />



#### RabbitMQ 下载

 RabbitMQ包
下载地址： https://www.rabbitmq.com/
 百度云下载地址：链接：https://pan.baidu.com/s/1jmlgh6osLtfkaoNi259dSw 提取码：jskq

rabbitmq-server-windows-3.8.3.zip

https://www.rabbitmq.com/install-windows.html

Github：https://github.com/rabbitmq/

rabbitmq-server发布地址：https://github.com/rabbitmq/rabbitmq-server

>  https://github.com/rabbitmq/rabbitmq-server/releases
>
> ## RabbitMQ 3.8.14
>
> RabbitMQ `3.8.14` is a maintenance release that restores
> Erlang 22.3 compatibility for environments that use [direct reply-to](https://github.com/rabbitmq/rabbitmq-server/blob/v3.8.14/direct-reply-to.html).
>
> ### Erlang/OTP Compatibility Notes
>
> This release [requires Erlang 22.3](https://www.rabbitmq.com/which-erlang.html).
> [Erlang 23](http://blog.erlang.org/OTP-23-Highlights/) is highly recommended
> for best forward compatibility with future RabbitMQ versions.
>
> [Provisioning Latest Erlang Releases](https://www.rabbitmq.com/which-erlang.html#erlang-repositories) explains
>
> <img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616995683856.png" alt="1616995683856" style="zoom:50%;" />
>
> 与其对应的Erlang的windows版本下载地址：https://erlang.org/download/otp_versions_tree.html
>
> 
>
> what package repositories and tools can be used to provision a recent version of Erlang `23.x`.
>
> --------





这里下载 [rabbitmq-server-windows-3.8.14.zip](https://github-releases.githubusercontent.com/924551/07175f00-7b7e-11eb-959e-24f9fa2f9dac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20210329%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210329T050414Z&X-Amz-Expires=300&X-Amz-Signature=a2f64eab21603e20f99f4a09921d75f5b5df13118408a1b1b396edbbee6e55e7&X-Amz-SignedHeaders=host&actor_id=35329755&key_id=0&repo_id=924551&response-content-disposition=attachment%3B filename%3Drabbitmq-server-windows-3.8.14.zip&response-content-type=application%2Foctet-stream) 版本





与Erlang的版本对应关系：

https://www.rabbitmq.com/which-erlang.html



![1616994461706](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616994461706.png)

Erlang的版本仓储： https://www.rabbitmq.com/which-erlang.html#erlang-repositories

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616995683856.png" alt="1616995683856" style="zoom:50%;" />

Erlang的windows版本https://erlang.org/download/otp_versions_tree.html

其实跳转到的下载地址是这里：



https://github.com/erlang/otp/releases



#### Erlang环境

官网：https://www.erlang.org/

下载地址：https://www.erlang.org/downloads

https://erlang.org/download/otp_versions_tree.html

https://github.com/erlang/otp/releases

 Erlang语言运行环境
下载地址：http://www.erlang.org/downloads
 百度云下载地址：https://pan.baidu.com/s/1eHRa6BZZ3UN-Cj4Of8sASA 提取码：ou3k

esl-erlang_22.1_windows_amd64.exe

Github:https://github.com/erlang/otp



我们得下载 22.3~23.x 版本才行

https://www.erlang.org/downloads

![1616997534577](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616997534577.png)

[otp_win64_23.3.exe](http://erlang.org/download/otp_win64_23.3.exe)



#### Windows安装

>参考资料：
>
>https://blog.csdn.net/fisea/article/details/111876676



##### 先安装Erlang

安装 [otp_win64_23.3.exe](http://erlang.org/download/otp_win64_23.3.exe)，安装目录：`C:\Program Files\erl-23.3`

> 其它版本下载：https://www.erlang.org/downloads

然后设置环境变量

**ERLANG_HOME**：C:\Program Files\erl-23.3
**Path**: %ERLANG_HOME%\bin

运行**CMD**:

```shell
C:\Users\wei>erl -v
Eshell V11.2  (abort with ^G)
1>
```

说明安装成功。



##### 安装RabbitMQ

> - 其它版本下载地址：https://github.com/rabbitmq/rabbitmq-server/releases
>
> - 与Erlang的版本对应关系：https://www.rabbitmq.com/which-erlang.html



 解压 [rabbitmq-server-windows-3.8.14.zip](https://github-releases.githubusercontent.com/924551/07175f00-7b7e-11eb-959e-24f9fa2f9dac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20210329%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210329T050414Z&X-Amz-Expires=300&X-Amz-Signature=a2f64eab21603e20f99f4a09921d75f5b5df13118408a1b1b396edbbee6e55e7&X-Amz-SignedHeaders=host&actor_id=35329755&key_id=0&repo_id=924551&response-content-disposition=attachment%3B filename%3Drabbitmq-server-windows-3.8.14.zip&response-content-type=application%2Foctet-stream) 版本，然后把文件夹`rabbitmq_server-3.8.14`拷贝到`C:\Program Files\`,即最终目录为：

`C:\Program Files\rabbitmq_server-3.8.14`

 以管理员身份运行**CMD**

```powershell
C:\WINDOWS\system32>cd C:\Program Files\rabbitmq_server-3.8.14\sbin

#安装服务
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service install
#安装成功提示
C:\Program Files\erl-23.3\erts-11.2\bin\erlsrv: Service RabbitMQ added to system.
C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

> 这时看注册表：<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000004830.png" alt="1617000004830" style="zoom:80%;" />
>
> 
>
> 如果之前安装过，再安装，有可能安装失败，可以先如上图的注册表`RabbitMQ`节点删除掉。



接着启用并启动服务

```powershell
#服气启用
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service enable

#服务启动
C:\Program Files\erl-23.3\erts-11.2\bin\erlsrv: Service RabbitMQ enabled.

C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service start
RabbitMQ 服务正在启动 .
RabbitMQ 服务已经启动成功。


C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

查看windows服务：这时多出了一个`RabbitMQ`的windows服务

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000457654.png" alt="1617000457654" style="zoom:80%;" />

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000580819.png" alt="1617000580819" style="zoom:80%;" />



查看服务器状态：

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Error: unable to perform an operation on node 'rabbit@DESKTOP-E6NOF0N'. Please see diagnostics information and suggestions below.

Most common reasons for this are:

 * Target node is unreachable (e.g. due to hostname resolution, TCP connection or firewall issues)
 * CLI tool fails to authenticate with the server (e.g. due to CLI tool's Erlang cookie not matching that of the server)
 * Target node is not running

In addition to the diagnostics info below:

 * See the CLI, clustering and networking guides on https://rabbitmq.com/documentation.html to learn more
 * Consult server logs on node rabbit@DESKTOP-E6NOF0N
 * If target node is configured to use long node names, don't forget to use --longnames with CLI tools

DIAGNOSTICS
===========

attempted to contact: ['rabbit@DESKTOP-E6NOF0N']

rabbit@DESKTOP-E6NOF0N:
  * connected to epmd (port 4369) on DESKTOP-E6NOF0N
  * epmd reports node 'rabbit' uses port 25672 for inter-node and CLI tool traffic
  * TCP connection succeeded but Erlang distribution failed
  * suggestion: check if the Erlang cookie identical for all server nodes and CLI tools
  * suggestion: check if all server nodes and CLI tools use consistent hostnames when addressing each other
  * suggestion: check if inter-node connections may be configured to use TLS. If so, all nodes and CLI tools must do that
   * suggestion: see the CLI, clustering and networking guides on https://rabbitmq.com/documentation.html to learn more


Current node details:
 * node name: 'rabbitmqcli-369-rabbit@DESKTOP-E6NOF0N'
 * effective user's home directory: C:\Users\wei
 * Erlang cookie hash: WdpOFxVp/R53mEM5zLwTCQ==
```



出现以上的错误，或者其它如下图所示错误：

![1617001252098](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617001252098.png)

解决方法：

将`C:\Users\wei\`目录中的文件`.erlang.cookie`拷贝到如下两个目录：

```powershell
# 这个文件夹已经存在同名文件.erlang.cookie，将其覆盖
C:\Windows\System32\config\systemprofile 
C:\Program Files\rabbitmq_server-3.8.14\sbin
```

然后重启RabbitMQ的windows服务，再不行重启电脑

再查看服务状态：

```shell
# 提示一些错误
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Error: this command requires the 'rabbit' app to be running on the target node. Start it with 'rabbitmqctl start_app'.
Arguments given:
        status

[1mUsage[0m

rabbitmqctl [--node <node>] [--longnames] [--quiet] status [--unit <unit>] [--timeout <timeout>]


# 若还是提示以上些错误，多启动windows服务几次，等待久一点
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Status of node rabbit@DESKTOP-E6NOF0N ...
[1mRuntime[0m

OS PID: 10516
OS: Windows
Uptime (seconds): 246
Is under maintenance?: false
RabbitMQ version: 3.8.14
Node name: rabbit@DESKTOP-E6NOF0N
Erlang configuration: Erlang/OTP 23 [erts-11.2] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1]
Erlang processes: 308 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60

[1mPlugins[0m

Enabled plugin file: c:/Users/wei/AppData/Roaming/RabbitMQ/enabled_plugins
Enabled plugins:


[1mData directory[0m

Node data directory: c:/Users/wei/AppData/Roaming/RabbitMQ/db/rabbit@DESKTOP-E6NOF0N-mnesia
Raft data directory: c:/Users/wei/AppData/Roaming/RabbitMQ/db/rabbit@DESKTOP-E6NOF0N-mnesia/quorum/rabbit@DESKTOP-E6NOF0N

[1mConfig files[0m


[1mLog file(s)[0m

 * c:/Users/wei/AppData/Roaming/RabbitMQ/log/rabbit@DESKTOP-E6NOF0N.log
 * c:/Users/wei/AppData/Roaming/RabbitMQ/log/rabbit@DESKTOP-E6NOF0N_upgrade.log

[1mAlarms[0m

(none)

[1mMemory[0m

Total memory used: 0.12 gb
Calculation strategy: rss
Memory high watermark setting: 0.4 of available memory, computed to: 6.8238 gb

other_proc: 0.0459 gb (36.07 %)
allocated_unused: 0.031 gb (24.36 %)
code: 0.0293 gb (23.0 %)
other_system: 0.0155 gb (12.19 %)
other_ets: 0.003 gb (2.38 %)
atom: 0.0014 gb (1.07 %)
plugins: 0.0004 gb (0.35 %)
binary: 0.0003 gb (0.27 %)
metrics: 0.0002 gb (0.17 %)
mnesia: 0.0001 gb (0.07 %)
quorum_ets: 0.0 gb (0.04 %)
msg_index: 0.0 gb (0.03 %)
connection_channels: 0.0 gb (0.0 %)
connection_other: 0.0 gb (0.0 %)
connection_readers: 0.0 gb (0.0 %)
connection_writers: 0.0 gb (0.0 %)
mgmt_db: 0.0 gb (0.0 %)
queue_procs: 0.0 gb (0.0 %)
queue_slave_procs: 0.0 gb (0.0 %)
quorum_queue_procs: 0.0 gb (0.0 %)
reserved_unallocated: 0.0 gb (0.0 %)

[1mFile Descriptors[0m

Total: 2, limit: 65439
Sockets: 0, limit: 58893

[1mFree Disk Space[0m

Low free disk space watermark: 0.05 gb
Free disk space: 105.4149 gb

[1mTotals[0m

Connection count: 0
Queue count: 0
Virtual host count: 1

[1mListeners[0m

Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Interface: 0.0.0.0, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

看到以上输出，说明已经正常启动了

###### 管理界面

> RabbitMQ插件:https://www.rabbitmq.com/management.html



从查看服务运行状态看：

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status

[1mListeners[0m

Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Interface: 0.0.0.0, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
```

并没有开启**管理界面插件（插件名：rabbitmq_management ，监听端口为：15672）**，

> 默认的开启的插件，每个版本可能不一样

查看下插件列表：

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins list
Listing plugins with pattern ".*" ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@DESKTOP-E6NOF0N
 |/
[  ] rabbitmq_amqp1_0                  3.8.14
[  ] rabbitmq_auth_backend_cache       3.8.14
[  ] rabbitmq_auth_backend_http        3.8.14
[  ] rabbitmq_auth_backend_ldap        3.8.14
[  ] rabbitmq_auth_backend_oauth2      3.8.14
[  ] rabbitmq_auth_mechanism_ssl       3.8.14
[  ] rabbitmq_consistent_hash_exchange 3.8.14
[  ] rabbitmq_event_exchange           3.8.14
[  ] rabbitmq_federation               3.8.14
[  ] rabbitmq_federation_management    3.8.14
[  ] rabbitmq_jms_topic_exchange       3.8.14
[  ] rabbitmq_management               3.8.14
[  ] rabbitmq_management_agent         3.8.14
[  ] rabbitmq_mqtt                     3.8.14
[  ] rabbitmq_peer_discovery_aws       3.8.14
[  ] rabbitmq_peer_discovery_common    3.8.14
[  ] rabbitmq_peer_discovery_consul    3.8.14
[  ] rabbitmq_peer_discovery_etcd      3.8.14
[  ] rabbitmq_peer_discovery_k8s       3.8.14
[  ] rabbitmq_prometheus               3.8.14
[  ] rabbitmq_random_exchange          3.8.14
[  ] rabbitmq_recent_history_exchange  3.8.14
[  ] rabbitmq_sharding                 3.8.14
[  ] rabbitmq_shovel                   3.8.14
[  ] rabbitmq_shovel_management        3.8.14
[  ] rabbitmq_stomp                    3.8.14
[  ] rabbitmq_top                      3.8.14
[  ] rabbitmq_tracing                  3.8.14
[  ] rabbitmq_trust_store              3.8.14
[  ] rabbitmq_web_dispatch             3.8.14
[  ] rabbitmq_web_mqtt                 3.8.14
[  ] rabbitmq_web_mqtt_examples        3.8.14
[  ] rabbitmq_web_stomp                3.8.14
[  ] rabbitmq_web_stomp_examples       3.8.14
```

确实没有启用，现在开始启用：

```powershell
#启用插件rabbitmq_management
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins enable rabbitmq_management
Enabling plugins on node rabbit@DESKTOP-E6NOF0N:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@DESKTOP-E6NOF0N...
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch

started 3 plugins.

# 查看是否启用插件成功
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins list rabbitmq_management
Listing plugins with pattern "rabbitmq_management" ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@DESKTOP-E6NOF0N
 |/
[E*] rabbitmq_management       3.8.14
[e*] rabbitmq_management_agent 3.8.14
```

启用插件成功后，访问：http://localhost:15672/

![1617003649133](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617003649133.png)

查看用户列表：

```shell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl list_users
Listing users ...
user    tags
guest   [administrator]

```

guest是管理员账号，密码是：guest，现在使用其进行登录

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617003849181.png" alt="1617003849181" style="zoom:80%;" />

##### 用户

```powershell
//创建用户testuser密码为123456 
rabbitmqctl  add_user testuser 123456   

//赋予testuser读写所有消息队列的权限
rabbitmqctl  set_permissions testuser ".*"  ".*"  ".*"    

//分配用户组(administrator)
rabbitmqctl  set_user_tags testuser administrator    
```



##### 卸载RabbitMQ 和Erlang环境

1   打开Windows控制面板，双击“程序和功能”。
2   在当前安装的程序列表中，右键单击RabbitMQ Server，然后单击“卸载”。
3   在当前安装的程序列表中，右键单击“Erlang OTP”，然后单击“卸载”。
4   打开Windows任务管理器。
5   在任务管理器中，查找进程epmd.exe。 如果此进程仍在运行，请右键单击该进程，然后单击“结束进程”。
6   删除RabbitMQ和Erlang的所有安装目录。
7   删除文件C：\ Windows \ .erlang.cookie（如果存在）。
8   删除电脑找那个所有的.erlang.cookie。
9   同样在User文件夹中，转到AppData \ Roaming \ RabbitMQ。删除RabbitMQ
10 打开运行cmd->sc delete RabbitMQ。
11 打开运行->regedit 找到RabbitMQ节点，删掉即可



##### 其它

 为了方便查找 ， 设置如下环境变量 ，这样可以在任何地方在CMD运行

**RABBITMQ_SERVER:** C:\Program Files\erl_rabbitmq_server-3.8.3(根目录)
**Path** ：％RABBITMQ_SERVER％\sbin