.Net架构师之路(二)

[TOC]



# 14.RabbitMQ

[Course 49-51]



授课环境

1   Windows10企业版
2   Visual Studio2019  16.5
3   AspNetCore3.1
4   RabbitMQ    3.8.3

## 分布式异步队列



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616951417784.png" alt="1616951417784" style="zoom:80%;" />

分布式：多台服务器合作完成业务处理，一个业务流程中，每一个服务器完成一部分；

异步队列：有一个中间者，服务器和服务器之间的中间者



### 大数据高并发架构图

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952717064.png" alt="1616952717064" style="zoom:80%;" />



### 同步架构

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952999299.png" alt="1616952999299" style="zoom:80%;" />

**如果给你500个饺子，你能吃完吗？**
如果说让我一顿吃完，这可定搞不定；
如果是说让我一个月吃完；差不多都能搞定

同步架构是要去你马上去处理完业务



### 分布式异步队列

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616953170515.png" alt="1616953170515" style="zoom:80%;" />

拉长时间来处理业务需求；

以时间换空间

 

#### 分布式异步队列解读

**优点**：

异步处理，响应快，增加了数据库（服务器的承载能力）;
削峰，就是把流量的高峰分解到不同的时间段来处理；
解耦（扩展性就更强），让UI和业务独立演化；
高可用，处理器如果发生故障了，对其他的处理器没有影响；



**缺陷：**
1  增加了复杂性
2  即时性降低了，牺牲了用户的体验---避免不了，业务上也是需要有所牺牲；
3  更加依赖于异步队列了



#### 异步队列应用场景

618抢购，某技术负责人说需要做个需求变更；  UI 和业务逻辑层可以独立演化；
618秒杀，要求只有十件商品参与秒杀 （请求进入队列，取前10个请求，其它作废）



## 常见异步队列组件

ActiveMQ
RocketMQ
Kafka
RabbitMQ
Redis



## RabbitMQ

RabbitMQ是 2007年发布，是一个在AMQP(高级消息队列协议)基础上完成的，由Erlang（专门针对于大数据高并发的语言；）语言开发，可复用的企业消息系统，是当前最主流的消息中间件之一。

- 可靠性
- 灵活的路由
- 消息集群简单
- 队列高可用
- 多种协议的支持
- 服务器端用Erlang语言编写
- 管理界面
- 跟踪机制
- 插件机制



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955108278.png" alt="1616955108278" style="zoom:80%;" />

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955828420.png" alt="1616955828420" style="zoom:80%;" />



### RabbitMQ进程模型

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956611776.png" alt="1616956611776" style="zoom:80%;" />![1616956680213](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956680213.png)

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956611776.png" alt="1616956611776" style="zoom:80%;" />![1616956680213](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956680213.png)



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616964102558.png" alt="1616964102558" style="zoom:80%;" />



### AMQP协议 

**帧组件**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956735688.png" alt="1616956735688" style="zoom:80%;" />

1. 帧类型 

   ```shell
   1  协议头帧：指定是某种协议
   2  方法帧：携带发送给rabbitmq或者从rabbitmq接收到rpc请求或者响应
   3  内容帧： 描述一条消息的大小和属性
   4  消息体帧：消息内容
   5  心跳帧：rabbitmq和客户端直接传输的一个种数据类型；
   ```

   

2. 信道编号 

3. 以字节为单位的帧大小 

4. 帧有效载荷payload 

5. 结束字节标志（ASCII值206）



**消息组合**

如下图，一个完整的消息，由3种帧组成

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957345974.png" alt="1616957345974" style="zoom:80%;" />



### 运行环境

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957646795.png" alt="1616957646795" style="zoom:80%;" />

