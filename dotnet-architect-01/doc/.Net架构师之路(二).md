.Netæ¶æ„å¸ˆä¹‹è·¯(äºŒ)

[TOC]



# 14.RabbitMQ

[Course 49-51]



æˆè¯¾ç¯å¢ƒ

1   Windows10ä¼ä¸šç‰ˆ
2   Visual Studio2019  16.5
3   AspNetCore3.1
4   RabbitMQ    3.8.3

## åˆ†å¸ƒå¼å¼‚æ­¥é˜Ÿåˆ—



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616951417784.png" alt="1616951417784" style="zoom:80%;" />

åˆ†å¸ƒå¼ï¼šå¤šå°æœåŠ¡å™¨åˆä½œå®Œæˆä¸šåŠ¡å¤„ç†ï¼Œä¸€ä¸ªä¸šåŠ¡æµç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªæœåŠ¡å™¨å®Œæˆä¸€éƒ¨åˆ†ï¼›

å¼‚æ­¥é˜Ÿåˆ—ï¼šæœ‰ä¸€ä¸ªä¸­é—´è€…ï¼ŒæœåŠ¡å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸­é—´è€…



### å¤§æ•°æ®é«˜å¹¶å‘æ¶æ„å›¾

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952717064.png" alt="1616952717064" style="zoom:80%;" />



### åŒæ­¥æ¶æ„

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616952999299.png" alt="1616952999299" style="zoom:80%;" />

**å¦‚æœç»™ä½ 500ä¸ªé¥ºå­ï¼Œä½ èƒ½åƒå®Œå—ï¼Ÿ**
å¦‚æœè¯´è®©æˆ‘ä¸€é¡¿åƒå®Œï¼Œè¿™å¯å®šæä¸å®šï¼›
å¦‚æœæ˜¯è¯´è®©æˆ‘ä¸€ä¸ªæœˆåƒå®Œï¼›å·®ä¸å¤šéƒ½èƒ½æå®š

åŒæ­¥æ¶æ„æ˜¯è¦å»ä½ é©¬ä¸Šå»å¤„ç†å®Œä¸šåŠ¡



### åˆ†å¸ƒå¼å¼‚æ­¥é˜Ÿåˆ—

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616953170515.png" alt="1616953170515" style="zoom:80%;" />

æ‹‰é•¿æ—¶é—´æ¥å¤„ç†ä¸šåŠ¡éœ€æ±‚ï¼›

ä»¥æ—¶é—´æ¢ç©ºé—´

 

#### åˆ†å¸ƒå¼å¼‚æ­¥é˜Ÿåˆ—è§£è¯»

**ä¼˜ç‚¹**ï¼š

å¼‚æ­¥å¤„ç†ï¼Œå“åº”å¿«ï¼Œå¢åŠ äº†æ•°æ®åº“ï¼ˆæœåŠ¡å™¨çš„æ‰¿è½½èƒ½åŠ›ï¼‰;
å‰Šå³°ï¼Œå°±æ˜¯æŠŠæµé‡çš„é«˜å³°åˆ†è§£åˆ°ä¸åŒçš„æ—¶é—´æ®µæ¥å¤„ç†ï¼›
è§£è€¦ï¼ˆæ‰©å±•æ€§å°±æ›´å¼ºï¼‰ï¼Œè®©UIå’Œä¸šåŠ¡ç‹¬ç«‹æ¼”åŒ–ï¼›
é«˜å¯ç”¨ï¼Œå¤„ç†å™¨å¦‚æœå‘ç”Ÿæ•…éšœäº†ï¼Œå¯¹å…¶ä»–çš„å¤„ç†å™¨æ²¡æœ‰å½±å“ï¼›



**ç¼ºé™·ï¼š**
1  å¢åŠ äº†å¤æ‚æ€§
2  å³æ—¶æ€§é™ä½äº†ï¼Œç‰ºç‰²äº†ç”¨æˆ·çš„ä½“éªŒ---é¿å…ä¸äº†ï¼Œä¸šåŠ¡ä¸Šä¹Ÿæ˜¯éœ€è¦æœ‰æ‰€ç‰ºç‰²ï¼›
3  æ›´åŠ ä¾èµ–äºå¼‚æ­¥é˜Ÿåˆ—äº†



#### å¼‚æ­¥é˜Ÿåˆ—åº”ç”¨åœºæ™¯

618æŠ¢è´­ï¼ŒæŸæŠ€æœ¯è´Ÿè´£äººè¯´éœ€è¦åšä¸ªéœ€æ±‚å˜æ›´ï¼›  UI å’Œä¸šåŠ¡é€»è¾‘å±‚å¯ä»¥ç‹¬ç«‹æ¼”åŒ–ï¼›
618ç§’æ€ï¼Œè¦æ±‚åªæœ‰åä»¶å•†å“å‚ä¸ç§’æ€ ï¼ˆè¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼Œå–å‰10ä¸ªè¯·æ±‚ï¼Œå…¶å®ƒä½œåºŸï¼‰



## å¸¸è§å¼‚æ­¥é˜Ÿåˆ—ç»„ä»¶

ActiveMQ
RocketMQ
Kafka
RabbitMQ
Redis



## RabbitMQ

RabbitMQæ˜¯ 2007å¹´å‘å¸ƒï¼Œæ˜¯ä¸€ä¸ªåœ¨AMQP(é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®)åŸºç¡€ä¸Šå®Œæˆçš„ï¼Œç”±Erlangï¼ˆä¸“é—¨é’ˆå¯¹äºå¤§æ•°æ®é«˜å¹¶å‘çš„è¯­è¨€ï¼›ï¼‰è¯­è¨€å¼€å‘ï¼Œå¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿï¼Œæ˜¯å½“å‰æœ€ä¸»æµçš„æ¶ˆæ¯ä¸­é—´ä»¶ä¹‹ä¸€ã€‚

- å¯é æ€§
- çµæ´»çš„è·¯ç”±
- æ¶ˆæ¯é›†ç¾¤ç®€å•
- é˜Ÿåˆ—é«˜å¯ç”¨
- å¤šç§åè®®çš„æ”¯æŒ
- æœåŠ¡å™¨ç«¯ç”¨Erlangè¯­è¨€ç¼–å†™
- ç®¡ç†ç•Œé¢
- è·Ÿè¸ªæœºåˆ¶
- æ’ä»¶æœºåˆ¶



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955108278.png" alt="1616955108278" style="zoom:80%;" />

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616955828420.png" alt="1616955828420" style="zoom:80%;" />



### RabbitMQè¿›ç¨‹æ¨¡å‹

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956611776.png" alt="1616956611776" style="zoom:80%;" />![1616956680213](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956680213.png)



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616964102558.png" alt="1616964102558" style="zoom:80%;" />



### AMQPåè®® 

**å¸§ç»„ä»¶**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616956735688.png" alt="1616956735688" style="zoom:80%;" />

1. å¸§ç±»å‹ 

   ```shell
   1  åè®®å¤´å¸§ï¼šæŒ‡å®šæ˜¯æŸç§åè®®
   2  æ–¹æ³•å¸§ï¼šæºå¸¦å‘é€ç»™rabbitmqæˆ–è€…ä»rabbitmqæ¥æ”¶åˆ°rpcè¯·æ±‚æˆ–è€…å“åº”
   3  å†…å®¹å¸§ï¼š æè¿°ä¸€æ¡æ¶ˆæ¯çš„å¤§å°å’Œå±æ€§
   4  æ¶ˆæ¯ä½“å¸§ï¼šæ¶ˆæ¯å†…å®¹
   5  å¿ƒè·³å¸§ï¼šrabbitmqå’Œå®¢æˆ·ç«¯ç›´æ¥ä¼ è¾“çš„ä¸€ä¸ªç§æ•°æ®ç±»å‹ï¼›
   ```

   

2. ä¿¡é“ç¼–å· 

3. ä»¥å­—èŠ‚ä¸ºå•ä½çš„å¸§å¤§å° 

4. å¸§æœ‰æ•ˆè½½è·payload 

5. ç»“æŸå­—èŠ‚æ ‡å¿—ï¼ˆASCIIå€¼206ï¼‰



**æ¶ˆæ¯ç»„åˆ**

å¦‚ä¸‹å›¾ï¼Œä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼Œç”±3ç§å¸§ç»„æˆ

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957345974.png" alt="1616957345974" style="zoom:80%;" />



### è¿è¡Œç¯å¢ƒ

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616957646795.png" alt="1616957646795" style="zoom:80%;" />



#### RabbitMQ ä¸‹è½½

 RabbitMQåŒ…
ä¸‹è½½åœ°å€ï¼š https://www.rabbitmq.com/
 ç™¾åº¦äº‘ä¸‹è½½åœ°å€ï¼šé“¾æ¥ï¼šhttps://pan.baidu.com/s/1jmlgh6osLtfkaoNi259dSw æå–ç ï¼šjskq

rabbitmq-server-windows-3.8.3.zip

https://www.rabbitmq.com/install-windows.html

Githubï¼šhttps://github.com/rabbitmq/

rabbitmq-serverå‘å¸ƒåœ°å€ï¼šhttps://github.com/rabbitmq/rabbitmq-server

>  https://github.com/rabbitmq/rabbitmq-server/releases
>
> ## RabbitMQ 3.8.14
>
> RabbitMQ `3.8.14` is a maintenance release that restores
> Erlang 22.3 compatibility for environments that use [direct reply-to](https://github.com/rabbitmq/rabbitmq-server/blob/v3.8.14/direct-reply-to.html).
>
> ### Erlang/OTP Compatibility Notes
>
> This release [requires Erlang 22.3](https://www.rabbitmq.com/which-erlang.html).
> [Erlang 23](http://blog.erlang.org/OTP-23-Highlights/) is highly recommended
> for best forward compatibility with future RabbitMQ versions.
>
> [Provisioning Latest Erlang Releases](https://www.rabbitmq.com/which-erlang.html#erlang-repositories) explains
>
> <img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616995683856.png" alt="1616995683856" style="zoom:50%;" />
>
> ä¸å…¶å¯¹åº”çš„Erlangçš„windowsç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://erlang.org/download/otp_versions_tree.html
>
> 
>
> what package repositories and tools can be used to provision a recent version of Erlang `23.x`.
>
> --------





è¿™é‡Œä¸‹è½½ [rabbitmq-server-windows-3.8.14.zip](https://github-releases.githubusercontent.com/924551/07175f00-7b7e-11eb-959e-24f9fa2f9dac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20210329%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210329T050414Z&X-Amz-Expires=300&X-Amz-Signature=a2f64eab21603e20f99f4a09921d75f5b5df13118408a1b1b396edbbee6e55e7&X-Amz-SignedHeaders=host&actor_id=35329755&key_id=0&repo_id=924551&response-content-disposition=attachment%3B filename%3Drabbitmq-server-windows-3.8.14.zip&response-content-type=application%2Foctet-stream) ç‰ˆæœ¬





ä¸Erlangçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š

https://www.rabbitmq.com/which-erlang.html



![1616994461706](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616994461706.png)

Erlangçš„ç‰ˆæœ¬ä»“å‚¨ï¼š https://www.rabbitmq.com/which-erlang.html#erlang-repositories

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616995683856.png" alt="1616995683856" style="zoom:50%;" />

Erlangçš„windowsç‰ˆæœ¬https://erlang.org/download/otp_versions_tree.html

å…¶å®è·³è½¬åˆ°çš„ä¸‹è½½åœ°å€æ˜¯è¿™é‡Œï¼š



https://github.com/erlang/otp/releases



#### Erlangç¯å¢ƒ

å®˜ç½‘ï¼šhttps://www.erlang.org/

ä¸‹è½½åœ°å€ï¼šhttps://www.erlang.org/downloads

https://erlang.org/download/otp_versions_tree.html

https://github.com/erlang/otp/releases

 Erlangè¯­è¨€è¿è¡Œç¯å¢ƒ
ä¸‹è½½åœ°å€ï¼šhttp://www.erlang.org/downloads
 ç™¾åº¦äº‘ä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1eHRa6BZZ3UN-Cj4Of8sASA æå–ç ï¼šou3k

esl-erlang_22.1_windows_amd64.exe

Github:https://github.com/erlang/otp



æˆ‘ä»¬å¾—ä¸‹è½½ 22.3~23.x ç‰ˆæœ¬æ‰è¡Œ

https://www.erlang.org/downloads

![1616997534577](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616997534577.png)

[otp_win64_23.3.exe](http://erlang.org/download/otp_win64_23.3.exe)



#### Windowså®‰è£…

>å‚è€ƒèµ„æ–™ï¼š
>
>https://blog.csdn.net/fisea/article/details/111876676



##### å…ˆå®‰è£…Erlang

å®‰è£… [otp_win64_23.3.exe](http://erlang.org/download/otp_win64_23.3.exe)ï¼Œå®‰è£…ç›®å½•ï¼š`C:\Program Files\erl-23.3`

> å…¶å®ƒç‰ˆæœ¬ä¸‹è½½ï¼šhttps://www.erlang.org/downloads

ç„¶åè®¾ç½®ç¯å¢ƒå˜é‡

**ERLANG_HOME**ï¼šC:\Program Files\erl-23.3
**Path**: %ERLANG_HOME%\bin

è¿è¡Œ**CMD**:

```shell
C:\Users\wei>erl -v
Eshell V11.2  (abort with ^G)
1>
```

è¯´æ˜å®‰è£…æˆåŠŸã€‚



##### å®‰è£…RabbitMQ

> - å…¶å®ƒç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼šhttps://github.com/rabbitmq/rabbitmq-server/releases
>
> - ä¸Erlangçš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼šhttps://www.rabbitmq.com/which-erlang.html



 è§£å‹ [rabbitmq-server-windows-3.8.14.zip](https://github-releases.githubusercontent.com/924551/07175f00-7b7e-11eb-959e-24f9fa2f9dac?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20210329%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210329T050414Z&X-Amz-Expires=300&X-Amz-Signature=a2f64eab21603e20f99f4a09921d75f5b5df13118408a1b1b396edbbee6e55e7&X-Amz-SignedHeaders=host&actor_id=35329755&key_id=0&repo_id=924551&response-content-disposition=attachment%3B filename%3Drabbitmq-server-windows-3.8.14.zip&response-content-type=application%2Foctet-stream) ç‰ˆæœ¬ï¼Œç„¶åæŠŠæ–‡ä»¶å¤¹`rabbitmq_server-3.8.14`æ‹·è´åˆ°`C:\Program Files\`,å³æœ€ç»ˆç›®å½•ä¸ºï¼š

`C:\Program Files\rabbitmq_server-3.8.14`

 ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ**CMD**

```powershell
C:\WINDOWS\system32>cd C:\Program Files\rabbitmq_server-3.8.14\sbin

#å®‰è£…ä¸ºwindowsæœåŠ¡
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service install
#å®‰è£…æˆåŠŸæç¤º
C:\Program Files\erl-23.3\erts-11.2\bin\erlsrv: Service RabbitMQ added to system.
C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

> è¿™æ—¶çœ‹æ³¨å†Œè¡¨ï¼š<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000004830.png" alt="1617000004830" style="zoom:80%;" />
>
> 
>
> å¦‚æœä¹‹å‰å®‰è£…è¿‡ï¼Œå†å®‰è£…ï¼Œæœ‰å¯èƒ½å®‰è£…å¤±è´¥ï¼Œå¯ä»¥å…ˆå¦‚ä¸Šå›¾çš„æ³¨å†Œè¡¨`RabbitMQ`èŠ‚ç‚¹åˆ é™¤æ‰ã€‚



æ¥ç€å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡

```powershell
#æœæ°”å¯ç”¨
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service enable

#æœåŠ¡å¯åŠ¨
C:\Program Files\erl-23.3\erts-11.2\bin\erlsrv: Service RabbitMQ enabled.

C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-service start
RabbitMQ æœåŠ¡æ­£åœ¨å¯åŠ¨ .
RabbitMQ æœåŠ¡å·²ç»å¯åŠ¨æˆåŠŸã€‚


C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

æŸ¥çœ‹windowsæœåŠ¡ï¼šè¿™æ—¶å¤šå‡ºäº†ä¸€ä¸ª`RabbitMQ`çš„windowsæœåŠ¡

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000457654.png" alt="1617000457654" style="zoom:80%;" />

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617000580819.png" alt="1617000580819" style="zoom:80%;" />



æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ï¼š

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Error: unable to perform an operation on node 'rabbit@DESKTOP-E6NOF0N'. Please see diagnostics information and suggestions below.

Most common reasons for this are:

 * Target node is unreachable (e.g. due to hostname resolution, TCP connection or firewall issues)
 * CLI tool fails to authenticate with the server (e.g. due to CLI tool's Erlang cookie not matching that of the server)
 * Target node is not running

In addition to the diagnostics info below:

 * See the CLI, clustering and networking guides on https://rabbitmq.com/documentation.html to learn more
 * Consult server logs on node rabbit@DESKTOP-E6NOF0N
 * If target node is configured to use long node names, don't forget to use --longnames with CLI tools

DIAGNOSTICS
===========

attempted to contact: ['rabbit@DESKTOP-E6NOF0N']

rabbit@DESKTOP-E6NOF0N:
  * connected to epmd (port 4369) on DESKTOP-E6NOF0N
  * epmd reports node 'rabbit' uses port 25672 for inter-node and CLI tool traffic
  * TCP connection succeeded but Erlang distribution failed
  * suggestion: check if the Erlang cookie identical for all server nodes and CLI tools
  * suggestion: check if all server nodes and CLI tools use consistent hostnames when addressing each other
  * suggestion: check if inter-node connections may be configured to use TLS. If so, all nodes and CLI tools must do that
   * suggestion: see the CLI, clustering and networking guides on https://rabbitmq.com/documentation.html to learn more


Current node details:
 * node name: 'rabbitmqcli-369-rabbit@DESKTOP-E6NOF0N'
 * effective user's home directory: C:\Users\wei
 * Erlang cookie hash: WdpOFxVp/R53mEM5zLwTCQ==
```



å‡ºç°ä»¥ä¸Šçš„é”™è¯¯ï¼Œæˆ–è€…å…¶å®ƒå¦‚ä¸‹å›¾æ‰€ç¤ºé”™è¯¯ï¼š

![1617001252098](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617001252098.png)

è§£å†³æ–¹æ³•ï¼š

å°†`C:\Users\wei\`ç›®å½•ä¸­çš„æ–‡ä»¶`.erlang.cookie`æ‹·è´åˆ°å¦‚ä¸‹ä¸¤ä¸ªç›®å½•ï¼š

```powershell
# è¿™ä¸ªæ–‡ä»¶å¤¹å·²ç»å­˜åœ¨åŒåæ–‡ä»¶.erlang.cookieï¼Œå°†å…¶è¦†ç›–
C:\Windows\System32\config\systemprofile 
C:\Program Files\rabbitmq_server-3.8.14\sbin
```

ç„¶åé‡å¯RabbitMQçš„windowsæœåŠ¡ï¼Œå†ä¸è¡Œé‡å¯ç”µè„‘

å†æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š

```shell
# æç¤ºä¸€äº›é”™è¯¯
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Error: this command requires the 'rabbit' app to be running on the target node. Start it with 'rabbitmqctl start_app'.
Arguments given:
        status

[1mUsage[0m

rabbitmqctl [--node <node>] [--longnames] [--quiet] status [--unit <unit>] [--timeout <timeout>]


# è‹¥è¿˜æ˜¯æç¤ºä»¥ä¸Šäº›é”™è¯¯ï¼Œå¤šå¯åŠ¨windowsæœåŠ¡å‡ æ¬¡ï¼Œç­‰å¾…ä¹…ä¸€ç‚¹
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status
Status of node rabbit@DESKTOP-E6NOF0N ...
[1mRuntime[0m

OS PID: 10516
OS: Windows
Uptime (seconds): 246
Is under maintenance?: false
RabbitMQ version: 3.8.14
Node name: rabbit@DESKTOP-E6NOF0N
Erlang configuration: Erlang/OTP 23 [erts-11.2] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1]
Erlang processes: 308 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60

[1mPlugins[0m

Enabled plugin file: c:/Users/wei/AppData/Roaming/RabbitMQ/enabled_plugins
Enabled plugins:


[1mData directory[0m

Node data directory: c:/Users/wei/AppData/Roaming/RabbitMQ/db/rabbit@DESKTOP-E6NOF0N-mnesia
Raft data directory: c:/Users/wei/AppData/Roaming/RabbitMQ/db/rabbit@DESKTOP-E6NOF0N-mnesia/quorum/rabbit@DESKTOP-E6NOF0N

[1mConfig files[0m


[1mLog file(s)[0m

 * c:/Users/wei/AppData/Roaming/RabbitMQ/log/rabbit@DESKTOP-E6NOF0N.log
 * c:/Users/wei/AppData/Roaming/RabbitMQ/log/rabbit@DESKTOP-E6NOF0N_upgrade.log

[1mAlarms[0m

(none)

[1mMemory[0m

Total memory used: 0.12 gb
Calculation strategy: rss
Memory high watermark setting: 0.4 of available memory, computed to: 6.8238 gb

other_proc: 0.0459 gb (36.07 %)
allocated_unused: 0.031 gb (24.36 %)
code: 0.0293 gb (23.0 %)
other_system: 0.0155 gb (12.19 %)
other_ets: 0.003 gb (2.38 %)
atom: 0.0014 gb (1.07 %)
plugins: 0.0004 gb (0.35 %)
binary: 0.0003 gb (0.27 %)
metrics: 0.0002 gb (0.17 %)
mnesia: 0.0001 gb (0.07 %)
quorum_ets: 0.0 gb (0.04 %)
msg_index: 0.0 gb (0.03 %)
connection_channels: 0.0 gb (0.0 %)
connection_other: 0.0 gb (0.0 %)
connection_readers: 0.0 gb (0.0 %)
connection_writers: 0.0 gb (0.0 %)
mgmt_db: 0.0 gb (0.0 %)
queue_procs: 0.0 gb (0.0 %)
queue_slave_procs: 0.0 gb (0.0 %)
quorum_queue_procs: 0.0 gb (0.0 %)
reserved_unallocated: 0.0 gb (0.0 %)

[1mFile Descriptors[0m

Total: 2, limit: 65439
Sockets: 0, limit: 58893

[1mFree Disk Space[0m

Low free disk space watermark: 0.05 gb
Free disk space: 105.4149 gb

[1mTotals[0m

Connection count: 0
Queue count: 0
Virtual host count: 1

[1mListeners[0m

Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Interface: 0.0.0.0, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

C:\Program Files\rabbitmq_server-3.8.14\sbin>
```

çœ‹åˆ°ä»¥ä¸Šè¾“å‡ºï¼Œè¯´æ˜å·²ç»æ­£å¸¸å¯åŠ¨äº†

###### ç®¡ç†ç•Œé¢

> RabbitMQæ’ä»¶:https://www.rabbitmq.com/management.html



ä»æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€çœ‹ï¼š

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl status

[1mListeners[0m

Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Interface: 0.0.0.0, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
```

å¹¶æ²¡æœ‰å¼€å¯**ç®¡ç†ç•Œé¢æ’ä»¶ï¼ˆæ’ä»¶åï¼šrabbitmq_management ï¼Œç›‘å¬ç«¯å£ä¸ºï¼š15672ï¼‰**ï¼Œ

> é»˜è®¤çš„å¼€å¯çš„æ’ä»¶ï¼Œæ¯ä¸ªç‰ˆæœ¬å¯èƒ½ä¸ä¸€æ ·

æŸ¥çœ‹ä¸‹æ’ä»¶åˆ—è¡¨ï¼š

```powershell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins list
Listing plugins with pattern ".*" ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@DESKTOP-E6NOF0N
 |/
[  ] rabbitmq_amqp1_0                  3.8.14
[  ] rabbitmq_auth_backend_cache       3.8.14
[  ] rabbitmq_auth_backend_http        3.8.14
[  ] rabbitmq_auth_backend_ldap        3.8.14
[  ] rabbitmq_auth_backend_oauth2      3.8.14
[  ] rabbitmq_auth_mechanism_ssl       3.8.14
[  ] rabbitmq_consistent_hash_exchange 3.8.14
[  ] rabbitmq_event_exchange           3.8.14
[  ] rabbitmq_federation               3.8.14
[  ] rabbitmq_federation_management    3.8.14
[  ] rabbitmq_jms_topic_exchange       3.8.14
[  ] rabbitmq_management               3.8.14
[  ] rabbitmq_management_agent         3.8.14
[  ] rabbitmq_mqtt                     3.8.14
[  ] rabbitmq_peer_discovery_aws       3.8.14
[  ] rabbitmq_peer_discovery_common    3.8.14
[  ] rabbitmq_peer_discovery_consul    3.8.14
[  ] rabbitmq_peer_discovery_etcd      3.8.14
[  ] rabbitmq_peer_discovery_k8s       3.8.14
[  ] rabbitmq_prometheus               3.8.14
[  ] rabbitmq_random_exchange          3.8.14
[  ] rabbitmq_recent_history_exchange  3.8.14
[  ] rabbitmq_sharding                 3.8.14
[  ] rabbitmq_shovel                   3.8.14
[  ] rabbitmq_shovel_management        3.8.14
[  ] rabbitmq_stomp                    3.8.14
[  ] rabbitmq_top                      3.8.14
[  ] rabbitmq_tracing                  3.8.14
[  ] rabbitmq_trust_store              3.8.14
[  ] rabbitmq_web_dispatch             3.8.14
[  ] rabbitmq_web_mqtt                 3.8.14
[  ] rabbitmq_web_mqtt_examples        3.8.14
[  ] rabbitmq_web_stomp                3.8.14
[  ] rabbitmq_web_stomp_examples       3.8.14
```

ç¡®å®æ²¡æœ‰å¯ç”¨ï¼Œç°åœ¨å¼€å§‹å¯ç”¨ï¼š

```powershell
#å¯ç”¨æ’ä»¶rabbitmq_management
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins enable rabbitmq_management
Enabling plugins on node rabbit@DESKTOP-E6NOF0N:
rabbitmq_management
The following plugins have been configured:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch
Applying plugin configuration to rabbit@DESKTOP-E6NOF0N...
The following plugins have been enabled:
  rabbitmq_management
  rabbitmq_management_agent
  rabbitmq_web_dispatch

started 3 plugins.

# æŸ¥çœ‹æ˜¯å¦å¯ç”¨æ’ä»¶æˆåŠŸ
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmq-plugins list rabbitmq_management
Listing plugins with pattern "rabbitmq_management" ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@DESKTOP-E6NOF0N
 |/
[E*] rabbitmq_management       3.8.14
[e*] rabbitmq_management_agent 3.8.14
```

å¯ç”¨æ’ä»¶æˆåŠŸåï¼Œè®¿é—®ï¼šhttp://localhost:15672/

![1617003649133](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617003649133.png)

æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼š

```shell
C:\Program Files\rabbitmq_server-3.8.14\sbin>rabbitmqctl list_users
Listing users ...
user    tags
guest   [administrator]

```

guestæ˜¯ç®¡ç†å‘˜è´¦å·ï¼Œå¯†ç æ˜¯ï¼šguestï¼Œç°åœ¨ä½¿ç”¨å…¶è¿›è¡Œç™»å½•

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617003849181.png" alt="1617003849181" style="zoom:80%;" />

##### ç”¨æˆ·

```powershell
//åˆ›å»ºç”¨æˆ·testuserå¯†ç ä¸º123456 
rabbitmqctl  add_user testuser 123456   

//èµ‹äºˆtestuserè¯»å†™æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—çš„æƒé™
rabbitmqctl  set_permissions testuser ".*"  ".*"  ".*"    

//åˆ†é…ç”¨æˆ·ç»„(administrator)
rabbitmqctl  set_user_tags testuser administrator    
```



##### å¸è½½RabbitMQ å’ŒErlangç¯å¢ƒ

1   æ‰“å¼€Windowsæ§åˆ¶é¢æ¿ï¼ŒåŒå‡»â€œç¨‹åºå’ŒåŠŸèƒ½â€ã€‚
2   åœ¨å½“å‰å®‰è£…çš„ç¨‹åºåˆ—è¡¨ä¸­ï¼Œå³é”®å•å‡»RabbitMQ Serverï¼Œç„¶åå•å‡»â€œå¸è½½â€ã€‚
3   åœ¨å½“å‰å®‰è£…çš„ç¨‹åºåˆ—è¡¨ä¸­ï¼Œå³é”®å•å‡»â€œErlang OTPâ€ï¼Œç„¶åå•å‡»â€œå¸è½½â€ã€‚
4   æ‰“å¼€Windowsä»»åŠ¡ç®¡ç†å™¨ã€‚
5   åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ï¼ŒæŸ¥æ‰¾è¿›ç¨‹epmd.exeã€‚ å¦‚æœæ­¤è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œè¯·å³é”®å•å‡»è¯¥è¿›ç¨‹ï¼Œç„¶åå•å‡»â€œç»“æŸè¿›ç¨‹â€ã€‚
6   åˆ é™¤RabbitMQå’ŒErlangçš„æ‰€æœ‰å®‰è£…ç›®å½•ã€‚
7   åˆ é™¤æ–‡ä»¶Cï¼š\ Windows \ .erlang.cookieï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚
8   åˆ é™¤ç”µè„‘æ‰¾é‚£ä¸ªæ‰€æœ‰çš„.erlang.cookieã€‚
9   åŒæ ·åœ¨Useræ–‡ä»¶å¤¹ä¸­ï¼Œè½¬åˆ°AppData \ Roaming \ RabbitMQã€‚åˆ é™¤RabbitMQ
10 æ‰“å¼€è¿è¡Œcmd->sc delete RabbitMQã€‚
11 æ‰“å¼€è¿è¡Œ->regedit æ‰¾åˆ°RabbitMQèŠ‚ç‚¹ï¼Œåˆ æ‰å³å¯



##### å…¶å®ƒè®¾ç½®

 ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾ ï¼Œ è®¾ç½®å¦‚ä¸‹ç¯å¢ƒå˜é‡ ï¼Œè¿™æ ·å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹åœ¨CMDè¿è¡Œï¼ˆä¸è¡Œï¼ï¼ï¼ï¼‰

**RABBITMQ_SERVER:** C:\Program Files\rabbitmq_server-3.8.14 (æ ¹ç›®å½•)
**Path** ï¼šï¼…RABBITMQ_SERVERï¼…\sbin



#### Dockerå®‰è£…

é•œåƒä»“å‚¨ï¼šhttps://registry.hub.docker.com/_/rabbitmq/

ä¸‹è½½é•œåƒï¼š

```shell
[root@centos7 ~]# docker pull rabbitmq:management
management: Pulling from library/rabbitmq
6e0aa5e7af40: Pull complete 
d47239a868b3: Pull complete 
49cbb10cca85: Pull complete 
b7c2edd50e35: Pull complete 
a6bdd84df6f2: Pull complete 
db4e517e38d3: Pull complete 
b3982db455b0: Pull complete 
9f6708aa7fd0: Pull complete 
21c9ffa1be59: Pull complete 
5c6680e36ae7: Pull complete 
fffa3770b398: Pull complete 
213b533bb8a3: Pull complete 
97df3b39dc36: Pull complete 
Digest: sha256:7ac3902a85940c5c1cf4cdf0f528196b8139344bc79e9b3fa8c9b60c7a4ea293
Status: Downloaded newer image for rabbitmq:management
docker.io/library/rabbitmq:management

```



è¿è¡Œå®¹å™¨ï¼š

```shell
[root@centos7 ~]# docker run -di --name myrabitt -e RABBITMQ_DEFAULT_USER=admin  -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 25672:25672 -p 61613:61613 -p 1883:1883 rabbitmq:management 
4f795f5970b7bf00be344b6b516b7e1c28170210a5cb460d3f70fca2a119be0f
[root@centos7 ~]# docker ps 
CONTAINER ID   IMAGE    COMMAND        CREATED    STATUS       PORTS     NAMES
4f795f5970b7   rabbitmq:management   "docker-entrypoint.sâ€¦"   11 seconds ago   Up 6 seconds   4369/tcp, 5671-5672/tcp, 0.0.0.0:1883->1883/tcp, 15671/tcp, 0.0.0.0:15672->15672/tcp, 0.0.0.0:25672->25672/tcp, 0.0.0.0:61613->61613/tcp, 15691-15692/tcp   myrabitt
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```shell
[root@centos7 ~]#docker logs myrabitt
```

è®¿é—®ï¼šhttp://192.168.130.130:15672/ å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç®¡ç†ç•Œé¢

![](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616961355951.png)é»˜è®¤çš„è´¦å·å’Œå¯†ç éƒ½æ˜¯adminï¼ˆåˆ›å»ºdockerå®¹å™¨æ—¶æˆ‘ä»¬æŒ‡å®šçš„ï¼‰ï¼š

```shell
docker run -di --name myrabitt -e RABBITMQ_DEFAULT_USER=admin  -e RABBITMQ_DEFAULT_PASS=admin ......
```

æŸ¥çœ‹RabbitMQ-Dockerå®¹å™¨çš„æ’ä»¶åˆ—è¡¨å’Œå¯ç”¨çš„æ’ä»¶ï¼š

```shell
[root@centos7 ~]# docker exec -it myrabitt /bin/bash
root@4f795f5970b7:/# rabbitmq-plugins list
Listing plugins with pattern ".*" ...
 Configured: E = explicitly enabled; e = implicitly enabled
 | Status: * = running on rabbit@4f795f5970b7
 |/
[  ] rabbitmq_amqp1_0                  3.8.14
[  ] rabbitmq_auth_backend_cache       3.8.14
[  ] rabbitmq_auth_backend_http        3.8.14
[  ] rabbitmq_auth_backend_ldap        3.8.14
[  ] rabbitmq_auth_backend_oauth2      3.8.14
[  ] rabbitmq_auth_mechanism_ssl       3.8.14
[  ] rabbitmq_consistent_hash_exchange 3.8.14
[  ] rabbitmq_event_exchange           3.8.14
[  ] rabbitmq_federation               3.8.14
[  ] rabbitmq_federation_management    3.8.14
[  ] rabbitmq_jms_topic_exchange       3.8.14
[E*] rabbitmq_management               3.8.14
[e*] rabbitmq_management_agent         3.8.14
[  ] rabbitmq_mqtt                     3.8.14
[  ] rabbitmq_peer_discovery_aws       3.8.14
[  ] rabbitmq_peer_discovery_common    3.8.14
[  ] rabbitmq_peer_discovery_consul    3.8.14
[  ] rabbitmq_peer_discovery_etcd      3.8.14
[  ] rabbitmq_peer_discovery_k8s       3.8.14
[E*] rabbitmq_prometheus               3.8.14
[  ] rabbitmq_random_exchange          3.8.14
[  ] rabbitmq_recent_history_exchange  3.8.14
[  ] rabbitmq_sharding                 3.8.14
[  ] rabbitmq_shovel                   3.8.14
[  ] rabbitmq_shovel_management        3.8.14
[  ] rabbitmq_stomp                    3.8.14
[  ] rabbitmq_top                      3.8.14
[  ] rabbitmq_tracing                  3.8.14
[  ] rabbitmq_trust_store              3.8.14
[e*] rabbitmq_web_dispatch             3.8.14
[  ] rabbitmq_web_mqtt                 3.8.14
[  ] rabbitmq_web_mqtt_examples        3.8.14
[  ] rabbitmq_web_stomp                3.8.14
[  ] rabbitmq_web_stomp_examples       3.8.14
root@4f795f5970b7:/# cat /etc/rabbitmq/enabled_plugins
[rabbitmq_management,rabbitmq_prometheus].

```



#### CentOSå®‰è£…

##### **CentOSä¸‹è½½**

https://www.rabbitmq.com/download.html

è¿™é‡Œæˆ‘ä»¬ä¸‹è½½ï¼š[CentOS7.xç‰ˆæœ¬](https://github-releases.githubusercontent.com/924551/01217e00-7b7e-11eb-9ba0-11817d4f9778?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20210327%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20210327T161048Z&X-Amz-Expires=300&X-Amz-Signature=b672a597bd510fcac071a09e81bb2cd9dcafa56b69eade8a0d05d46233d7a68e&X-Amz-SignedHeaders=host&actor_id=35329755&key_id=0&repo_id=924551&response-content-disposition=attachment%3B filename%3Drabbitmq-server-3.8.14-1.el7.noarch.rpm&response-content-type=application%2Foctet-stream) ï¼šrabbitmq-server-3.8.14-1.el7.noarch.rpm ï¼Œçœ‹åˆ°æ–‡ä»¶ï¼ŒçŸ¥é“å…¶ç‰ˆæœ¬å·ä¸º3.814



##### **Erlang**ä¸‹è½½

![1616942699992](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1616942699992.png)

https://github.com/rabbitmq/erlang-rpm

https://github.com/rabbitmq/erlang-rpm/releases/tag/v23.3

 Redhat7\CentOS7å¯¹åº”çš„ç‰ˆæœ¬ï¼š [erlang-23.3-2.el7.x86_64.rpm](https://github.com/rabbitmq/erlang-rpm/releases/download/v23.3/erlang-23.3-2.el7.x86_64.rpm)



##### ä¸Šä¼ å®‰è£…åŒ…

å› ä¸ºç°åœ¨å®‰è£…åŒ…å·²ç»æ”¾åˆ°äº†Githubä¸Šï¼Œä¸‹è½½æ¯”è¾ƒæ…¢ï¼Œæ•…ï¼šå…ˆä¸‹è½½åˆ°æœ¬æœºï¼Œåœ¨ä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨ï¼Œå¯ä»¥å·²ä½¿ç”¨

Xftp è½¯ä»¶ä¸Šä¼ 



##### å®‰è£…Erlang

```shell
[root@centos7 ~]# mkdir -p /usr/rabbitmq
[root@centos7 ~]# cd /usr/rabbitmq/
# æœ¬åœ°ä¸Šä¼ å®‰è£…æ–‡ä»¶
[root@centos7 rabbitmq]# ls
erlang-23.3-2.el7.x86_64.rpm  rabbitmq-server-3.8.14-1.el7.noarch.rpm

# è§£å‹?å®‰è£…?
[root@centos7 rabbitmq]# rpm -Uvh erlang-23.3-2.el7.x86_64.rpm 
è­¦å‘Šï¼šerlang-23.3-2.el7.x86_64.rpm: å¤´V4 RSA/SHA1 Signature, å¯†é’¥ ID 6026dfca: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
	è½¯ä»¶åŒ… erlang-23.3-2.el7.x86_64 å·²ç»å®‰è£…
	
#yumå®‰è£…
[root@centos7 rabbitmq]# yum install -vy erlang-23.3-2.el7.x86_64
åŠ è½½ "fastestmirror" æ’ä»¶
åŠ è½½ "langpacks" æ’ä»¶
Adding zh_CN.UTF-8 to language list
Config time: 0.014
Yum version: 3.4.3
rpmdb time: 0.001
è®¾ç½®è½¯ä»¶åŒ…ç¾¤é›†
Loading mirror speeds from cached hostfile
 * base: mirrors.ustc.edu.cn
 * extras: mirrors.ustc.edu.cn
 * updates: mirrors.aliyun.com
base                                                                                                                                                                                      | 3.6 kB  00:00:00     
docker-ce-stable                                                                                                                                                                          | 3.5 kB  00:00:00     
extras                                                                                                                                                                                    | 2.9 kB  00:00:00     
updates                                                                                                                                                                                   | 2.9 kB  00:00:00     
updates/7/x86_64/primary_db                                                                                                                                                               | 6.5 MB  00:00:01     
pkgsack time: 4.825
æ£€æµ‹ erlang-23.3-2.el7.x86_64 æä¾›çš„ä¾èµ–æˆ–æ–‡ä»¶
æ— é¡»ä»»ä½•å¤„ç†

# æ£€æŸ¥å®‰è£…æˆåŠŸ
[root@centos7 rabbitmq]# erl -v
Erlang/OTP 23 [erts-11.2] [source] [64-bit] [smp:4:4] [ds:4:4:10] [async-threads:1] [hipe]

```

è¯´æ˜ï¼š

rpmå‘½ä»¤ï¼šhttps://www.linuxcool.com/rpm

yum å‘½ä»¤ï¼šhttps://www.linuxcool.com/yum



##### å®‰è£…socat

å®‰è£…RabbitMQè¿‡ç¨‹ä¸­è¦ä¾èµ–ä¸€ä¸ªæ’ä»¶`socat`ï¼Œæ‰€ä»¥å…ˆå®‰è£…socat

```shell
[root@centos7 rabbitmq]# yum install -y socat
å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.ustc.edu.cn
 * extras: mirrors.ustc.edu.cn
 * updates: mirrors.aliyun.com
æ­£åœ¨è§£å†³ä¾èµ–å…³ç³»
--> æ­£åœ¨æ£€æŸ¥äº‹åŠ¡
---> è½¯ä»¶åŒ… socat.x86_64.0.1.7.3.2-2.el7 å°†è¢« å®‰è£…
--> è§£å†³ä¾èµ–å…³ç³»å®Œæˆ

ä¾èµ–å…³ç³»è§£å†³

=================================================================================================================================================================================================================
 Package                                         æ¶æ„                                             ç‰ˆæœ¬                                                      æº                                              å¤§å°
=================================================================================================================================================================================================================
æ­£åœ¨å®‰è£…:
 socat                                           x86_64                                           1.7.3.2-2.el7                                             base                                           290 k

äº‹åŠ¡æ¦‚è¦
=================================================================================================================================================================================================================
å®‰è£…  1 è½¯ä»¶åŒ…

æ€»ä¸‹è½½é‡ï¼š290 k
å®‰è£…å¤§å°ï¼š1.1 M
Downloading packages:
socat-1.7.3.2-2.el7.x86_64.rpm                                                                                                                                                            | 290 kB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
è­¦å‘Šï¼šRPM æ•°æ®åº“å·²è¢«é yum ç¨‹åºä¿®æ”¹ã€‚
  æ­£åœ¨å®‰è£…    : socat-1.7.3.2-2.el7.x86_64                                                                                                                                                                   1/1 
  éªŒè¯ä¸­      : socat-1.7.3.2-2.el7.x86_64                                                                                                                                                                   1/1 

å·²å®‰è£…:
  socat.x86_64 0:1.7.3.2-2.el7                                                                                                                                                                                   

å®Œæ¯•ï¼
```



##### å®‰è£…RabbitMQ

è¿™é‡Œä½¿ç”¨æœ¬åœ°ä¸Šä¼ çš„å®‰è£…åŒ…å®‰è£…ï¼š

```shell
[root@centos7 rabbitmq]# rpm -Uvh rabbitmq-server-3.8.14-1.el7.noarch.rpm 
è­¦å‘Šï¼šrabbitmq-server-3.8.14-1.el7.noarch.rpm: å¤´V4 RSA/SHA256 Signature, å¯†é’¥ ID 6026dfca: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
æ­£åœ¨å‡çº§/å®‰è£…...
   1:rabbitmq-server-3.8.14-1.el7     ################################# [100%]

[root@centos7 rabbitmq]# yum install rabbitmq-server
å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.ustc.edu.cn
 * extras: mirrors.ustc.edu.cn
 * updates: mirrors.aliyun.com
æ— é¡»ä»»ä½•å¤„ç†

```



##### å¯åŠ¨æœåŠ¡

```shell
#å¯åŠ¨æœåŠ¡ï¼Œåœæ­¢ç”¨ï¼šsystemctl start rabbitmq-server
[root@centos7 rabbitmq]# systemctl start rabbitmq-server

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
[root@centos7 rabbitmq]# systemctl status rabbitmq-server
â— rabbitmq-server.service - RabbitMQ broker
   Loaded: loaded (/usr/lib/systemd/system/rabbitmq-server.service; disabled; vendor preset: disabled)
   Active: active (running) since æ—¥ 2021-03-28 23:24:25 CST; 29s ago
 Main PID: 11372 (beam.smp)
   Status: "Initialized"
    Tasks: 28
   Memory: 75.1M
   CGroup: /system.slice/rabbitmq-server.service
           â”œâ”€11372 /usr/lib64/erlang/erts-11.2/bin/beam.smp -W w -MBas ageffcbf -MHas ageffcbf -MBlmbcs 512 -MHlmbcs 512 -MMmcs 30 -P 1048576 -t 5000000 -stbt db -zdbbl 128000 -sbwt none -sbwtdcpu none -sbw...
           â”œâ”€11388 erl_child_setup 32768
           â”œâ”€11415 /usr/lib64/erlang/erts-11.2/bin/epmd -daemon
           â”œâ”€11440 inet_gethost 4
           â””â”€11486 inet_gethost 4

3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: ##########  Licensed under the MPL 2.0. Website: https://rabbitmq.com
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Doc guides: https://rabbitmq.com/documentation.html
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Support:    https://rabbitmq.com/contact.html
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Tutorials:  https://rabbitmq.com/getstarted.html
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Monitoring: https://rabbitmq.com/monitoring.html
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Logs: /var/log/rabbitmq/rabbit@centos7.log
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: /var/log/rabbitmq/rabbit@centos7_upgrade.log
3æœˆ 28 23:23:36 centos7.6 rabbitmq-server[11372]: Config file(s): (none)
3æœˆ 28 23:24:25 centos7.6 rabbitmq-server[11372]: Starting broker... completed with 0 plugins.
3æœˆ 28 23:24:25 centos7.6 systemd[1]: Started RabbitMQ broker.

#å¼€å¯å¯åŠ¨æœåŠ¡
[root@centos7 rabbitmq]# systemctl enable rabbitmq-server
Created symlink from /etc/systemd/system/multi-user.target.wants/rabbitmq-server.service to /usr/lib/systemd/system/rabbitmq-server.service.

```



### å­˜å‚¨

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617029338209.png" alt="1617029338209" style="zoom:80%;" />



### VHost

æ¯ä¸ªVhostå®Œå…¨ç‹¬ç«‹



### Channel

#### ä½•æ—¶åˆ›å»ºChannel

RabbitMQçš„æ¶ˆæ¯å­˜å‚¨åœ¨é˜Ÿåˆ—ä¸­ï¼Œäº¤æ¢å™¨çš„ä½¿ç”¨å¹¶ä¸çœŸæ­£è€—è´¹æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œè€Œé˜Ÿåˆ—ä¼šã€‚å¦‚æœè¦è¡¡é‡RabbitMQå½“å‰çš„QPSåªéœ€çœ‹é˜Ÿåˆ—çš„å³å¯ã€‚åœ¨å®é™…ä¸šåŠ¡åº”ç”¨ä¸­ï¼Œéœ€è¦å¯¹æ‰€åˆ›å»ºçš„é˜Ÿåˆ—çš„æµé‡ã€å†…å­˜å ç”¨åŠç½‘å¡å ç”¨æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤çŸ¥ï¼Œé¢„ä¼°å…¶å¹³å‡å€¼å’Œå³°å€¼ï¼Œä»¥ä¾¿åœ¨å›ºå®šç¡¬ä»¶èµ„æºçš„æƒ…å†µä¸‹èƒ½å¤Ÿè¿›è¡Œåˆç†æœ‰æ•ˆçš„åˆ†é…ã€‚

**æŒ‰ç…§RabbitMQå®˜æ–¹å»ºè®®ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½åº”è¯¥å°è¯•åˆ›å»ºï¼ˆè¿™é‡ŒæŒ‡å£°æ˜æ“ä½œï¼‰é˜Ÿåˆ—ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å»ºè®®ï¼Œä½†ä¸é€‚ç”¨äºæ‰€æœ‰çš„æƒ…å†µ**ã€‚

å¦‚æœä¸šåŠ¡æœ¬èº«åœ¨æ¶æ„è®¾è®¡ä¹‹åˆå·²ç»å……åˆ†åœ°é¢„ä¼°äº†é˜Ÿåˆ—çš„ä½¿ç”¨æƒ…å†µï¼Œå®Œå…¨å¯ä»¥åœ¨ä¸šåŠ¡ç¨‹åº**ä¸Šçº¿ä¹‹å‰åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¥½**ï¼ˆæ¯”å¦‚é€šè¿‡é¡µé¢ç®¡ç†ã€RabbitMQå‘½ä»¤æˆ–è€…æ›´å¥½çš„æ˜¯ä»é…ç½®ä¸­å¿ƒä¸‹å‘ï¼‰ï¼Œè¿™æ ·ä¸šåŠ¡ç¨‹åºä¹Ÿå¯ä»¥å…å»å£°æ˜çš„è¿‡ç¨‹ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚

**é¢„å…ˆåˆ›å»ºå¥½èµ„æºè¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥ç¡®ä¿äº¤æ¢å™¨å’Œé˜Ÿåˆ—ä¹‹é—´æ­£ç¡®åœ°ç»‘å®šåŒ¹é…ã€‚**å¾ˆå¤šæ—¶å€™ï¼Œç”±äºäººä¸ºå› ç´ ã€ä»£ç ç¼ºé™·ç­‰ï¼Œå‘é€æ¶ˆæ¯çš„äº¤æ¢å™¨å¹¶æ²¡æœ‰ç»‘å®šä»»ä½•é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†ä¼šä¸¢å¤±ï¼›æˆ–è€…äº¤æ¢å™¨ç»‘å®šäº†æŸä¸ªé˜Ÿåˆ—ï¼Œä½†æ˜¯å‘é€æ¶ˆæ¯æ—¶çš„è·¯ç”±é”®æ— æ³•ä¸ç°å­˜çš„é˜Ÿåˆ—åŒ¹é…ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¹Ÿä¼šä¸¢å¤±ã€‚å½“ç„¶å¯ä»¥é…åˆmandatoryå‚æ•°æˆ–è€…å¤‡ä»½äº¤æ¢å™¨ï¼ˆæ¥æé«˜ç¨‹åºçš„å¥å£®æ€§ã€‚

ä¸æ­¤åŒæ—¶ï¼Œé¢„ä¼°å¥½é˜Ÿåˆ—çš„ä½¿ç”¨æƒ…å†µéå¸¸é‡è¦ï¼Œå¦‚æœåœ¨åæœŸè¿è¡Œè¿‡ç¨‹ä¸­è¶…è¿‡é¢„å®šçš„é˜ˆå€¼ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µå¯¹å½“å‰é›†ç¾¤è¿›è¡Œæ‰©å®¹æˆ–è€…å°†ç›¸åº”çš„é˜Ÿåˆ—è¿ç§»åˆ°å…¶ä»–é›†ç¾¤ã€‚**è¿ç§»çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥å¯¹ä¸šåŠ¡ç¨‹åºå®Œå…¨é€æ˜**ã€‚æ­¤ç§æ–¹æ³•ä¹Ÿæ›´æœ‰åˆ©äºå¼€å‘å’Œè¿ç»´åˆ†å·¥ï¼Œä¾¿äºç›¸åº”èµ„æºçš„ç®¡ç†ã€‚

å¦‚æœé›†ç¾¤èµ„æºå……è¶³ï¼Œè€Œå³**å°†ä½¿ç”¨çš„é˜Ÿåˆ—æ‰€å ç”¨çš„èµ„æºåˆåœ¨å¯æ§çš„èŒƒå›´ä¹‹å†…**ï¼Œä¸ºäº†å¢åŠ ä¸šåŠ¡ç¨‹åºçš„çµæ´»æ€§ï¼Œä¹Ÿå®Œå…¨å¯ä»¥åœ¨ä¸šåŠ¡ç¨‹åºä¸­å£°æ˜é˜Ÿåˆ—ã€‚
è‡³äºæ˜¯ä½¿ç”¨é¢„å…ˆåˆ†é…åˆ›å»ºèµ„æºçš„é™æ€æ–¹å¼è¿˜æ˜¯åŠ¨æ€çš„åˆ›å»ºæ–¹å¼ï¼Œéœ€è¦ä»ä¸šåŠ¡é€»è¾‘æœ¬èº«ã€å…¬å¸è¿ç»´ä½“ç³»å’Œå…¬å¸ç¡¬ä»¶èµ„æºç­‰æ–¹é¢è€ƒè™‘ã€‚





### C#é©±åŠ¨RabbitMQ

- Nugetå¼•å…¥ç¨‹åºåŒ…RabbitMQ.Client
- å®šä¹‰ç”Ÿäº§è€…æ¶ˆè´¹è€…
- ç”Ÿäº§æ¶ˆæ¯ï¼Œå†™å…¥æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ¶ˆæ¯



### å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617032188313.png" alt="1617032188313" style="zoom:80%;" />



**ä¸€ä¸ªç”Ÿäº§è€…ä¸€ä¸ªæ¶ˆè´¹è€…ï¼›æ¶ˆæ¯åªæ˜¯è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼›**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617033903085.png" alt="1617033903085" style="zoom:50%;" />

å®˜æ–¹ç¤ºä¾‹ï¼šhttps://www.rabbitmq.com/tutorials/tutorial-one-dotnet.html





#### ç”Ÿäº§è€…

ä¸»è¦ä»£ç æ¸…å•ï¼š

é¡¹ç›®ï¼š`AspNetCore.RabbitMQ.MessageProducer`

æ–‡ä»¶ï¼š`MessageProducer/ProductionConsumer.cs`

```C#
 public class ProductionConsumer
    {
        public static void Show()
        {
            ConnectionFactory factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "guest";//ç”¨æˆ·å
            factory.Password = "guest";//å¯†ç  
            //factory.VirtualHost = "/Richard";
            using (IConnection connection = factory.CreateConnection())
            {  
                using (IModel channel = connection.CreateModel())
                {
                    channel.QueueDeclare(queue: "OnlyProducerMessage", durable: true, exclusive: false, autoDelete: false, arguments: null);


                    channel.ExchangeDeclare(exchange: "OnlyProducerMessageExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);

                    channel.QueueBind(queue: "OnlyProducerMessage", exchange: "OnlyProducerMessageExChange", routingKey: string.Empty, arguments: null);
                   

                    Console.ForegroundColor = ConsoleColor.Red;
                    Console.WriteLine("ç”Ÿäº§è€…ProducerDemoå·²å‡†å¤‡å°±ç»ª~~~");
                    int i = 1;
                    {
                        while (true)
                        {
                            IBasicProperties basicProperties = channel.CreateBasicProperties();
                            basicProperties.Persistent = true; 
                            //basicProperties.DeliveryMode = 2;
                            string message = $"æ¶ˆæ¯{i}";
                            byte[] body = Encoding.UTF8.GetBytes(message);
                            channel.BasicPublish(exchange: "OnlyProducerMessageExChange",
                                            routingKey: string.Empty,
                                            basicProperties: basicProperties,
                                            body: body);
                            Console.WriteLine($"æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯æ¶ˆæ¯ï¼š{message} å·²å‘é€~");
                            i++;
                            //Thread.Sleep(10);
                        }
                    }
                }
            }
        }
    }
```



#### æ¶ˆè´¹è€…

```C#
    class ProductionConsumer
    {
        public static void Show()
        { 
            var factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "guest";//ç”¨æˆ·å
            factory.Password = "guest";//å¯†ç  
            using (var connection = factory.CreateConnection())
            {
                using (var channel = connection.CreateModel())
                {
                    {
                        {


                            Console.ForegroundColor = ConsoleColor.Green;
                            try
                            {
                                channel.QueueDeclare(queue: "OnlyProducerMessage", durable: true, exclusive: false, autoDelete: false, arguments: null);
                                channel.ExchangeDeclare(exchange: "OnlyProducerMessageExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);
                                channel.QueueBind(queue: "OnlyProducerMessage", exchange: "OnlyProducerMessageExChange", routingKey: string.Empty, arguments: null);

                                var consumer = new EventingBasicConsumer(channel);
                                consumer.Received += (model, ea) =>
                                {
                                    var body = ea.Body;
                                    var message = Encoding.UTF8.GetString(body.ToArray());
                                    Console.WriteLine($"æ¶ˆè´¹è€…01 æ¥å—æ¶ˆæ¯: {message}");
                                };
                                channel.BasicConsume(queue: "OnlyProducerMessage",
                                             autoAck: true,
                                             consumer: consumer);
                                Console.WriteLine(" Press [enter] to exit.");
                                Console.ReadLine();
                            }
                            catch (Exception ex)
                            {
                                Console.WriteLine(ex.Message);
                            }
                        }

                    }
                }
            } 
        }
    }
```



### å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617163158300.png" alt="1617163158300" style="zoom:80%;" />





### äº’ä¸ºç”Ÿäº§æ¶ˆè´¹è€…

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617163202465.png" alt="1617163202465" style="zoom:80%;" />





### ä¼˜å…ˆçº§é˜Ÿåˆ—

ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œé¡¾åæ€ä¹‰ï¼Œå…·æœ‰é«˜ä¼˜å…ˆçº§çš„é˜Ÿåˆ—å…·æœ‰é«˜çš„ä¼˜å…ˆæƒï¼Œä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯å…·å¤‡ä¼˜å…ˆè¢«æ¶ˆè´¹çš„ç‰¹æƒã€‚

é»˜è®¤æœ€ä½ä¸º0ï¼Œæœ€é«˜ä¸ºé˜Ÿåˆ—è®¾ç½®çš„æœ€å¤§ä¼˜å…ˆçº§ã€‚ä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯å¯ä»¥è¢«ä¼˜å…ˆæ¶ˆè´¹ï¼Œ

å¯ä»¥é€šè¿‡è®¾ç½®é˜Ÿåˆ—çš„x-max-priorityå‚æ•°æ¥å®ç°ã€‚

ç¬¬ä¸€æ­¥ï¼šè®¾ç½®é˜Ÿåˆ—çš„æœ€å¤§ä¼˜å…ˆçº§

```C#
channel.QueueDeclare(queue: "PriorityQueue", durable: true, exclusive: false, autoDelete: false, 
                     arguments: new Dictionary<string, object>() {
                         {"x-max-priority",10 } 
                     });
```

ç¬¬äºŒæ­¥ï¼šè®¾ç½®æ¶ˆæ¯çš„ä¼˜å…ˆçº§

```C#
IBasicProperties props = channel.CreateBasicProperties();
props.DeliveryMode = 2; //æ¶ˆæ¯æŒä¹…åŒ–
props.Priority = 1;
string strMessage = $"æ¶ˆæ¯ï¼š{i}";
channel.BasicPublish(exchange: "PriorityQueueExchange",
                     routingKey: "PriorityKey",
                     basicProperties: props,
                     body: Encoding.UTF8.GetBytes(strMessage));
```



è¿™ä¸ªä¹Ÿæ˜¯æœ‰å‰æçš„ï¼šå¦‚æœåœ¨æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦å¤§äºç”Ÿäº§è€…çš„é€Ÿåº¦ä¸”Brokerä¸­æ²¡æœ‰æ¶ˆæ¯å †ç§¯çš„æƒ…å†µä¸‹ï¼Œå¯¹å‘é€çš„æ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ã€‚å› ä¸ºç”Ÿäº§è€…åˆšå‘é€å®Œä¸€æ¡æ¶ˆæ¯å°±è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºBrokerä¸­è‡³å¤šåªæœ‰ä¸€æ¡æ¶ˆæ¯ï¼Œå¯¹äºå•æ¡æ¶ˆæ¯æ¥è¯´ä¼˜å…ˆçº§æ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ã€‚



**ç¤ºä¾‹**ï¼š



**ç”Ÿäº§è€…**

```C#
            ConnectionFactory factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "guest";//ç”¨æˆ·å
            factory.Password = "guest";//å¯†ç  
            using (IConnection connection = factory.CreateConnection())
            {
                using (IModel channel = connection.CreateModel())
                {
                    //æŒ‡å®šé˜Ÿåˆ—è¦æ”¯æŒä¼˜å…ˆçº§è®¾ç½®ï¼Œå…¶æœ€åä¼˜å…ˆçº§ä¸º10ï¼›
                    channel.QueueDeclare(queue: "PriorityQueue", durable: true, exclusive: false, autoDelete: false, 
                        arguments: new Dictionary<string, object>() {
                         {"x-max-priority",10 } 
                       });

                    //å£°æ˜äº¤æ¢æœºexchang
                    channel.ExchangeDeclare(exchange: "PriorityQueueExchange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);
                    //ç»‘å®šexchangeå’Œqueue
                    channel.QueueBind(queue: "PriorityQueue", exchange: "PriorityQueueExchange", routingKey: "PriorityKey");
                   
                    //ä¸€äº›å¾…å‘é€çš„æ¶ˆæ¯
                    {
                        IBasicProperties props = channel.CreateBasicProperties();
                        props.DeliveryMode = 2; //æ¶ˆæ¯æŒä¹…åŒ–
                        for (int i = 1; i <= 5; i++)
                        {
                            props.Priority = 1;
                            string strMessage = $"æ¶ˆæ¯ï¼š{i }";
                            channel.BasicPublish(exchange: "PriorityQueueExchange",
                                           routingKey: "PriorityKey",
                                           basicProperties: props,
                                           body: Encoding.UTF8.GetBytes(strMessage));
                            Console.WriteLine($"{strMessage} å·²å‘é€ã€‚ã€‚ã€‚ã€‚");
                            
                        }
                    }
```

**ç”Ÿäº§è€…æŠŠæ¶ˆæ¯çš„ä¼˜å…ˆçº§éƒ½è®¾ç½®ä¸ºï¼š1  ï¼Œä¸€ä¸ªå‘äº†5æ¡æ¶ˆæ¯**



**æ¶ˆè´¹è€…**

```C#
var factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "guest";//ç”¨æˆ·å
            factory.Password = "guest";//å¯†ç  
            using (var connection = factory.CreateConnection())
            {
                using (IModel channel = connection.CreateModel())
                {
                    #region EventingBasicConsumer
                    //å®šä¹‰æ¶ˆè´¹è€…                                      
                    var consumer = new EventingBasicConsumer(channel);
                    consumer.Received += (model, ea) =>
                    {
                        string msg = Encoding.UTF8.GetString(ea.Body.ToArray());
                        Console.WriteLine(msg);
                        if (msg.Equals("æ¶ˆæ¯ï¼š1"))
                        {
                            //æ‹’ç» æ¶ˆæ¯ï¼š1
                            channel.BasicReject(deliveryTag: ea.DeliveryTag, requeue: false); 

                            ///è®¾ç½®æ¶ˆæ¯ä¼˜å…ˆçº§æœ€é«˜ é‡æ–°å†™å…¥åˆ°é˜Ÿåˆ—ä¸­å»
                            IBasicProperties props = channel.CreateBasicProperties(); 
                            props.Priority = 10;
                            channel.BasicPublish(exchange: "PriorityQueueExchange",
                                           routingKey: "PriorityKey",
                                           basicProperties: props,
                                           body: Encoding.UTF8.GetBytes("æ¶ˆæ¯ï¼š2->ä¼˜å…ˆçº§è¢«è°ƒæ•´ä¸º10åé‡å‘"));

                        }
                    };
                    Console.WriteLine("æ¶ˆè´¹è€…å‡†å¤‡å°±ç»ª....");
                    //å¤„ç†æ¶ˆæ¯
                    channel.BasicConsume(queue: "PriorityQueue", autoAck: false, consumer: consumer);
                    Console.ReadKey();
                    #endregion
                }
            }
```

å¦‚æœæ”¶åˆ°çš„æ¶ˆæ¯æ˜¯**æ¶ˆæ¯ ï¼š1**ï¼Œ 

- æ‹’ç»æ¥æ”¶
- æå‡ä¼˜å…ˆçº§ä¸ºï¼š10
- é‡æ–°æ”¾å…¥ äº¤æ¢æœº

```c#
                        if (msg.Equals(æ¶ˆæ¯ï¼š2"))
                        {
                            //æ‹’ç» æ¶ˆæ¯ï¼š2
                            channel.BasicReject(deliveryTag: ea.DeliveryTag, requeue: false); 

                            ///è®¾ç½®æ¶ˆæ¯ä¼˜å…ˆçº§æœ€é«˜ é‡æ–°å†™å…¥åˆ°é˜Ÿåˆ—ä¸­å»
                            IBasicProperties props = channel.CreateBasicProperties(); 
                            props.Priority = 10; 
                            channel.BasicPublish(exchange: "PriorityQueueExchange",
                                           routingKey: "PriorityKey",
                                           basicProperties: props,
                                           body: Encoding.UTF8.GetBytes(msg));

                        }
```

ç”±äºæ”¶åˆ°åˆ° **æ¶ˆæ¯ï¼š2**ï¼Œ è®¾ç½®äº†ä¼˜å…ˆçº§ï¼Œ



> åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­, é¢å¤–æ³¨æ„ï¼š
>
> å­˜åœ¨è®¾ç½®äº†ä¼˜å…ˆçº§æ¶ˆæ¯çš„é˜Ÿåˆ—æœ‰ä¸€ä¸ªæ ‡è¯†`Pri`
>
> <img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617192427325.png" alt="1617192427325" style="zoom:80%;" />



##### ä¼˜å…ˆçº§çš„æœ‰å‰æ

è¿™ä¸ªä¹Ÿæ˜¯æœ‰å‰æçš„ï¼šå¦‚æœåœ¨æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦å¤§äºç”Ÿäº§è€…çš„é€Ÿåº¦ä¸”Brokerä¸­æ²¡æœ‰æ¶ˆæ¯å †ç§¯çš„æƒ…å†µä¸‹ï¼Œå¯¹å‘é€çš„æ¶ˆæ¯è®¾ç½®ä¼˜å…ˆçº§ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ã€‚å› ä¸ºç”Ÿäº§è€…åˆšå‘é€å®Œä¸€æ¡æ¶ˆæ¯å°±è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºBrokerä¸­è‡³å¤šåªæœ‰ä¸€æ¡æ¶ˆæ¯ï¼Œå¯¹äºå•æ¡æ¶ˆæ¯æ¥è¯´ä¼˜å…ˆçº§æ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ã€‚**å¦‚ä¸‹æ‰€ç¤ºï¼Œå½“åªæœ‰5æ¡æ¶ˆæ¯ï¼ˆæ¶ˆæ¯å¾ˆå°‘ï¼‰æ—¶ï¼Œè®¾ç½®ä¼˜å…ˆçº§æ— æ„ä¹‰ ã€‚**

```powershell
æ¶ˆè´¹è€…å‡†å¤‡å°±ç»ª....
æ¶ˆæ¯ï¼š1
æ¶ˆæ¯ï¼š2
æ¶ˆæ¯ï¼š3
æ¶ˆæ¯ï¼š4
æ¶ˆæ¯ï¼š5
æ¶ˆæ¯ï¼š->ä¼˜å…ˆçº§è¢«è°ƒæ•´ä¸º10åé‡å‘
```

è¦è®©è¿™ä¸ªç¤ºä¾‹æœ‰æ„ä¹‰ï¼Œå¾—ï¼š

åœ¨åŠ¨æ€çš„ç”Ÿæˆæ¶ˆæ¯ä¸­å»æ’é˜Ÿ,æ•…ä½¿ç”¨whileå¾ªç¯ï¼Œè€Œä¸èƒ½ä½¿ç”¨for(å› ä¸ºé¢„å…ˆå°±è®¾ç½®å¥½äº†é˜Ÿåˆ—é¡ºåº),

```C#
while (true)
    //å½“å‘é€çš„æ¶ˆæ¯å¾ˆå°‘ï¼ˆæ¯”å¦‚ï¼š5ï¼‰æ—¶ï¼Œè®¾ç½®ä¼˜å…ˆçº§æ— æ„ä¹‰ ã€‚
    //åŠ¨æ€çš„ç”Ÿæˆæ¶ˆæ¯ä¸­å»æ’é˜Ÿ,æ•…ä½¿ç”¨whileå¾ªç¯ï¼Œè€Œä¸èƒ½ä½¿ç”¨for(å› ä¸ºé¢„å…ˆå°±è®¾ç½®å¥½äº†é˜Ÿåˆ—é¡ºåº)
    //for (int i = 1; i <= 100; i++)
{
    props.Priority = 1;
    string strMessage = $"æ¶ˆæ¯ï¼š{i}";
    channel.BasicPublish(exchange: "PriorityQueueExchange",
                         routingKey: "PriorityKey",
                         basicProperties: props,
                         body: Encoding.UTF8.GetBytes(strMessage));
    Console.WriteLine($"{strMessage} å·²å‘é€ã€‚ã€‚ã€‚ã€‚");
    i++;
}
```

è¿™æ—¶æ¶ˆè´¹è€…ç«¯çš„è¾“å‡ºï¼š

```shell
æ¶ˆè´¹è€…å‡†å¤‡å°±ç»ª....
æ¶ˆæ¯ï¼š1
æ¶ˆæ¯ï¼š2
æ¶ˆæ¯ï¼š3

......

æ¶ˆæ¯ï¼š941
æ¶ˆæ¯ï¼š->ä¼˜å…ˆçº§è¢«è°ƒæ•´ä¸º10åé‡å‘

......
```



### äº¤æ¢æœº

**ä»»ä½•æ¶ˆæ¯éƒ½å…ˆè¦ç»è¿‡äº¤æ¢æœº**ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ

é€šè¿‡äº¤æ¢æœºï¼Œè®¾ç½®ä¸€äº›é˜Ÿåˆ—çš„ç­–ç•¥ï¼Œæ¯”å¦‚ï¼šè½¬å‘ç­–ç•¥





### äº¤æ¢æœºç±»å‹

RabbitMQå¸¸ç”¨çš„äº¤æ¢å™¨ç±»å‹æœ‰fanoutã€directã€topicã€headersè¿™å››ç§ã€‚AMQPåè®®é‡Œè¿˜æåˆ°å¦å¤–ä¸¤ç§ç±»å‹ï¼šSystemå’Œè‡ªå®šä¹‰ï¼Œè¿™é‡Œä¸äºˆæè¿°ã€‚å¯¹äºè¿™å››ç§ç±»å‹ä¸‹é¢ä¸€ä¸€é˜è¿°ã€‚

> äº¤æ¢æœºåˆ†å‘ç»™å¤šä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯å¤åˆ¶æ“ä½œï¼Œè€Œä¸æ˜¯è¿™ä¸ªæ¶ˆæ¯ç»™äº†Aé˜Ÿåˆ—ï¼Œå°±ä¸ç»™Bé˜Ÿåˆ—ã€‚
>
> é˜Ÿåˆ—ç»™æ¶ˆè´¹è€…çš„æ¶ˆæ¯æ‰æ˜¯å•ä¸€æ€§ï¼Œä¸€ä¸ªæ¶ˆæ¯åªèƒ½ç»™ä¸€ä¸ªæ¶ˆè´¹è€…





#### fanoutï¼ˆå¹¿æ’­ï¼‰

**å®ƒä¼šæŠŠæ‰€æœ‰å‘é€åˆ°è¯¥äº¤æ¢å™¨çš„æ¶ˆæ¯è·¯ç”±åˆ°æ‰€æœ‰ä¸è¯¥äº¤æ¢å™¨ç»‘å®šçš„é˜Ÿåˆ—ä¸­ã€‚**



```C#
var factory = new ConnectionFactory();
factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
factory.UserName = "guest";//ç”¨æˆ·å
factory.Password = "guest";//å¯†ç  
using (var connection = factory.CreateConnection())
{
    using (IModel channel = connection.CreateModel())
    {
        channel.QueueDeclare(queue: "PublishSubscrib01", durable: true, exclusive: false, autoDelete: false, arguments: null);
        channel.QueueDeclare(queue: "PublishSubscrib02", durable: true, exclusive: false, autoDelete: false, arguments: null);
        channel.ExchangeDeclare(exchange: "PublishSubscribExChange", type: ExchangeType.Fanout, durable: true, autoDelete: false, arguments: null);
        channel.QueueBind(queue: "PublishSubscrib01", exchange: "PublishSubscribExChange", routingKey: string.Empty, arguments: null);
        channel.QueueBind(queue: "PublishSubscrib02", exchange: "PublishSubscribExChange", routingKey: string.Empty, arguments: null);
        Console.ForegroundColor = ConsoleColor.Red;
        Console.WriteLine("å¼€å§‹å‘å¸ƒæ¶ˆæ¯~~~~"); 

        for (int i = 1; i <= 2000; i++)
        { 
            string message = $"å¹¿æ’­ç¬¬{i}æ¡æ¶ˆæ¯...";
            byte[] body = Encoding.UTF8.GetBytes(message);
            channel.BasicPublish(exchange: "PublishSubscribExChange",
                                 routingKey: string.Empty,
                                 basicProperties: null,
                                 body: body); 
            Console.WriteLine(message);
            Thread.Sleep(200);
        }
    }
}
```

ä»£ç è§£æï¼š

å®šä¹‰äº¤æ¢æœºçš„ç±»å‹ä¸º **fanout**

```C#
 channel.ExchangeDeclare(exchange: "PublishSubscribExChange", type: ExchangeType.Fanout, durable: true, autoDelete: false, arguments: null);
```

**fanout**ç±»å‹äº¤æ¢æœºçš„ç±»å‹ç»‘å®šä¸¤ä¸ªé˜Ÿåˆ—ï¼š

```c#
channel.QueueBind(queue: "PublishSubscrib01", exchange: "PublishSubscribExChange", routingKey: string.Empty, arguments: null);

channel.QueueBind(queue: "PublishSubscrib02", exchange: "PublishSubscribExChange", routingKey: string.Empty, arguments: null);
```



ç»“æœæ˜¯ï¼š

`Fanout`lç±»å‹çš„äº¤æ¢æœº`PublishSubscribExChange`å‘é€**2000ä¸ªæ¶ˆæ¯**ï¼Œä¸å…¶ç»‘å®š çš„ä¸¤ä¸ªé˜Ÿåˆ—`PublishSubscrib01` å’Œ`PublishSubscrib02`**éƒ½æœ‰2000æ¡æ¶ˆæ¯**ã€‚è€Œä¸æ˜¯å¹³åˆ†



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617178224408.png" alt="1617178224408" style="zoom:80%;" />

æ¶ˆè´¹è€…ï¼š

```C#
var factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "Richard02";//ç”¨æˆ·å
            factory.Password = "123456";//å¯†ç  
            using (var connection = factory.CreateConnection())
            {
                using (var channel = connection.CreateModel())
                { 
                    Console.ForegroundColor = ConsoleColor.Green;

                    Console.WriteLine("è®¢é˜…è€…01 å·²ç»å‡†å¤‡å°±ç»ª~~");
                    try
                    {
                        var body = ea.Body;
                        var message = Encoding.UTF8.GetString(body.ToArray());
                                Console.WriteLine($"è®¢é˜…è€…01ä»é˜Ÿåˆ—ã€PublishSubscrib01ã€‘æ”¶åˆ°æ¶ˆæ¯:{message} ~");  
                        };
                        //åªä»é˜Ÿåˆ—ã€PublishSubscrib01ã€‘è·å–æ¶ˆæ¯
                        channel.BasicConsume(queue: "PublishSubscrib01", autoAck: true, consumer: consumer); 
                        Console.ReadLine();
                        Console.ReadLine();
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine(ex.Message);
                    } 
                }
            }
```

**æ¶ˆè´¹è€…01åªä»é˜Ÿåˆ—ã€PublishSubscrib01ã€‘è·å–æ¶ˆæ¯**



##### Fanout äº¤æ¢æœºåº”ç”¨åœºæ™¯

è§‚å¯Ÿè€…æ¨¡å¼

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617238854372.png" alt="1617238854372" style="zoom:80%;" />



#### direct ï¼ˆç›´æ¥ï¼‰

directç±»å‹çš„äº¤æ¢å™¨è·¯ç”±è§„åˆ™ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°é‚£äº›BindingKeyå’ŒRoutingKey**å®Œå…¨åŒ¹é…**çš„é˜Ÿåˆ—ä¸­ã€‚

ç›´æ¥äº¤æ¢å™¨ï¼Œå·¥ä½œæ–¹å¼ç±»ä¼¼äºå•æ’­ï¼ŒExchangeä¼šå°†æ¶ˆæ¯å‘é€å®Œå…¨åŒ¹é…ROUTING_KEYçš„Queue

**DirectExchange æ›´åƒä»è·¯ç”±æ–¹æ¥ç­›é€‰æ¶ˆæ¯ï¼›**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617201423513.png" alt="1617201423513" style="zoom:80%;" />

ç¤ºä¾‹ï¼š

ç”Ÿäº§è€…

```C#
 public class DirectExchange
    {
        public static void Show()
        {
            var factory = new ConnectionFactory();
            factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.UserName = "guest";//ç”¨æˆ·å
            factory.Password = "guest";//å¯†ç  
            using (var connection = factory.CreateConnection())
            {
                using (IModel channel = connection.CreateModel())
                {
                    channel.QueueDeclare(queue: "DirectExchangeLogAllQueue", durable: true, exclusive: false, autoDelete: false, arguments: null); 
                    channel.QueueDeclare(queue: "DirectExchangeErrorQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);
                    channel.ExchangeDeclare(exchange: "DirectExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);

                    string[] logtypes = new string[] { "debug", "info", "warn", "error" };

                    foreach (string logtype in logtypes)
                    {
                        channel.QueueBind(queue: "DirectExchangeLogAllQueue",
                                exchange: "DirectExChange",
                                routingKey: logtype);
                    } 

                    channel.QueueBind(queue: "DirectExchangeErrorQueue",
                              exchange: "DirectExChange",
                              routingKey: "error");

                    List<LogMsgModel> logList = new List<LogMsgModel>();
                    for (int i = 1; i <=100; i++)
                    {
                        if (i % 4 == 0)
                        {
                            logList.Add(new LogMsgModel() { LogType = "info", Msg = Encoding.UTF8.GetBytes($"infoç¬¬{i}æ¡ä¿¡æ¯") });
                        }
                        if (i % 4 == 1)
                        {
                            logList.Add(new LogMsgModel() { LogType = "debug", Msg = Encoding.UTF8.GetBytes($"debugç¬¬{i}æ¡ä¿¡æ¯") });
                        }
                        if (i % 4 == 2)
                        {
                            logList.Add(new LogMsgModel() { LogType = "warn", Msg = Encoding.UTF8.GetBytes($"warnç¬¬{i}æ¡ä¿¡æ¯") });
                        }
                        if (i % 4 == 3)
                        {
                            logList.Add(new LogMsgModel() { LogType = "error", Msg = Encoding.UTF8.GetBytes($"errorç¬¬{i}æ¡ä¿¡æ¯") });
                        }
                    }
                     
                    Console.WriteLine("ç”Ÿäº§è€…å‘é€100æ¡æ—¥å¿—ä¿¡æ¯");
                    //å‘é€æ—¥å¿—ä¿¡æ¯
                    foreach (var log in logList)
                    {
                        channel.BasicPublish(exchange: "DirectExChange",
                                            routingKey: log.LogType,
                                            basicProperties: null,
                                            body: log.Msg);
                        Console.WriteLine($"{Encoding.UTF8.GetString(log.Msg)}  å·²å‘é€~~");
                    }
                     
                }
            }
        }


        public class LogMsgModel
        {
            public string LogType { get; set; }

            public byte[] Msg { get; set; }
        }
    }
```

æ ¸å¿ƒä»£ç è§£æï¼š

```C#

//å­˜æ”¾æ‰€æœ‰ç±»å‹çš„æ¶ˆæ¯ï¼ˆæ—¥å¿—ï¼‰
channel.QueueDeclare(queue: "DirectExchangeLogAllQueue", durable: true, exclusive: false, autoDelete: false, arguments: null); 
//å­˜æ”¾ Error ç±»å‹æ—¥å¿—
channel.QueueDeclare(queue: "DirectExchangeErrorQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);
//ä½¿ç”¨ Direct ç±»å‹äº¤æ¢æœº
channel.ExchangeDeclare(exchange: "DirectExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);

string[] logtypes = new string[] { "debug", "info", "warn", "error" };

// ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç»‘å®šå¤šä¸ªrouterkey
foreach (string logtype in logtypes)
{
    channel.QueueBind(queue: "DirectExchangeLogAllQueue",
                      exchange: "DirectExChange",
                      routingKey: logtype);
}

// è¯¥é˜Ÿåˆ—ä»…ä»…ç»‘å®š routingKey = error
channel.QueueBind(queue: "DirectExchangeErrorQueue",
                  exchange: "DirectExChange",
                  routingKey: "error");
```

è¿è¡Œåï¼š

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617202454719.png" alt="1617202454719" style="zoom:80%;" />



**Error æ—¥å¿—æ¶ˆè´¹è€…**ï¼š

```C#
channel.QueueDeclare(queue: "DirectExchangeErrorQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);  

channel.ExchangeDeclare(exchange: "DirectExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);
// ç»‘å®š error ç±»å‹é˜Ÿåˆ—ï¼Œå¹¶æŒ‡å®š routingKey=error
channel.QueueBind(queue: "DirectExchangeErrorQueue",
                  exchange: "DirectExChange",
                  routingKey: "error");

//æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼›                                   
var consumer = new EventingBasicConsumer(channel);
consumer.Received += (model, ea) =>
{
    var body = ea.Body;
    var message = Encoding.UTF8.GetString(body.ToArray());
    Console.WriteLine($"ã€{message}ã€‘ï¼Œå·²å‘é€é‚®ä»¶é€šçŸ¥ç³»ç»Ÿç®¡ç†å‘˜~~");
};
//å¤„ç†æ¶ˆæ¯
channel.BasicConsume(queue: "DirectExchangeErrorQueue",
                     autoAck: true,
                     consumer: consumer);
Console.ReadLine(); 
```

> ç»‘å®š é˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¹Ÿå¿…é¡»æŒ‡æ˜ **routerkey** , å› ä¸º ä¸€ä¸ªé˜Ÿåˆ—å¯èƒ½ ç»‘å®šäº†å¤šä¸ª**routerkey**



**å¤šrouterkeyçš„é˜Ÿåˆ—ä¸­è·å–æŸä¸ªrouterkeyçš„ä¿¡æ¯**

> è¿™ä¸ªåšæ˜¯ä¸è¡Œçš„ï¼Œå®é™…è¯æ˜ï¼š
>
> **é˜Ÿåˆ—ç»‘å®šè¿‡çš„routerkeyï¼Œå³ä½¿æ˜¯åœ¨æ¶ˆè´¹è€…ç«¯é‡æ–°å®šä¹‰äº†ç»‘å®šçš„routerkey, ä¸ä¼šæ”¹å˜ç”Ÿäº§è€…ç«¯ç»‘å®šçš„routerkeyã€‚**



ç”Ÿäº§è€…ä¸€è¾¹å®šä¹‰çš„é˜Ÿåˆ—**DirectExchangeLogAllQueue**ç»‘å®šæ˜¯4ä¸ªrouterkeyï¼š

```C#
string[] logtypes = new string[] { "debug", "info", "warn", "error" };

// ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç»‘å®šå¤šä¸ªrouterkey
foreach (string logtype in logtypes)
{
    channel.QueueBind(queue: "DirectExchangeLogAllQueue",
                      exchange: "DirectExChange",
                      routingKey: logtype);
}
```

ç„¶ååœ¨æ¶ˆè´¹è€…ç«¯é‡æ–°è¿›è¡Œç»‘å®šï¼š

```C#
var factory = new ConnectionFactory();
factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
factory.UserName = "guest";//ç”¨æˆ·å
factory.Password = "guest";//å¯†ç  
using (var connection = factory.CreateConnection())
{
    using (IModel channel = connection.CreateModel())
    {
        channel.QueueDeclare(queue: "DirectExchangeLogAllQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);   
        channel.ExchangeDeclare(exchange: "DirectExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null); 
        string[] logtypes = new string[] { "debug", "info", "warn", "error" };
        //foreach (string logtype in logtypes)
        //{
        //    channel.QueueBind(queue: "DirectExchangeLogAllQueue",
        //            exchange: "DirectExChange",
        //            routingKey: logtype);
        //}

        channel.QueueBind(queue: "DirectExchangeLogAllQueue",
                          exchange: "DirectExChange",
                          routingKey: "error");


        //æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼›                                   
        var consumer = new EventingBasicConsumer(channel); 
        consumer.Received += (model, ea) =>
        {
            var body = ea.Body;
            var message = Encoding.UTF8.GetString(body.ToArray()); 
            Console.WriteLine($"ã€{message}ã€‘ï¼Œå†™å…¥æ–‡æœ¬~~");
        }; 
        //å¤„ç†æ¶ˆæ¯
        channel.BasicConsume(queue: "DirectExchangeLogAllQueue",
                             autoAck: true,
                             consumer: consumer); 
        Console.ReadLine(); 
    }
}
```

ç»“æœæ˜¯ï¼š

**æ‰€æœ‰ç±»å‹çš„æ—¥å¿—éƒ½è¢«æ¶ˆè´¹äº†ã€‚å³ä½¿æ˜¯åœ¨æ¶ˆè´¹è€…ç«¯é‡æ–°å®šä¹‰äº†ç»‘å®šçš„routerkey, ä¸ä¼šæ”¹å˜ç”Ÿäº§è€…ç«¯ç»‘å®šçš„routerkeyã€‚**



æŸ¥çœ‹`DirectExchangeLogAllQueue`ç»‘å®šçš„`routerkey`è¿˜æ˜¯ **"debug", "info", "warn", "error"** ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617203690087.png" alt="1617203690087" style="zoom:80%;" />

æ•…ï¼Œæ¶ˆè´¹è€…ç«¯å¹¶ä¸éœ€è¦é‡æ–°å®šä¹‰ é˜Ÿåˆ—ï¼Œäº¤æ¢æœºåŠå…¶ä¸¤ç§ä¹‹é—´çš„ç»‘å®šï¼Œè¿›è€Œæ¶ˆè´¹è€…ç«¯çš„ä»£ç å¯ç®€åŒ–ä¸º:

```C#
var factory = new ConnectionFactory();
factory.HostName = "localhost";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
factory.UserName = "guest";//ç”¨æˆ·å
factory.Password = "guest";//å¯†ç  
using (var connection = factory.CreateConnection())
{
    using (IModel channel = connection.CreateModel())
    {
        //æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼›                                   
        var consumer = new EventingBasicConsumer(channel); 
        consumer.Received += (model, ea) =>
        {
            var body = ea.Body;
            var message = Encoding.UTF8.GetString(body.ToArray()); 
            Console.WriteLine($"ã€{message}ã€‘ï¼Œå†™å…¥æ–‡æœ¬~~");
        }; 
        //å¤„ç†æ¶ˆæ¯
        channel.BasicConsume(queue: "DirectExchangeLogAllQueue",
                             autoAck: true,
                             consumer: consumer); 
        Console.ReadLine(); 
    }
}
        
```



##### Direrct äº¤æ¢æœºåº”ç”¨åœºæ™¯

å¯ä»¥å®šä¹‰ä¸¤ä¸ªé˜Ÿåˆ—
é˜Ÿåˆ—1ï¼šä¸“é—¨ç”¨æ¥è®°å½•æ—¥å¿—
é˜Ÿåˆ—2ï¼šä¸“é—¨ç”¨æ¥å‘é‚®ä»¶ï¼Œå‘ä¿¡æ¯



#### topic

å‰é¢è®²åˆ°directç±»å‹çš„äº¤æ¢å™¨è·¯ç”±è§„åˆ™æ˜¯å®Œå…¨åŒ¹é…BindingKeyå’ŒRoutingKeyï¼Œä½†æ˜¯è¿™ç§ä¸¥æ ¼çš„åŒ¹é…æ–¹å¼åœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¸èƒ½æ»¡è¶³å®é™…ä¸šåŠ¡çš„éœ€æ±‚ã€‚

topicç±»å‹çš„äº¤æ¢å™¨åœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸directç±»å‹çš„äº¤æ¢å™¨ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°BindingKeyå’ŒRoutingKeyç›¸åŒ¹é…çš„é˜Ÿåˆ—ä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®šï¼š
RoutingKeyä¸ºä¸€ä¸ªç‚¹å·â€œ.â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆè¢«ç‚¹å·â€œ.â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯ï¼‰ï¼Œå¦‚â€œcom.rabbitmq.clientâ€ã€â€œjava.util.concurrentâ€ã€â€œcom.hidden.clientâ€ï¼›
BindingKeyå’ŒRoutingKeyä¸€æ ·ä¹Ÿæ˜¯ç‚¹å·â€œ.â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼›
BindingKeyä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ä¸²â€œ*â€å’Œâ€œï¼ƒâ€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€œï¼ƒâ€ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œâ€œï¼ƒâ€ç”¨äºåŒ¹é…å¤šè§„æ ¼å•è¯ï¼ˆå¯ä»¥æ˜¯é›¶ä¸ªï¼‰ã€‚

> æ€»è§‰å¾—ä¸€å¥è¯ï¼štopicäº¤æ¢æœºå’Œé˜Ÿåˆ—çš„ç»‘å®šé…è§„åˆ™å°±æ˜¯ **æ¨¡ç³ŠåŒ¹é…** 



**è·¯ç”±é”®å’Œç»‘å®šé”®**

**åœ¨topicäº¤æ¢å™¨ç±»å‹ä¸‹ï¼ŒRoutingKeyå’ŒBindingKeyä¹‹é—´éœ€è¦åšæ¨¡ç³ŠåŒ¹é…ï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›¸åŒçš„ã€‚**

BindingKeyå…¶å®ä¹Ÿå±äºè·¯ç”±é”®ä¸­çš„ä¸€ç§ï¼Œå®˜æ–¹è§£é‡Šä¸ºï¼šthe routing key to use for the bindingã€‚å¯ä»¥ç¿»è¯‘ä¸ºï¼šåœ¨

**ç»‘å®šçš„æ—¶å€™ä½¿ç”¨çš„è·¯ç”±**é”®ã€‚å¤§å¤šæ•°æ—¶å€™ï¼ŒåŒ…æ‹¬å®˜æ–¹æ–‡æ¡£å’ŒRabbitMQ Java APIä¸­éƒ½æŠŠBindingKeyå’ŒRoutingKeyçœ‹ä½œRoutingKeyï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£ï¼š

**åœ¨ä½¿ç”¨ç»‘å®šçš„æ—¶å€™ï¼Œå…¶ä¸­éœ€è¦çš„è·¯ç”±é”®æ˜¯BindingKey**ã€‚æ¶‰åŠçš„å®¢æˆ·ç«¯æ–¹æ³•å¦‚ï¼šchannel.exchangeBindã€channel.queueBindï¼Œå¯¹åº”çš„AMQPå‘½ä»¤ä¸ºExchange.Bindã€Queue.Bindã€‚
åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå…¶ä¸­éœ€è¦çš„è·¯ç”±é”®æ˜¯RoutingKeyã€‚æ¶‰åŠçš„å®¢æˆ·ç«¯æ–¹æ³•å¦‚channel.basicPublishï¼Œå¯¹åº”çš„AMQPå‘½ä»¤ä¸ºBasic.Publishã€‚
ç”±äºæŸäº›å†å²çš„åŸå› ï¼ŒåŒ…æ‹¬ç°å­˜èƒ½æœé›†åˆ°çš„èµ„æ–™æ˜¾ç¤ºï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ä¹ æƒ¯æ€§åœ°å°†BindingKeyå†™æˆRoutingKeyï¼Œå°¤å…¶æ˜¯åœ¨ä½¿ç”¨directç±»å‹çš„äº¤æ¢å™¨çš„æ—¶å€™ã€‚**æœ¬æ–‡åé¢çš„ç¯‡å¹…ä¸­ä¹Ÿä¼šå°†ä¸¤è€…åˆç§°ä¸ºè·¯ç”±é”®**ï¼Œè¯»è€…éœ€è¦æ³¨æ„åŒºåˆ†å…¶ä¸­çš„ä¸åŒï¼Œå¯ä»¥æ ¹æ®ä¸Šé¢çš„è¾¨åˆ«æ–¹æ³•è¿›è¡Œæœ‰æ•ˆçš„åŒºåˆ†ã€‚



**Topicè·¯ç”±ï¼š**



**Exchangeç»‘å®šé˜Ÿåˆ—éœ€è¦åˆ¶å®šKey;  Key å¯ä»¥æœ‰è‡ªå·±çš„è§„åˆ™ï¼›Keyå¯ä»¥æœ‰å ä½ç¬¦ï¼›*æˆ–è€…# ï¼Œ*åŒ¹é…ä¸€ä¸ªå•è¯(ï¼ˆ**è¢«ç‚¹å·â€œ.â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯**ï¼‰)ã€#åŒ¹é…å¤šä¸ªå•è¯ï¼Œåœ¨DirectåŸºç¡€ä¸ŠåŠ ä¸Šæ¨¡ç³ŠåŒ¹é…ï¼›**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617247199890.png" alt="1617247199890" style="zoom:80%;" />



topicç±»å‹çš„äº¤æ¢å™¨åœ¨åŒ¹é…è§„åˆ™ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ƒä¸directç±»å‹çš„äº¤æ¢å™¨ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å°†æ¶ˆæ¯è·¯ç”±åˆ°BindingKeyå’ŒRoutingKeyç›¸åŒ¹é…çš„é˜Ÿåˆ—ä¸­ï¼Œä½†è¿™é‡Œçš„åŒ¹é…è§„åˆ™æœ‰äº›ä¸åŒï¼Œå®ƒçº¦å®šï¼š

RoutingKeyä¸ºä¸€ä¸ªç‚¹å·â€œ.â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆ**è¢«ç‚¹å·â€œ.â€åˆ†éš”å¼€çš„æ¯ä¸€æ®µç‹¬ç«‹çš„å­—ç¬¦ä¸²ç§°ä¸ºä¸€ä¸ªå•è¯**ï¼‰ï¼Œå¦‚â€œcom.rabbitmq.clientâ€ã€â€œjava.util.concurrentâ€ã€â€œcom.hidden.clientâ€ï¼›

BindingKeyå’ŒRoutingKeyä¸€æ ·ä¹Ÿæ˜¯ç‚¹å·â€œ.â€åˆ†éš”çš„å­—ç¬¦ä¸²ï¼›

BindingKeyä¸­å¯ä»¥å­˜åœ¨ä¸¤ç§ç‰¹æ®Šå­—ç¬¦ä¸²â€œ*â€å’Œâ€œï¼ƒâ€ï¼Œç”¨äºåšæ¨¡ç³ŠåŒ¹é…ï¼Œå…¶ä¸­â€œï¼ƒâ€ç”¨äºåŒ¹é…ä¸€ä¸ªå•è¯ï¼Œâ€œï¼ƒâ€ç”¨äºåŒ¹é…å¤šè§„æ ¼å•è¯ï¼ˆå¯ä»¥æ˜¯é›¶ä¸ªï¼‰ã€‚

ä»¥å›¾ä¸‹å›¾çš„é…ç½®ä¸ºä¾‹ï¼š
â—è·¯ç”±é”®ä¸ºâ€œcom.rabbitmq.clientâ€çš„æ¶ˆæ¯ä¼šåŒæ—¶è·¯ç”±åˆ°Queue1å’ŒQueue2ï¼›
â—è·¯ç”±é”®ä¸ºâ€œcom.hidden.clientâ€çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ°Queue2ä¸­ï¼›
â—è·¯ç”±é”®ä¸ºâ€œcom.hidden.demoâ€çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ°Queue2ä¸­ï¼›
â—è·¯ç”±é”®ä¸ºâ€œjava.rabbitmq.demoâ€çš„æ¶ˆæ¯åªä¼šè·¯ç”±åˆ°Queue1ä¸­ï¼›
â—è·¯ç”±é”®ä¸ºâ€œjava.util.concurrentâ€çš„æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒæˆ–è€…è¿”å›ç»™ç”Ÿäº§è€…ï¼ˆéœ€è¦è®¾ç½®mandatoryå‚æ•°ï¼‰ï¼Œå› ä¸ºå®ƒæ²¡æœ‰åŒ¹é…ä»»ä½•è·¯ç”±é”®ã€‚

![1617246802079](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617246802079.png)





**ç¤ºä¾‹**ï¼š

**ç”Ÿäº§è€…**

```C#
//1.å®šä¹‰ä¸»é¢˜ç±»å‹çš„äº¤æ¢æœº
channel.ExchangeDeclare(exchange: "TopicExchange", type: ExchangeType.Topic, durable: true, autoDelete: false, arguments: null); 

//1.å®šä¹‰ä¸»é¢˜ç±»å‹çš„äº¤æ¢æœº
channel.ExchangeDeclare(exchange: "TopicExchange", type: ExchangeType.Topic, durable: true, autoDelete: false, arguments: null); 

// 2.å®šä¹‰é˜Ÿåˆ—
channel.QueueDeclare(queue: "ChinaQueue", durable: true, exclusive: false, autoDelete: false, arguments: null); 
channel.QueueDeclare(queue: "newsQueue", durable: true, exclusive: false, autoDelete: false,  arguments: null);
channel.QueueDeclare(queue: "weatherQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);


//----------ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—---------
//3.1.åŒ¹é… routingKey: "China.#" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— ChinaQueue
channel.QueueBind(queue: "ChinaQueue", exchange: "TopicExchange", routingKey: "China.#", arguments: null);

//3.2.åŒ¹é… routingKey: "#.news" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— newsQueue
channel.QueueBind(queue: "newsQueue", exchange: "TopicExchange", routingKey: "#.news", arguments: null);

//3.3.åŒ¹é… routingKey: "#.weather" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— weatherQueue
channel.QueueBind(queue: "weatherQueue", exchange: "TopicExchange", routingKey: "#.weather", arguments: null);


//4.å‘é€æ¶ˆæ¯ï¼šå„ç§è·¯ç”±é”®ï¼ˆç»‘å®šé”®ï¼‰çš„å„ä¸ªæ¶ˆæ¯
{
//"China.news"
string message = "æ¥è‡ªä¸­å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚";
var body = Encoding.UTF8.GetBytes(message);
channel.BasicPublish(exchange: "TopicExchange", routingKey: "China.news", basicProperties: null, body: body);
Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—");
}

{
//routingKey: "China.weather"
string message = "æ¥è‡ªä¸­å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚";
var body = Encoding.UTF8.GetBytes(message);
channel.BasicPublish(exchange: "TopicExchange", routingKey: "China.weather", basicProperties: null, body: body);
Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—");
}
{
//routingKey: "usa.news" 
string message = "æ¥è‡ªç¾å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚";
var body = Encoding.UTF8.GetBytes(message);
channel.BasicPublish(exchange: "TopicExchange", routingKey: "usa.news", basicProperties: null, body: body);
Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—");
} 
{
//routingKey: "usa.weather"
string message = "æ¥è‡ªç¾å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚";
var body = Encoding.UTF8.GetBytes(message);
channel.BasicPublish(exchange: "TopicExchange", routingKey: "usa.weather", basicProperties: null, body: body);
Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—");
} 

{
    //----------routingKey: "xxx.yyyy",å°†è¢«ä¸¢å¼ƒï¼Œå› ä¸ºæ²¡æœ‰é˜Ÿåˆ—ä¸å…¶åŒ¹é…----------
    string message = "åƒåœ¾æ•°æ®ã€‚ã€‚ã€‚ã€‚";
    var body = Encoding.UTF8.GetBytes(message);
    channel.BasicPublish(exchange: "TopicExchange", routingKey: "xxx.yyyy", basicProperties: null, body: body);
     Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘ï¼Œå°†è¢«ä¸¢å¼ƒï¼Œå› ä¸ºæ²¡æœ‰é˜Ÿåˆ—ä¸å…¶åŒ¹é…");
}
```

æ ¸å¿ƒä»£ç  è§£æï¼š

ä¸»é¢˜ç±»å‹ï¼ˆ**type: ExchangeType.Topic**ï¼‰çš„äº¤æ¢æœºç»‘å®šäº†3ä¸ªé˜Ÿåˆ—ï¼š

```C#
//3.1.åŒ¹é… routingKey: "China.#" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— ChinaQueue
channel.QueueBind(queue: "ChinaQueue", exchange: "TopicExchange", routingKey: "China.#", arguments: null);

//3.2.åŒ¹é… routingKey: "#.news" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— newsQueue
channel.QueueBind(queue: "newsQueue", exchange: "TopicExchange", routingKey: "#.news", arguments: null);

//3.3.åŒ¹é… routingKey: "#.weather" çš„æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ— weatherQueue
channel.QueueBind(queue: "weatherQueue", exchange: "TopicExchange", routingKey: "#.weather", arguments: null);

```

å¦‚ä¸‹æ¶ˆæ¯ï¼Œæ²¡æœ‰åŒ¹é…ä¸Šè¿°ä¸¤ä¸ªé˜Ÿåˆ—çš„è·¯ç”±é”®ï¼Œå°†è¢«ä¸¢å¼ƒï¼š

```C#
//----------routingKey: "xxx.yyyy",å°†è¢«ä¸¢å¼ƒï¼Œå› ä¸ºæ²¡æœ‰é˜Ÿåˆ—ä¸å…¶åŒ¹é…----------
string message = "åƒåœ¾æ•°æ®ã€‚ã€‚ã€‚ã€‚";
var body = Encoding.UTF8.GetBytes(message);
channel.BasicPublish(exchange: "TopicExchange", routingKey: "xxx.yyyy", basicProperties: null, body: body);
Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘ï¼Œå°†è¢«ä¸¢å¼ƒï¼Œå› ä¸ºæ²¡æœ‰é˜Ÿåˆ—ä¸å…¶åŒ¹é…");
```

> å½“ç„¶ï¼Œå¯ä»¥ä½¿ç”¨ï¼šå¤‡ä»½äº¤æ¢å™¨ï¼ˆè‹±æ–‡åç§°ä¸ºAlternate Exchangeï¼Œç®€ç§°AEï¼Œæˆ–è€…æ›´ç›´ç™½åœ°ç§°ä¹‹ä¸ºâ€œå¤‡èƒäº¤æ¢å™¨â€ã€‚ï¼‰æ¥å›æ”¶è¿™äº›æ— æ³•åŒ¹é…è·¯ç”±è§„åˆ™çš„æ¶ˆæ¯

è¿è¡Œè¾“å‡ºï¼š

```powershell
æ¶ˆæ¯ã€æ¥è‡ªä¸­å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—
æ¶ˆæ¯ã€æ¥è‡ªä¸­å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—
æ¶ˆæ¯ã€æ¥è‡ªç¾å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—
æ¶ˆæ¯ã€æ¥è‡ªç¾å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘å·²å‘é€åˆ°é˜Ÿåˆ—
æ¶ˆæ¯ã€åƒåœ¾æ•°æ®ã€‚ã€‚ã€‚ã€‚ã€‘ï¼Œå°†è¢«ä¸¢å¼ƒï¼Œå› ä¸ºæ²¡æœ‰é˜Ÿåˆ—ä¸å…¶åŒ¹é…
```

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617212795081.png" alt="1617212795081" style="zoom:80%;" />

> ç”Ÿäº§è€…å‘æœ‰æ•ˆçš„4æ¡æ¶ˆæ¯ï¼Œè¢«åˆ†åˆ°æ‰€æœ‰é˜Ÿåˆ—åï¼Œæ¶ˆæ¯ä¸€å…±æ‰€ç¤º6æ¡ï¼Œ
>
> ï¼ˆäº¤æ¢æœºåˆ†é…ç»™é˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯å¤åˆ¶ï¼Œè€Œä¸æ˜¯æ‹©å…¶ä¸€ï¼‰



æ¶ˆè´¹è€…1ï¼šç»‘å®šé˜Ÿåˆ— ChinaQueueï¼Œåªå…³å¿ƒä¸­å›½

```C#
//å®šä¹‰æ¶ˆè´¹è€…                                      
var consumer = new EventingBasicConsumer(channel);
consumer.Received += (model, ea) =>
{
    var body = ea.Body;
    var message = Encoding.UTF8.GetString(body.ToArray()); 
    Console.WriteLine($"æ¥æ”¶æˆåŠŸï¼ã€{message}ã€‘");
};

//å¤„ç†æ¶ˆæ¯
channel.BasicConsume(queue: "ChinaQueue",
                     autoAck: true,
                     consumer: consumer);

Console.WriteLine("å¯¹æ¥è‡ªäºä¸­å›½çš„æ¶ˆæ¯æ¯”è¾ƒæ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…");
```

è¿è¡Œè¾“å‡ºï¼š

```powershell
å¯¹æ¥è‡ªäºä¸­å›½çš„æ¶ˆæ¯æ¯”è¾ƒæ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªä¸­å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªä¸­å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘

```



æ¶ˆè´¹è€…2ï¼šç»‘å®šé˜Ÿåˆ— newsQueueï¼Œåªå…³å¿ƒæ–°é—»æ¶ˆæ¯

```C#
//å®šä¹‰æ¶ˆè´¹è€…                                      
var consumer = new EventingBasicConsumer(channel);
consumer.Received += (model, ea) =>
{
    var body = ea.Body;
    var message = Encoding.UTF8.GetString(body.ToArray());
    Console.WriteLine($"æ¥æ”¶æˆåŠŸï¼ã€{message}ã€‘");
};

//å¤„ç†æ¶ˆæ¯
channel.BasicConsume(queue: "newsQueue",
                     autoAck: true,
                     consumer: consumer);

Console.WriteLine("å¯¹æ¥æ–°é—»æ¯”è¾ƒæ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…");
```

è¿è¡Œè¾“å‡ºï¼š

```powershell
å¯¹æ¥æ–°é—»æ¯”è¾ƒæ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªä¸­å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªç¾å›½çš„æ–°é—»æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘

```



æ¶ˆè´¹è€…3ï¼šç»‘å®šé˜Ÿåˆ— newsQueueï¼Œåªå…³å¿ƒå¤©æ°”

```C#
//å®šä¹‰æ¶ˆè´¹è€…                                      
var consumer = new EventingBasicConsumer(channel);
consumer.Received += (model, ea) =>
{
    var body = ea.Body;
    var message = Encoding.UTF8.GetString(body.ToArray());
    Console.WriteLine($"æ¥æ”¶æˆåŠŸï¼ã€{message}ã€‘");
};

//å¤„ç†æ¶ˆæ¯
channel.BasicConsume(queue: "weatherQueue",
                     autoAck: true,
                     consumer: consumer);

Console.WriteLine("å¯¹æ¥å¤©æ°”æ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…");
```

è¿è¡Œè¾“å‡ºï¼š

```powershell
å¯¹æ¥å¤©æ°”æ„Ÿå…´è¶£çš„ æ¶ˆè´¹è€…
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªä¸­å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘
æ¥æ”¶æˆåŠŸï¼ã€æ¥è‡ªç¾å›½çš„å¤©æ°”æ¶ˆæ¯ã€‚ã€‚ã€‚ã€‚ã€‘
```





##### Topic äº¤æ¢æœºåº”ç”¨åœºæ™¯

1. åˆ†ç»„ï¼Œå¯ä»¥æ ¹æ®äº¤æ¢æœºç»‘å®šé˜Ÿåˆ—çš„è§„åˆ™æ¥æŒ‡å®šä¸åŒçš„ç»„ï¼›
2. æ‰“æ ‡ç­¾



#### headers

headersç±»å‹çš„äº¤æ¢å™¨ä¸ä¾èµ–äºè·¯ç”±é”®çš„åŒ¹é…è§„åˆ™æ¥è·¯ç”±æ¶ˆæ¯ï¼Œè€Œæ˜¯æ ¹æ®å‘é€çš„æ¶ˆæ¯å†…å®¹ä¸­çš„headerså±æ€§è¿›è¡ŒåŒ¹é…ã€‚

**åœ¨ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢å™¨æ—¶åˆ¶å®šä¸€ç»„é”®å€¼å¯¹ï¼Œ**

**å½“å‘é€æ¶ˆæ¯åˆ°äº¤æ¢å™¨æ—¶ï¼Œ**RabbitMQä¼šè·å–åˆ°è¯¥æ¶ˆæ¯çš„headersï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„å½¢å¼ï¼‰ï¼Œå¯¹æ¯”å…¶ä¸­çš„é”®å€¼å¯¹æ˜¯å¦å®Œå…¨åŒ¹é…é˜Ÿåˆ—å’Œäº¤æ¢å™¨ç»‘å®šæ—¶æŒ‡å®šçš„é”®å€¼å¯¹ï¼Œå¦‚æœ**å®Œå…¨åŒ¹é…**åˆ™æ¶ˆæ¯ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ï¼Œå¦åˆ™ä¸ä¼šè·¯ç”±åˆ°è¯¥é˜Ÿåˆ—ã€‚

åœ¨ç»‘å®šQueueä¸Exchangeæ—¶æŒ‡å®šä¸€ç»„é”®å€¼å¯¹ä»¥åŠx-matchå‚æ•°ï¼Œx-matchå‚æ•°æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå¯ä»¥è®¾ç½®ä¸ºanyæˆ–è€…allã€‚å¦‚æœè®¾ç½®ä¸ºanyï¼Œæ„æ€å°±æ˜¯åªè¦åŒ¹é…åˆ°äº†headersè¡¨ä¸­çš„ä»»ä½•ä¸€å¯¹é”®å€¼å³å¯ï¼Œallåˆ™ä»£è¡¨éœ€è¦å…¨éƒ¨åŒ¹é…ã€‚

**headersç±»å‹çš„äº¤æ¢å™¨æ€§èƒ½ä¼šå¾ˆå·®ï¼Œè€Œä¸”ä¹Ÿä¸å®ç”¨ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šçœ‹åˆ°å®ƒçš„å­˜åœ¨ã€‚**



```C#
channel.ExchangeDeclare(exchange: "HeaderExchange", type: ExchangeType.Headers, durable: false, autoDelete: false, arguments: null);
channel.QueueDeclare(queue: "HeaderExchangeAllqueue", durable: false, exclusive: false, autoDelete: false, arguments: null);
channel.QueueDeclare(queue: "HeaderExchangeAnyqueue", durable: false, exclusive: false, autoDelete: false, arguments: null);
Console.WriteLine("ç”Ÿäº§è€…å‡†å¤‡å°±ç»ª....");
channel.QueueBind(queue: "HeaderExchangeAllqueue", exchange: "HeaderExchange", routingKey: string.Empty,
                  arguments: new Dictionary<string, object> {
                      { "x-match","all"},
                      { "teacher","Richard"},
                      { "pass","123"}});   
{
    string message = "teacherå’Œpasséƒ½ç›¸åŒæ—¶å‘é€çš„æ¶ˆæ¯";
    var props = channel.CreateBasicProperties();
    props.Headers = new Dictionary<string, object>() {
        { "teacher","Richard"},
        { "pass","123"}
    };
    var body = Encoding.UTF8.GetBytes(message);
    //åŸºæœ¬å‘å¸ƒï¼Œè¿™ä¸ªæ¶ˆæ¯å¯ä»¥è¿›å…¥é˜Ÿåˆ—HeaderExchangeAllqueue
    channel.BasicPublish(exchange: "HeaderExchange",
                         routingKey: string.Empty,
                         basicProperties: props,
                         body: body);
    Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€");
}
{
    //è¿™ä¸ªæ¶ˆæ¯è¢«ä¸¢å¼ƒ
    string message = "teacherå’Œpassæœ‰ä¸€ä¸ªä¸ç›¸åŒæ—¶å‘é€çš„æ¶ˆæ¯";
    var props = channel.CreateBasicProperties();
    props.Headers = new Dictionary<string, object>() {
        { "teacher","Richard"},
        { "pass","234"}
    };
    var body = Encoding.UTF8.GetBytes(message); 
    channel.BasicPublish(exchange: "HeaderExchange",
                         routingKey: string.Empty,
                         basicProperties: props,
                         body: body);
    Console.WriteLine($"æ¶ˆæ¯ã€{message}ã€‘å·²å‘é€");
}
Console.WriteLine("**************************************************************");
{
    channel.QueueBind(queue: "HeaderExchangeAnyqueue",  exchange: "HeaderExchange", routingKey: string.Empty,
                      arguments: new Dictionary<string, object> {
                          { "x-match","any"},
                          { "teacher","Richard"},
                          { "pass","123"},});

    //è¿™ä¸ªæ¶ˆæ¯è¿›å…¥ä¸¤ä¸ªé˜Ÿåˆ—
    string msg = "teacherå’Œpasså®Œå…¨ç›¸åŒæ—¶å‘é€çš„æ¶ˆæ¯";
    var props = channel.CreateBasicProperties();
    props.Headers = new Dictionary<string, object>() {
        { "teacher","Richard"},
        { "pass","123"} 
    };
    var body = Encoding.UTF8.GetBytes(msg); 
    channel.BasicPublish(exchange: "HeaderExchange",
                         routingKey: string.Empty,
                         basicProperties: props,
                         body: body);
    Console.WriteLine($"æ¶ˆæ¯ã€{msg}ã€‘å·²å‘é€"); 
}

{
    //è¿™ä¸ªæ¶ˆæ¯è¿›å…¥HeaderExchangeAnyqueue
    string msg = "teacherå’Œpassæœ‰ä¸€ä¸ªä¸ç›¸åŒæ—¶å‘é€çš„æ¶ˆæ¯";
    var props = channel.CreateBasicProperties();
    props.Headers = new Dictionary<string, object>() {
        { "teacher","Richard"},
        { "pass","234"}
    };
    var body = Encoding.UTF8.GetBytes(msg);
    channel.BasicPublish(exchange: "HeaderExchange",
                         routingKey: string.Empty,
                         basicProperties: props,
                         body: body);
    Console.WriteLine($"æ¶ˆæ¯ã€{msg}ã€‘å·²å‘é€");
}

}
```



##### headersäº¤æ¢æœºåº”ç”¨åœºæ™¯

- ä¸éœ€è¦ä¾èµ–Key
- æ›´å¤šçš„æ—¶å€™ï¼Œåƒè¿™ç§Key Value çš„é”®å€¼ï¼Œå¯èƒ½ä¼šå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ªåŠ¨æ€è§„åˆ™æ¥æ‹¼è£…è¿™ä¸ªKey value ï¼Œä»è€Œè¾¾åˆ°æ¶ˆæ¯çµæ´»è½¬å‘åˆ°ä¸åŒçš„é˜Ÿåˆ—ä¸­å»ã€‚ã€‚ã€‚
  Class-Student    China-Wuhan   å­˜å‚¨åœ¨æ•°æ®åº“ä¸­



## æ¶ˆæ¯ç¡®è®¤æœºåˆ¶



## æ¶ˆæ¯äº‹åŠ¡æœºåˆ¶







## RabbitMQé›†ç¾¤

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617256338670.png" alt="1617256338670" style="zoom:80%;" />

é›†ç¾¤æ¶æ„
åˆ†å¸ƒå¼æ¶æ„

é›†ç¾¤ï¼šè¿˜æ˜¯å¤šå°æœåŠ¡å™¨ï¼Œæ²¡ä¸€å°æœåŠ¡å™¨éƒ½å¯ä»¥å®Œæˆæ•´ä¸ªä¸šåŠ¡æµç¨‹ï¼›

ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼šåˆ†ä¸ºåä¸ªæ­¥éª¤ï¼›
æœ‰å¤šå°æœåŠ¡å™¨ï¼›æ¯å°æœåŠ¡å™¨è´Ÿè´£å…¶ä¸­å‡ ä¸ªæ­¥éª¤ï¼›ä¸²è”èµ·æ¥==åˆ†å¸ƒå¼æ¶æ„ï¼›



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617256463770.png" alt="1617256463770" style="zoom:80%;" />



**é›†ç¾¤ä»¥åï¼Œé™¤äº†é˜Ÿåˆ—ä»¥å¤–ï¼Œå…¶å®ƒä¸œè¥¿éƒ½æ˜¯å…±äº«çš„**



é›†ç¾¤ç±»å‹ï¼šæ™®é€šé€šé›†ç¾¤ã€é•œåƒé›†ç¾¤

- æ™®é€šé›†ç¾¤ï¼šç»“æ„åŒæ­¥ï¼Œæ¶ˆæ¯å®ä½“åªå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼Œä½† consumer åœ¨éæ¶ˆæ¯èŠ‚ç‚¹è·å–æ—¶ï¼ŒèŠ‚ç‚¹é—´å­˜åœ¨æ¶ˆæ¯æ‹‰å–ï¼Œæ˜“äº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚
- é•œåƒé›†ç¾¤ï¼šé›†ç¾¤ä¸­ä¸€ä¸ª masterï¼Œè´Ÿè´£è°ƒè¯•ï¼Œå¤„ç†æ¶ˆæ¯å®ä½“ï¼Œå…¶ä»–èŠ‚ç‚¹ä¿å­˜ä¸€ä»½æ•°æ®åˆ°æœ¬åœ°ï¼›æ€§èƒ½ä¸»è¦é  master æ‰¿è½½ã€‚



### æ™®é€šé›†ç¾¤

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617256551755.png" alt="1617256551755" style="zoom:80%;" />



### 



### RabbtiMQé›†ç¾¤å®æ“

#### ç¯å¢ƒæè¿°

##### æ“ä½œç³»ç»Ÿ

| IPåœ°å€          | ä¸»æœºåç§° | æ“ä½œç³»ç»Ÿç‰ˆæœ¬ | erlang ç‰ˆæœ¬ | rabbitmq ç‰ˆæœ¬ |
| --------------- | -------- | ------------ | ----------- | ------------- |
| 192.168.130.129 | centos-1 | CentOS-7.6   | V11.2       | 3.8.14        |
| 192.168.130.130 | centos-2 | CentOS-7.6   | V11.2       | 3.8.14        |
| 192.168.130.131 | centos-3 | CentOS-7.6   | V11.2       | 3.8.14        |

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617680144974.png" alt="1617680144974" style="zoom:80%;" />

##### è®¾ç½®é™æ€IP

```shell
å‘½ä»¤ï¼š
# cd /etc/sysconfig/network-scripts/
# vim ifcfg-ens33

ä¿®æ”¹å†…å®¹ä¸ºï¼š
TYPE=Ethernet
PROXY_METHOD=none

BOOTPROTO=static #é™æ€IP

BROWSER_ONLY=no
DEFROUTE=yes

IPADDR=192.168.130.129  #è°ƒæ•´
NETMASK=255.255.255.0  #è°ƒæ•´
GATEWAY=192.168.1.1   #è°ƒæ•´
DNS1=202.106.0.20    #è°ƒæ•´

DNS2=8.8.8.8
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=312fb2fd-eade-4e6f-8abb-5602fc8d2da4
DEVICE=ens33

ONBOOT=yes  # æ”¯æŒé™æ€IP


ä¿®æ”¹å®Œæ¯•åï¼šæ‰§è¡Œå‘½ä»¤ï¼š
# service network restart
é‡å¯ç½‘å¡ï¼š
# systemctl restart network
```



##### ä¿®æ”¹ä¸»æœºå

```powershell
æŸ¥çœ‹ä¸»æœºåç§°ï¼š
# hostname
ä¿®æ”¹ä¸»æœºåç§°ï¼š
# hostnamectl set-hostname <ä¸»æœºåç§°> ## æ°¸ä¹…ä¿®æ”¹äº†ä¸»æœºåç§°
```



##### æ–‡ä»¶é…ç½®

ç¼–è¾‘/etc/hosts æ–‡ä»¶é…ç½®

```shell
#è¿½åŠ 
192.168.130.129 centos-1
192.168.130.130 centos-2
192.168.130.131 centos-3
```



##### å…³é—­é˜²ç«å¢™

```shell
æŸ¥çœ‹é˜²ç«å¢™ï¼š
# systemctl status  firewalld.service
å¼€å¯é˜²ç«å¢™ï¼š
# systemctl start firewalld.service    
å…³é—­é˜²ç«å¢™
# systemctl stop firewalld.service           #åœæ­¢firewall
# systemctl disable firewalld.service        #ç¦æ­¢firewallå¼€æœºå¯åŠ¨
```



#### å®‰è£…

##### å®‰è£…ç¯å¢ƒä¾èµ–åŒ…

è¿™é‡Œè™šæ‹Ÿæœºç³»ç»Ÿä¸ºCentos7ï¼Œé‡‡ç”¨çš„å®‰è£…æ–¹å¼æ˜¯yumå®‰è£…ï¼Œä¸ºäº†ç®€å•ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨å®˜æ–¹æä¾›çš„erlangå’ŒRabbitMQ-serverçš„è‡ªåŠ¨å®‰è£…è„šæœ¬([å®˜æ–¹å®‰è£…æ–‡æ¡£](https://www.rabbitmq.com/install-rpm.html))ï¼Œé€è¡Œæ‰§è¡Œä¸‹è¾¹çš„ä»£ç å°±å¯ä»¥å®‰è£…å®Œæˆerlangå’ŒRabbitMQã€‚

```she
å®‰è£…socat
# yum install socat
```

##### å®‰è£… erlang

rabbitMQ æ˜¯ç”¨ erlang è¯­è¨€å†™çš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£… erlangã€‚

```shell
# curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash
# yum -y install erlang

æµ‹è¯•æŸ¥çœ‹ç‰ˆæœ¬ï¼š
# erl
```



##### å®‰è£… rabbitmq

```shell
# curl -s https://packagecloud.io/install/repositories/rabbitmq/rabbitmq-server/script.rpm.sh | sudo bash
# yum -y install rabbitmq-server

æµ‹è¯•æŸ¥çœ‹ç‰ˆæœ¬ï¼šrabbitmqctl version
```



##### å¯åŠ¨rabbitmqæœåŠ¡

```shell
å¯åŠ¨ï¼š
# systemctl start rabbitmq-server
åœæ­¢ï¼š
# rabbitmqctl stop_app

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
# systemctl status rabbitmq-server

#å¼€å¯å¯åŠ¨æœåŠ¡
# systemctl enable rabbitmq-server
```



##### æ·»åŠ webç®¡ç†æ’ä»¶

```shell
æ’ä»¶åˆ—è¡¨
# rabbitmq-plugins list

å¼€å¯webç®¡ç†æ’ä»¶
# rabbitmq-plugins enable rabbitmq_management
```



#### è®¾ç½® rabbitMQ

##### å¼€å¯ rabbitMQ web é¡µé¢è®¿é—®

```shell
# rabbitmq-plugins enable rabbitmq_management
ä¹Ÿå¯ä»¥ç›´æ¥å°†å¼€å¯çš„æ’ä»¶é…ç½®å†™å…¥é…ç½®æ–‡ä»¶
# echo "[rabbitmq_management]." > /usr/local/rabbitmq/etc/rabbitmq/enabled_plugins

å¤–ç½‘è®¿é—®ï¼Œé˜²ç«å¢™å¼€å‘ç«¯å£15672
# firewall-cmd --add-port=15672/tcp --permanent ## webç®¡ç†ç•Œé¢ç«¯å£
# firewall-cmd --reload ## åˆ·æ–°æ”¾è¡Œåˆ—è¡¨
```

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617683423283.png" alt="1617683423283" style="zoom:80%;" />



##### å¯åŠ¨ rabbitmq-server

```shell
# rabbitmq-server start    # å‰å°å¯åŠ¨

  ##  ##
  ##  ##      RabbitMQ 3.7.7. Copyright (C) 2007-2018 Pivotal Software, Inc.
  ##########  Licensed under the MPL.  See http://www.rabbitmq.com/
  ######  ##
  ##########  Logs: /usr/local/rabbitmq/var/log/rabbitmq/rabbit@centos-3.log
                    /usr/local/rabbitmq/var/log/rabbitmq/rabbit@centos-3_upgrade.log

              Starting broker...
 completed with 3 plugins.    # è¯´æ˜ web ç®¡ç†æ’ä»¶å·²ç»å¯åŠ¨


# rabbitmq-server  -detached    # åå°å¯åŠ¨ï¼Œä¸å ç”¨ç»ˆç«¯ï¼Œæ¨è
Warning: PID file not written; -detached was passed.7

# rabbitmq-server start_app
# rabbitmq-server stop_app
```



##### ç®¡ç†è´¦å·

```shell
é»˜è®¤æœ‰ä¸€ä¸ªå±äºlocalhostçš„ç”¨æˆ·guest å¯†ç guestï¼Œä¸æ”¯æŒè¿œç¨‹è®¿é—®(åªç”¨ä½¿ç”¨localhostè®¿é—®)ï¼Œæ€ä¹ˆè§£å†³?
1ã€ä½¿ç”¨rabbitmqctlæ¥ç®¡ç†ç”¨æˆ·
# whereis rabbitmq
# cd /usr/lib/rabbitmq/bin

[root@centos-1 ~]# rabbitmqctl list_users
Listing users ...
user    tags
guest   [administrator]


./rabbitmqctl add_user rabbit rabbit ## æ·»åŠ ç”¨æˆ·
./rabbitmqctl set_permissions rabbit -p / ".*" ".*" ".*"
./rabbitmqctl set_user_tags rabbit administrator
2ã€æ·»åŠ ç«¯å£
# firewall-cmd --add-port=5672/tcp --permanent ## rabbitmqç«¯å£
# firewall-cmd --add-port=15672/tcp --permanent ## webç®¡ç†ç•Œé¢ç«¯å£
# firewall-cmd --reload ## åˆ·æ–°æ”¾è¡Œåˆ—è¡¨
3ã€é€šè¿‡http://ip:15672
è¾“å…¥rabbit/rabbit è¿›è¡Œwebç®¡ç•Œé¢
```



##### RabbitMQ ç«¯å£

â˜…è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„**ï¼Œè®°å¾—é…ç½®ä¸‹hostsï¼Œåœ¨/etc/hostsé‡ŒåŠ ä¸Šæœ¬æœºçš„åç§°ã€‚erlangè¿›ç¨‹éœ€è¦hostæ¥è¿›è¡Œè¿æ¥ï¼Œæ‰€ä»¥å®ƒä¼šæ£€æŸ¥ä½ çš„hostsé…ç½®ã€‚è¿˜éœ€è¦è®¾ç½®ä¸‹é˜²ç«å¢™ï¼Œä¸‰ä¸ªç«¯å£è¦æ‰“å¼€ã€‚**15672**æ˜¯ç®¡ç†ç•Œé¢ç”¨çš„ï¼Œ**25672æ˜¯é›†ç¾¤ä¹‹é—´ä½¿ç”¨çš„ç«¯å£ï¼Œ4369æ˜¯erlangè¿›ç¨‹epmdç”¨æ¥åšnodeè¿æ¥çš„ã€‚

```shell
1.æŸ¥çœ‹æ”¾è¡Œç«¯å£ï¼š
# firewall-cmd --list-port
2ã€æ·»åŠ ç«¯å£
# firewall-cmd --add-port=5672/tcp --permanent   ## rabbitmqç«¯å£
# firewall-cmd --add-port=15672/tcp --permanent  ## webç®¡ç†ç•Œé¢ç«¯å£
# firewall-cmd --add-port=4369/tcp --permanent   ##nodeé€šä¿¡ç«¯å£
# firewall-cmd --reload ## åˆ·æ–°æ”¾è¡Œåˆ—è¡¨
```



#### é›†ç¾¤é…ç½®

##### å‡†å¤‡å·¥ä½œ

| IPåœ°å€          | ä¸»æœºåç§° | æ“ä½œç³»ç»Ÿç‰ˆæœ¬ | erlang ç‰ˆæœ¬ | rabbitmq ç‰ˆæœ¬ |
| --------------- | -------- | ------------ | ----------- | ------------- |
| 192.168.130.129 | centos-1 | CentOS-7.6   | V11.2       | 3.8.14        |
| 192.168.130.130 | centos-2 | CentOS-7.6   | V11.2       | 3.8.14        |
| 192.168.130.131 | centos-3 | CentOS-7.6   | V11.2       | 3.8.14        |



<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617687976871.png" alt="1617687976871" style="zoom:80%;" />



ç¼–è¾‘/etc/hosts æ–‡ä»¶é…ç½®æ˜ å°„

```shell

# æ¯å°Linuxè™šæ‹Ÿæœºéƒ½ç¼–è¾‘ä¸ºï¼š
# vim /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.130.129 centos-1
192.168.130.130 centos-2
192.168.130.131 centos-3

# æˆ–è€…æŠŠä¸€ä¸ªç¼–è¾‘å¥½çš„å¤åˆ¶åˆ°å…¶å®ƒä¸»æœºä¸Š 
# scp /etc/hosts root@192.168.130.130:/etc/hosts 
# scp /etc/hosts root@192.168.130.131:/etc/hosts 

```

å¯åŠ¨RabbitMQï¼Œé˜²ç«å¢™æ”¾è¡Œç«¯å£

```shell
å‘½ä»¤æ‰§è¡Œå¯åŠ¨å‰å°å¯åŠ¨rabbitmqæœåŠ¡ï¼š
# rabbitmq-server start

å‘½ä»¤æ‰§è¡Œå¯åŠ¨åå°å¯åŠ¨rabbitmqæœåŠ¡ï¼š
# rabbitmq-server  -detached

å‘½ä»¤æ‰§è¡Œåœæ­¢RabbitMqæœåŠ¡ï¼š 
# rabbitmqctl stop

å‘½ä»¤æ‰§è¡Œå¯ç”¨æ’ä»¶ï¼š
# rabbitmq-plugins enable rabbitmq_management

æŸ¥çœ‹rabbitMqè¿›ç¨‹ï¼š
# ps -ef | grep rabbitmq


1.æŸ¥çœ‹æ”¾è¡Œç«¯å£ï¼š
# firewall-cmd --list-port

2å…³é—­ç«¯å£ï¼š
# firewall-cmd --permanent --zone=public --remove-port=5672/tcp
# firewall-cmd --permanent --zone=public --remove-port=15672/tcp
# firewall-cmd --permanent --zone=public --remove-port=4369/tcp
# firewall-cmd --permanent --zone=public --remove-port=25672/tcp

3ã€æ·»åŠ ç«¯å£
# firewall-cmd --add-port=5672/tcp --permanent ## rabbitmqç«¯å£
# firewall-cmd --add-port=15672/tcp --permanent ## webç®¡ç†ç•Œé¢ç«¯å£
# firewall-cmd --add-port=4369/tcp --permanent ##node erlangé€šä¿¡ç«¯å£
# firewall-cmd --add-port=25672/tcp --permanent ##node é›†ç¾¤èŠ‚ç‚¹é€šä¿¡

# firewall-cmd --reload ## åˆ·æ–°æ”¾è¡Œåˆ—è¡¨
```

>é›†ç¾¤ç®¡ç†ï¼šæ²¡æœ‰æ˜æ˜¾çš„ä¸»ä»ï¼Œä¸»è¦æ˜¯ disk å’Œ ram èŠ‚ç‚¹çš„åŒºåˆ«
>
>é›†ç¾¤è¦æ±‚ï¼šä¸æ”¯æŒè·¨ç½‘æ®µ(erlang é™åˆ¶)ã€å±€åŸŸç½‘ã€‘
>
>é›†ç¾¤ç±»å‹ï¼šæ™®é€šé€šé›†ç¾¤ã€é•œåƒé›†ç¾¤
>
>- æ™®é€šé›†ç¾¤ï¼šç»“æ„åŒæ­¥ï¼Œæ¶ˆæ¯å®ä½“åªå­˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼Œä½† consumer åœ¨éæ¶ˆæ¯èŠ‚ç‚¹è·å–æ—¶ï¼ŒèŠ‚ç‚¹é—´å­˜åœ¨æ¶ˆæ¯æ‹‰å–ï¼Œæ˜“äº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚
>- é•œåƒé›†ç¾¤ï¼šé›†ç¾¤ä¸­ä¸€ä¸ª masterï¼Œè´Ÿè´£è°ƒè¯•ï¼Œå¤„ç†æ¶ˆæ¯å®ä½“ï¼Œå…¶ä»–èŠ‚ç‚¹ä¿å­˜ä¸€ä»½æ•°æ®åˆ°æœ¬åœ°ï¼›æ€§èƒ½ä¸»è¦é  master æ‰¿è½½ã€‚
>
>æŒä¹…åŒ–ï¼Œåˆ†ä¸¤éƒ¨åˆ†ï¼š
>
>- Rabbitmq æœåŠ¡å™¨é…ç½®æŒä¹…åŒ–ï¼šé»˜è®¤çš„å°±æ˜¯æŒä¹…åŒ–(discç±»å‹);
>- ä»£ç æŒä¹…åŒ–ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—å’Œå­˜æ”¾åœ¨é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯éƒ½æ˜¯éæŒä¹…åŒ–çš„ï¼Œéœ€è¦åœ¨å»ºäº§é˜Ÿåˆ—æ—¶æŒ‡å®š
>
>



**åœ¨é…ç½®ç¾¤é›†å‰ï¼Œå¿…é¡»ä¿è¯å„èŠ‚ç‚¹ä¹‹é—´çš„ä¸»æœºåèƒ½å¤Ÿç›¸äº’è§£æ**

RabbitMQ èŠ‚ç‚¹ä½¿ç”¨åŸŸåç›¸äº’å¯»å€ï¼Œå› æ­¤æ‰€æœ‰ç¾¤é›†æˆå‘˜çš„ä¸»æœºåå¿…é¡»èƒ½å¤Ÿä»æ‰€æœ‰ç¾¤é›†èŠ‚ç‚¹è§£æï¼Œå¯ä»¥ä¿®æ”¹ `/etc/hosts` æ–‡ä»¶æˆ–è€…ä½¿ç”¨ DNS è§£æ

å¦‚æœè¦ä½¿ç”¨èŠ‚ç‚¹åç§°çš„å®Œæ•´ä¸»æœºåï¼ˆRabbitMQ é»˜è®¤ä¸ºçŸ­åç§°ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨DNSè§£æå®Œæ•´çš„ä¸»æœºåï¼Œåˆ™å¯èƒ½éœ€è¦è°ƒæŸ¥è®¾ç½®ç¯å¢ƒå˜é‡  `RABBITMQ_USE_LONGNAME = true`

ä¸€ä¸ªç¾¤é›†çš„ç»„æˆå¯ä»¥åŠ¨æ€æ”¹å˜ï¼Œæ‰€æœ‰çš„ RabbitMQ å¼€å§‹ä½œä¸ºå•ä¸ªèŠ‚ç‚¹è¿è¡Œï¼Œè¿™äº›èŠ‚ç‚¹å¯ä»¥åŠ å…¥åˆ°ç¾¤é›†ï¼Œç„¶åä¹Ÿå¯ä»¥å†æ¬¡è„±ç¦»ç¾¤é›†è½¬åŠ å•èŠ‚ç‚¹ã€‚

RabbitMQ ç¾¤é›†å¯ä»¥å®¹å¿å•ä¸ªèŠ‚ç‚¹çš„æ•…éšœã€‚èŠ‚ç‚¹å¯ä»¥éšæ„å¯åŠ¨å’Œåœæ­¢ï¼Œåªè¦å®ƒä»¬åœ¨å…³é—­æ—¶èƒ½å’Œç¾¤é›†æˆå‘˜èŠ‚ç‚¹è”ç³»ã€‚

**èŠ‚ç‚¹å¯ä»¥æ˜¯ Disk èŠ‚ç‚¹æˆ– RAM èŠ‚ç‚¹**

RAM èŠ‚ç‚¹å°†å†…éƒ¨æ•°æ®åº“è¡¨å­˜å‚¨åœ¨ RAM ä¸­ã€‚è¿™ä¸åŒ…æ‹¬æ¶ˆæ¯ï¼Œæ¶ˆæ¯å­˜å‚¨ç´¢å¼•ï¼Œé˜Ÿåˆ—ç´¢å¼•å’Œå…¶ä»–èŠ‚ç‚¹çŠ¶æ€ï¼Œåœ¨ 90ï¼… ä»¥ä¸Šçš„æƒ…å†µä¸‹ï¼Œæ‚¨å¸Œæœ›æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç£ç›˜èŠ‚ç‚¹;

RAM èŠ‚ç‚¹æ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå¯ç”¨äºæ”¹å–„é«˜æ’é˜Ÿï¼Œäº¤æ¢æˆ–ç»‘å®šæµå¤±çš„æ€§èƒ½é›†ç¾¤ã€‚RAM èŠ‚ç‚¹ä¸æä¾›æœ‰æ„ä¹‰çš„æ›´é«˜çš„æ¶ˆæ¯é€Ÿç‡ã€‚

ç”±äº RAM èŠ‚ç‚¹ä»…å°†å†…éƒ¨æ•°æ®åº“è¡¨å­˜å‚¨åœ¨ RAM ä¸­ï¼Œå› æ­¤å®ƒä»¬å¿…é¡»åœ¨å¯åŠ¨æ—¶ä»å¯¹ç­‰èŠ‚ç‚¹åŒæ­¥å®ƒä»¬ã€‚è¿™æ„å‘³ç€**ç¾¤é›†å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ã€‚å› æ­¤æ— æ³•æ‰‹åŠ¨åˆ é™¤é›†ç¾¤ä¸­å‰©ä½™çš„æœ€åä¸€ä¸ªç£ç›˜èŠ‚ç‚¹**



##### è®¾ç½®èŠ‚ç‚¹ç›¸äº’ä¿¡ä»»ï¼šErlang Cookie

RabbitMQ èŠ‚ç‚¹å’Œ CLI å·¥å…·ï¼ˆä¾‹å¦‚ rabbitmqctl ï¼‰ä½¿ç”¨ cookie æ¥ç¡®å®šå®ƒä»¬æ˜¯å¦è¢«å…è®¸ç›¸äº’é€šä¿¡ï¼Œè¦ä½¿ä¸¤ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿé€šä¿¡ï¼Œå®ƒä»¬å¿…é¡»å…·æœ‰ç›¸åŒçš„å…±äº«å¯†é’¥ï¼Œç§°ä¸º Erlang Cookieã€‚ Cookie åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæœ€å¤šå¯ä»¥æœ‰ 255 ä¸ªå­—ç¬¦ã€‚

```shell
[root@centos-1 ~]# cat /var/lib/rabbitmq/.erlang.cookie
UFBDMSIYOKOGGVFJHPUI
```

å®ƒé€šå¸¸å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ä¸­ã€‚**è¯¥æ–‡ä»¶å¿…é¡»åªèƒ½ç”±æ‰€æœ‰è€…è®¿é—®ï¼ˆ400 æƒé™ï¼‰**ã€‚æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹å¿…é¡»å…·æœ‰ç›¸åŒçš„ cookieï¼Œæ–‡ä»¶ä½ç½®ï¼ˆrpm å®‰è£…ï¼‰ /var/lib/rabbitmq/.erlang.cookieï¼Œå¦‚æœæ˜¯æºç å®‰è£…çš„ .erlang.cookie æ–‡ä»¶åœ¨**å¯åŠ¨ç”¨æˆ·çš„å®¶ç›®å½•ä¸­**ã€‚æŠŠ rabbit2ã€rabbit3 è®¾ç½®æˆå’Œ rabbit1 ä¸€æ ·çš„å³å¯ï¼Œæƒé™æ˜¯ 400 ï¼Œæˆ–è€…ç›´æ¥å¤åˆ¶ä¸€ä»½è¿‡å»å³å¯ã€‚

```shell
è¿™é‡Œé‡‡ç”¨å¤åˆ¶çš„æ–¹å¼

å‘½ä»¤Copyæ–‡ä»¶ï¼š
# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.130.130:/var/lib/rabbitmq
# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.130.131:/var/lib/rabbitmq

é‡‡ç”¨æºç å®‰è£…çš„ rabbitmq .erlang.cookie æ–‡ä»¶åœ¨ /root ç›®å½•ä¸‹
# scp /root/.erlang.cookie centos-2:/root/
root@centos-2's password: 
.erlang.cookie   100%   20     2.3KB/s   00:00    
# scp /root/.erlang.cookie centos-3:/root/
root@centos-3's password: 
.erlang.cookie   100%   20     7.5KB/s   00:00 
```



##### æ­£å¸¸æ–¹å¼å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹

```shell
# rabbitmq-server -detached   #åå°å¯åŠ¨  åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¯åŠ¨ rabbitmq-server
```



##### æŸ¥çœ‹ç¾¤é›†çŠ¶æ€

centos-1:

```shell
[root@centos-1 ~]# rabbitmqctl cluster_status
Cluster status of node rabbit@centos-1 ...
Basics

Cluster name: rabbit@centos-1

Disk Nodes

rabbit@centos-1

Running Nodes

rabbit@centos-1

Versions

rabbit@centos-1: RabbitMQ 3.8.14 on Erlang 23.3.1

Maintenance status

Node: rabbit@centos-1, status: not under maintenance

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@centos-1, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@centos-1, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@centos-1, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

Feature flags

Flag: drop_unroutable_metric, state: disabled
Flag: empty_basic_get_metric, state: disabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: enabled
Flag: quorum_queue, state: enabled
Flag: user_limits, state: enabled
Flag: virtual_host_metadata, state: enabled

```

centos-2:

```shell
[root@centos-2 ~]# abbitmqctl cluster_status
bash: abbitmqctl: æœªæ‰¾åˆ°å‘½ä»¤...
[root@centos-2 ~]# rabbitmqctl cluster_status
Cluster status of node rabbit@centos-2 ...
Basics

Cluster name: rabbit@centos-2

Disk Nodes

rabbit@centos-2

Running Nodes

rabbit@centos-2

Versions

rabbit@centos-2: RabbitMQ 3.8.14 on Erlang 23.3.1

Maintenance status

Node: rabbit@centos-2, status: not under maintenance

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@centos-2, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@centos-2, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@centos-2, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

Feature flags

Flag: drop_unroutable_metric, state: disabled
Flag: empty_basic_get_metric, state: disabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: enabled
Flag: quorum_queue, state: enabled
Flag: user_limits, state: enabled
Flag: virtual_host_metadata, state: enabled

```



##### åˆ›å»ºç¾¤é›†

**a. åœæ­¢ centos-02 çš„ rabbitmq åº”ç”¨ç¨‹åº**

```shell
# åœ¨å…¶ä½™èŠ‚ç‚¹ä¸Šæ“ä½œ
å…³é—­æ‰€æœ‰rabbitmqè¿›ç¨‹ï¼š  pkill rabbitmq
æ ¹æ®è¿›ç¨‹IDå…³é—­è¿›ç¨‹: kill -9 9038

#åªæ‰§è¡Œä¸‹é¢å‘½åå³å¯
[root@centos-2 ~]# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@centos-2 ...

```

**b. åŠ å…¥ rabbit@centos-1 ç¾¤é›†1**

```shell
# åœ¨å…¶ä½™èŠ‚ç‚¹ä¸Šæ“ä½œ
[root@centos-2 ~]# rabbitmqctl join_cluster rabbit@centos-1
Clustering node rabbit@centos-2 with rabbit@centos-1
   
# å¦‚æœè¿™ä¸€æ­¥æŠ¥é”™çš„è¯ï¼Œè¯·åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰“å¼€ç›¸åº”çš„ç«¯å£ï¼Œæ‰“å¼€ 4369 ç«¯å£ ï¼ˆRefuse Accessï¼‰,è§£å†³æ–¹å¼
# firewall-cmd --add-port=4369/tcp --permanent
# firewall-cmd --add-port=25672/tcp --permanent #rabbitmq èŠ‚ç‚¹é—´çš„CLIé€šä¿¡ç«¯å£
 
# firewall-cmd --reload
```



**c. å¯åŠ¨ rabbitMQ ç¨‹åº**

```shell
# åœ¨å…¶ä½™ä¸ªèŠ‚ç‚¹ä¸Šæ“ä½œ
#  rabbitmqctl start_app
[root@centos-2 ~]# rabbitmqctl start_app
Starting node rabbit@centos-2 ...

```



**b. æŸ¥çœ‹ç¾¤é›†çŠ¶æ€**

```shell
åœ¨ç¾¤é›†ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥æŸ¥çœ‹åˆ°ç¾¤é›†çš„çŠ¶æ€
[root@centos-2 ~]# rabbitmqctl cluster_status
Cluster status of node rabbit@centos-2 ...
Basics

Cluster name: rabbit@centos-1

Disk Nodes

rabbit@centos-1
rabbit@centos-2

Running Nodes

rabbit@centos-1
rabbit@centos-2

Versions

rabbit@centos-1: RabbitMQ 3.8.14 on Erlang 23.3.1
rabbit@centos-2: RabbitMQ 3.8.14 on Erlang 23.3.1

Maintenance status

Node: rabbit@centos-1, status: not under maintenance
Node: rabbit@centos-2, status: not under maintenance

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@centos-1, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@centos-1, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@centos-1, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Node: rabbit@centos-2, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@centos-2, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@centos-2, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

Feature flags

Flag: drop_unroutable_metric, state: disabled
Flag: empty_basic_get_metric, state: disabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: enabled
Flag: quorum_queue, state: enabled
Flag: user_limits, state: enabled
Flag: virtual_host_metadata, state: enabled

```

![1617716310111](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617716310111.png)

é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¾¤é›†è¿è¡Œçš„åŒæ—¶éšæ—¶å‘ç¾¤é›†æ·»åŠ æ–°èŠ‚ç‚¹

å·²åŠ å…¥ç¾¤é›†çš„èŠ‚ç‚¹å¯ä»¥éšæ—¶åœæ­¢ï¼Œä¹Ÿå¯ä»¥å´©æºƒã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œç¾¤é›†çš„å…¶ä½™éƒ¨åˆ†éƒ½ä¼šç»§ç»­è¿è¡Œï¼Œå¹¶ä¸”èŠ‚ç‚¹åœ¨å†æ¬¡å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨ â€è·Ÿä¸Šâ€œï¼ˆåŒæ­¥ï¼‰å…¶å®ƒç¾¤é›†èŠ‚ç‚¹ã€‚



æ¯”å¦‚ï¼šåœæ‰`rabbit@centos-3`èŠ‚ç‚¹ï¼š

```shell
[root@centos-3 ~]# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@centos-3 ...
```

åœ¨èŠ‚ç‚¹1ä¸­æŸ¥çœ‹é›†ç¾¤çŠ¶æ€:

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617718263458.png" alt="1617718263458" style="zoom:80%;" />

```shell
[root@centos-1 ~]# rabbitmqctl cluster_status
Cluster status of node rabbit@centos-1 ...
Basics

Cluster name: rabbit@centos-1

Disk Nodes

rabbit@centos-1
rabbit@centos-2
rabbit@centos-3

Running Nodes

rabbit@centos-1
rabbit@centos-2

```



å†å¯åŠ¨`rabbit@centos-3`èŠ‚ç‚¹ ï¼š

```shell
[root@centos-3 ~]# rabbitmqctl start_app
Starting node rabbit@centos-3 ...
```

åœ¨èŠ‚ç‚¹1ä¸­æŸ¥çœ‹é›†ç¾¤çŠ¶æ€:

```shell
[root@centos-1 ~]# rabbitmqctl cluster_status
Cluster status of node rabbit@centos-1 ...
Basics

Cluster name: rabbit@centos-1

Disk Nodes

rabbit@centos-1
rabbit@centos-2
rabbit@centos-3

Running Nodes

rabbit@centos-1
rabbit@centos-2
rabbit@centos-3

```

![1617718474572](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617718474572.png)



> æ³¨æ„ï¼š
>
> å½“æ•´ä¸ªé›†ç¾¤å…³é—­æ—¶ï¼Œæœ€åä¸€ä¸ªå…³é—­çš„èŠ‚ç‚¹å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå¯åŠ¨çš„èŠ‚ç‚¹ï¼Œå¦‚æœä¸æ˜¯è¿™æ ·ï¼ŒèŠ‚ç‚¹ä¼šç­‰å¾… 30s ç­‰å¾…æœ€åçš„ç£ç›˜èŠ‚ç‚¹æ¢å¤çŠ¶æ€ï¼Œç„¶åå¤±è´¥ã€‚å¦‚æœæœ€åä¸‹çº¿çš„èŠ‚ç‚¹ä¸èƒ½ä¸Šçº¿ï¼Œå¯ä»¥ä½¿ç”¨ forget_cluster_node å‘½ä»¤å°†å…¶ä»ç¾¤é›†ä¸­åˆ é™¤ã€‚å¦‚æœæ‰€æœ‰çš„èŠ‚ç‚¹ä¸å—æ§åˆ¶çš„åŒæ—¶å®•æœºï¼Œæ¯”å¦‚æ‰ç”µï¼Œä¼šè¿›å…¥æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šè®¤ä¸ºå…¶ä»–èŠ‚ç‚¹æ¯”è‡ªå·±å®•æœºçš„è¦æ™šï¼Œå³è‡ªå·±å…ˆå®•æœºï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ force_boot æŒ‡ä»¤æ¥å¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹ã€‚



###### **æ™®é€šé˜Ÿåˆ—(é›†ç¾¤)**

 exchangeï¼Œbuindlingå†æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šéƒ½ä¼šä¿å­˜ä¸€ä»½ï¼Œä½†æ˜¯queueåªä¼šå­˜å‚¨åœ¨å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šå­˜å‚¨ä¸€ä»½queueçš„metaä¿¡æ¯ 

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617724058505.png" alt="1617724058505" style="zoom:80%;" />

> æ³¨æ„ï¼šé›†ç¾¤åï¼Œå„èŠ‚ç‚¹é™¤é˜Ÿåˆ—(é˜Ÿåˆ—çš„ç»“æ„æ˜¯å…±äº«çš„ï¼Œä½†æ˜¯æ¶ˆæ¯ä¸å…±äº«)å¤–ï¼Œå…¶å®ƒéƒ½æ˜¯å…±äº«çš„

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé›†ç¾¤çš„æ–¹å¼æ˜¯æ™®é€šé›†ç¾¤ï¼Œé€šè¿‡é›†ç¾¤æ–¹å¼è¿æ¥åï¼Œä¼šé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºé˜Ÿåˆ—å¹¶å­˜å‚¨æ¶ˆæ¯ï¼Œå…¶å®ƒé›†ç¾¤çš„è®°å¾—ä¹Ÿèƒ½çœ‹åˆ°é˜Ÿåˆ—æ¶ˆæ¯ï¼Œä½†æ˜¯ï¼Œå…¶å®ƒèŠ‚ç‚¹çœ‹åˆ°çš„é˜Ÿåˆ—æ¶ˆæ¯æ˜¯æ¥è‡ªæŸä¸ªèŠ‚ç‚¹ï¼š

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617722071071.png" alt="1617722071071" style="zoom:80%;" />

è¿™æ—¶ï¼Œ**æŠŠèŠ‚ç‚¹1åœæ‰, **

```shell
[root@centos-1 ~]# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@centos-1 ...
```

è¿™æ—¶çš„é˜Ÿåˆ—çŠ¶æ€æ˜¯ï¼šdownï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![1617723222400](images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617723222400.png)

**æ¶ˆæ¯æ¥è‡ªèŠ‚ç‚¹1ï¼Œæ¶ˆè´¹è€…å°†æ— æ³•æ¶ˆè´¹æ¶ˆæ¯ï¼Œå› ä¸ºçœŸæ­£çš„æ•°æ®åœ¨èŠ‚ç‚¹1ä¸Š**

>èŠ‚ç‚¹1åœæ­¢åï¼Œæ¶ˆè´¹è€…è¿æ¥èŠ‚ç‚¹2æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼š
>
>The AMQP operation was interrupted: AMQP close-reason, initiated by Peer, code=404, text='NOT_FOUND - home node 'rabbit@centos-1' of durable queue 'ColonyProducerMessage' in vhost '/' is down or inaccessible', classId=60, methodId=20



ç»¼ä¸Šï¼š

**æ™®é€šé›†ç¾¤æ–¹å¼ï¼Œæ— æ³•è¾¾åˆ°çœŸæ­£çš„é«˜å¯ç”¨**ï¼Œè¦å®ç°çœŸæ­£çš„é«˜å¯ç”¨ï¼Œå¾—ä½¿ç”¨é•œåƒé›†ç¾¤



###### é•œåƒé˜Ÿåˆ—(é›†ç¾¤)

æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯é˜Ÿåˆ—ç»“æ„+æ¶ˆæ¯æ•°æ®

ä»»ä½•ä¸€ä¸ªå•æœºå®•æœºäº†ï¼Œå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–å•æœºæ¶ˆè´¹æ¶ˆæ¯ï¼›å¦‚æœå®•æœºçš„å•æœºæ¢å¤äº†ï¼Œæ¶ˆæ¯å¯ä»¥è‡ªåŠ¨åŒæ­¥ï¼›

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617724408120.png" alt="1617724408120" style="zoom:80%;" />



**d. è®¾ç½®ç¾¤é›†æ¨¡å¼ä¸º"é•œåƒé˜Ÿåˆ—"æ¨¡å¼**



```shell
# rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all","ha-sync-mode":"automatic"}'

rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]


-p Vhostï¼š å¯é€‰å‚æ•°ï¼Œé’ˆå¯¹æŒ‡å®švhostä¸‹çš„queueè¿›è¡Œè®¾ç½®
Name: policyçš„åç§°
Pattern: queueçš„åŒ¹é…æ¨¡å¼(æ­£åˆ™è¡¨è¾¾å¼)
    æ³¨æ„ï¼š"^"ï¼Œè¿™ä¸ªè§„åˆ™è¦æ ¹æ®è‡ªå·±ä¿®æ”¹ï¼Œæ¯”å¦‚ï¼š"^ha\."ï¼Œè¿™ä¸ªæ˜¯æŒ‡åŒæ­¥"ha."å¼€å¤´çš„é˜Ÿåˆ—åç§°
    
Definitionï¼šé•œåƒå®šä¹‰ï¼ŒåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ha-mode, ha-params, ha-sync-mode
	ha-mode:æŒ‡æ˜é•œåƒé˜Ÿåˆ—çš„æ¨¡å¼ï¼Œæœ‰æ•ˆå€¼ä¸º all/exactly/nodes
		allï¼šè¡¨ç¤ºåœ¨é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒ
		exactlyï¼šè¡¨ç¤ºåœ¨æŒ‡å®šä¸ªæ•°çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹çš„ä¸ªæ•°ç”±ha-paramsæŒ‡å®š
		nodesï¼šè¡¨ç¤ºåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šè¿›è¡Œé•œåƒï¼ŒèŠ‚ç‚¹åç§°é€šè¿‡ha-paramsæŒ‡å®š
	ha-paramsï¼šha-modeæ¨¡å¼éœ€è¦ç”¨åˆ°çš„å‚æ•°
	ha-sync-modeï¼šè¿›è¡Œé˜Ÿåˆ—ä¸­æ¶ˆæ¯çš„åŒæ­¥æ–¹å¼ï¼Œæœ‰æ•ˆå€¼ä¸ºautomaticå’Œmanual
priorityï¼šå¯é€‰å‚æ•°ï¼Œpolicyçš„ä¼˜å…ˆçº§
```

`ha-sync-mode`ï¼š å¦‚æœæ­¤èŠ‚ç‚¹ä¸è¿›è¡Œè®¾ç½®ï¼Œåœ¨å…¶ä¸­ä¸€å°æœåŠ¡å™¨å®•æœºå†å¯åŠ¨å ä¼šæŠ¥  Unsynchronised Mirrors XXXX  é”™è¯¯ã€‚è¿™æ—¶å€™åœ¨é˜Ÿåˆ—è¯¦ç»†ä¿¡æ¯é¡µé¢éœ€è¦æ‰‹åŠ¨ç‚¹å‡»åŒæ­¥é˜Ÿåˆ—ï¼Œæˆ–è€…ç”¨å‘½ä»¤è¡Œæ‰§è¡Œå‘½ä»¤ `rabbitmqctl sync_queue name`



ä¸‹é¢çš„å‘½ä»¤ï¼ŒæŠŠé˜Ÿåˆ—è®¾ç½®ä¸ºé•œåƒé˜Ÿåˆ—ï¼Œå¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸­æ‰§è¡Œï¼š

```shell
[root@centos-3 ~]# rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all","ha-sync-mode":"automatic"}'
Setting policy "ha-all" for pattern "^" to "{"ha-mode":"all","ha-sync-mode":"automatic"}" with priority "0" for vhost "/" ...

```

è®¾ç½®äº†é•œåƒé˜Ÿåˆ—åï¼Œé˜Ÿåˆ—çš„ä¿¡æ¯æœ‰äº†å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617726634148.png" alt="1617726634148" style="zoom:80%;" />

> äº¤æ¢æœºçš„ç‰¹æ€§ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼š
>
> <img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617726725737.png" alt="1617726725737" style="zoom:80%;" />



**éªŒè¯é•œåƒé˜Ÿåˆ—çš„é«˜å¯ç”¨**

æ¶ˆè´¹è€…ä½¿ç”¨é›†ç¾¤IPåˆ—è¡¨åˆ›å»ºè¿æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
var factory = new ConnectionFactory();
//factory.HostName = "192.168.130.129";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
factory.Port = 5672;
factory.UserName = "rabbit";//ç”¨æˆ·å
factory.Password = "rabbit";//å¯†ç  
factory.VirtualHost = "/";  //è™šæ‹Ÿä¸»æœºï¼Œé»˜è®¤æ–œæ 
using (var connection = factory.CreateConnection(new List<string>() {
"192.168.130.129",
"192.168.130.130",
"192.168.130.131"
}))
{
    using (IModel channel = connection.CreateModel())
    {
        //ç›‘å¬æ¶ˆæ¯
    }
 }
```

è¿™æ—¶ï¼Œæ¶ˆè´¹è€…ä»ä¸ŠIPåˆ—è¡¨ä¸­éšæœºè¿æ¥ä¸€ä¸ªèŠ‚ç‚¹, è¿™é‡Œå‡è®¾æ˜¯è¿æ¥èŠ‚ç‚¹2ï¼Œ

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617727619812.png" alt="1617727619812" style="zoom:80%;" />

è¿™æ—¶ï¼Œåœæ­¢æ‰æ¶ˆè´¹è€…è¿æ¥çš„èŠ‚ç‚¹2ï¼š

```shell
[root@centos-2 ~]# rabbitmqctl start_app
Starting node rabbit@centos-2 ...
```

**ç­‰å¾…å¤§æ¦‚10ç§’å·¦å³ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é›†ç¾¤çš„å…¶å®ƒèŠ‚ç‚¹ï¼ˆè¿™é‡Œæ˜¯èŠ‚ç‚¹1ï¼‰**

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617727702311.png" alt="1617727702311" style="zoom:80%;" />



åœ¨èŠ‚ç‚¹2è¢«åœæ­¢çš„è¿™æ®µæ—¶é—´äº†ï¼Œæ–°å¢çš„é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œåœ¨èŠ‚ç‚¹2æ¢å¤åï¼Œè‡ªåŠ¨åŒæ­¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617766633956.png" alt="1617766633956" style="zoom:80%;" />



#### ç¾¤é›†ç§»é™¤èŠ‚ç‚¹

å½“èŠ‚ç‚¹ä¸å†æ˜¯èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œéœ€è¦ä»ç¾¤é›†ä¸­æ˜ç¡®åœ°åˆ é™¤èŠ‚ç‚¹ã€‚

å°† rabbit@centos-2 ä»ç¾¤é›†ä¸­åˆ é™¤ï¼Œå›åˆ°ç‹¬ç«‹æ¨¡å¼

```shell
åœ¨ rabbit@centos-2 ä¸Šæ“ä½œï¼š
1ã€åœæ­¢ RabbitMQ åº”ç”¨ç¨‹åºã€‚
# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@centos-2 ...

2ã€é‡ç½®èŠ‚ç‚¹ã€‚
# rabbitmqctl reset
Resetting node rabbit@centos-2 ...

3ã€é‡æ–°å¯åŠ¨ RabbitMQ åº”ç”¨ç¨‹åºã€‚
# rabbitmqctl start_app
Starting node rabbit@centos-2 ...
 completed with 3 plugins.
 
4ã€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ cluster_status å‘½ä»¤ï¼Œç¡®è®¤ rabbit@centos-2 ç°åœ¨å·²ç»ä¸å†æ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ç‹¬ç«‹è¿è¡Œ
# rabbitmqctl cluster_status
```



ä¹Ÿå¯ä»¥è¿œç¨‹åˆ é™¤èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œåœ¨å¤„ç†æ— å“åº”çš„èŠ‚ç‚¹æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚

ä¾‹å¦‚ï¼Œåœ¨èŠ‚ç‚¹ rabbit@node01 ä¸ŠæŠŠ rabbit@centos-3 ä»ç¾¤é›†ä¸­ç§»é™¤

```shell
1ã€å…ˆåœ¨ rabbit@centos-3 ä¸Šå°† RabbitMQ åº”ç”¨åœæ‰
# rabbitmqctl stop_app
Stopping rabbit application on node rabbit@centos-3 ...

2ã€åœ¨ rabbit@node01 ä¸Šè¿œç¨‹å°† rabbit@centos-3 åˆ é™¤
# rabbitmqctl forget_cluster_node rabbit@centos-3
Removing node rabbit@centos-3 from the cluster

3ã€è¯·æ³¨æ„ï¼Œè¿™æ—¶ï¼Œrabbit@centos-3 ä»ç„¶è®¤ä¸ºå®ƒè¿˜åœ¨ rabbit@node01 çš„ç¾¤é›†é‡Œé¢ï¼Œå¹¶è¯•å›¾å¯åŠ¨å®ƒï¼Œè¿™å°†ä¼šå¯¼è‡´é”™è¯¯ã€‚æˆ‘ä»¬éœ€è¦å°† rabbit@centos-3 é‡æ–°è®¾ç½®æ‰èƒ½é‡æ–°å¯åŠ¨å®ƒã€‚(åœ¨ rabbit@centos-3 ä¸Šæ“ä½œ)
[root@centos-3 ~]# rabbitmqctl start_app
Starting node rabbit@centos-3 ...
Error:
{:rabbit, {{:inconsistent_cluster, 'Node \'rabbit@centos-3\' thinks it\'s clustered with node \'rabbit@centos-1\', but \'rabbit@centos-1\' disagrees'}, {:rabbit, :start, [:normal, []]}}}

# rabbitmqctl reset
Resetting node rabbit@centos-3 ...

4ã€é‡æ–°å¯åŠ¨ rabbit@centos-3
# rabbitmqctl start_app
Starting node rabbit@centos-3 ...
```

> rabbitmqctl reset
>
> è¯¥å‘½ä»¤ä¼šåˆ é™¤ï¼Œäº¤æ¢æœºï¼Œé˜Ÿåˆ—ï¼Œè´¦å·ï¼ˆåªä¿ç•™åŸå§‹çš„guetè´¦å·ï¼‰





ç°åœ¨ï¼Œä¸‰ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä½œä¸ºç‹¬ç«‹çš„èŠ‚ç‚¹åœ¨è¿è¡Œã€‚

> æ³¨æ„ï¼šæ­¤æ—¶ï¼Œrabbit@node01 ä¿ç•™äº†ç°‡çš„å‰©ä½™çŠ¶æ€ï¼Œè€Œ rabbicentos-202 å’Œ rabbit@centos-3 æ˜¯åˆšåˆšåˆå§‹åŒ–çš„ RabbitMQã€‚å¦‚æœæƒ³é‡æ–°åˆå§‹åŒ– rabbit@node01 çš„è¯ï¼Œéœ€è¦æŒ‰ç…§ä¸å…¶å®ƒèŠ‚ç‚¹ç›¸åŒçš„æ­¥éª¤è¿›è¡Œå³å¯ï¼š
>
> 1ã€åœæ­¢ RabbitMQ åº”ç”¨ç¨‹åº
>
> 2ã€ é‡ç½® RabbitMQ
>
> 3ã€å¯åŠ¨ RabbitMQ åº”ç”¨ç¨‹åº



#### ä½¿ç”¨é›†ç¾¤

**ç”Ÿäº§è€…**

è¿æ¥é›†ç¾¤

```C#
ConnectionFactory factory = new ConnectionFactory();
//factory.HostName = "192.168.130.129";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ 

factory.Port = 5672;
factory.UserName = "rabbit";//ç”¨æˆ·å
factory.Password = "rabbit";//å¯†ç  
//factory.AutomaticRecoveryEnabled = true; //å¦‚æœconnectionæŒ‚æ‰æ˜¯å¦é‡æ–°è¿æ¥ 
//factory.TopologyRecoveryEnabled = true;//è¿æ¥æ¢å¤åï¼Œè¿æ¥çš„äº¤æ¢æœºï¼Œé˜Ÿåˆ—ç­‰æ˜¯å¦ä¸€åŒæ¢å¤ 
factory.VirtualHost = "/";  //è™šæ‹Ÿä¸»æœºï¼Œé»˜è®¤æ–œæ 
using (var connection = factory.CreateConnection(new List<string>() {
    "192.168.130.129",
    "192.168.130.130",
    "192.168.130.131"
}))
{

    using (IModel channel = connection.CreateModel())
    {
            //å‘é€æ¶ˆæ¯ä»£ç ï¼Œè§ä¸‹
    }
}
```

ä½¿ç”¨é›†ç¾¤å‘é€æ¶ˆæ¯

```shell
channel.QueueDeclare(queue: "ColonyProducerMessage", durable: true, exclusive: false, autoDelete: false, arguments: null);

channel.ExchangeDeclare(exchange: "ColonyProducerMessageExChange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);

channel.QueueBind(queue: "ColonyProducerMessage", exchange: "ColonyProducerMessageExChange", routingKey: "ColonyProducerMessageExChangeKey", arguments: null);

Console.ForegroundColor = ConsoleColor.Red;
Console.WriteLine("ç”Ÿäº§è€…ColonyProducerDemoå·²å‡†å¤‡å°±ç»ª~~~");
int i = 1;

while (true)
{
    IBasicProperties basicProperties = channel.CreateBasicProperties();
    basicProperties.Persistent = true;
    string message = $"æ¶ˆæ¯{i}";
    byte[] body = Encoding.UTF8.GetBytes(message);
    channel.BasicPublish(exchange: "ColonyProducerMessageExChange",
    routingKey: "ColonyProducerMessageExChangeKey",
    basicProperties: basicProperties,
    body: body);
    Console.WriteLine($"é›†ç¾¤æ¶ˆæ¯ï¼š{message} å·²å‘é€~");
    i++;
    Thread.Sleep(10);

    if (i >= 200)
    {
       break;
    }
}
```



**æ¶ˆè´¹è€…**ï¼š

```she
var factory = new ConnectionFactory();
            //factory.HostName = "192.168.130.129";//RabbitMQæœåŠ¡åœ¨æœ¬åœ°è¿è¡Œ
            factory.Port = 5672;
            factory.UserName = "rabbit";//ç”¨æˆ·å
            factory.Password = "rabbit";//å¯†ç  
            factory.VirtualHost = "/";  //è™šæ‹Ÿä¸»æœºï¼Œé»˜è®¤æ–œæ 
            using (var connection = factory.CreateConnection(new List<string>() {
                    "192.168.130.129",
                    "192.168.130.130",
                    "192.168.130.131"
            }))
            {
                using (IModel channel = connection.CreateModel())
                {
                    #region EventingBasicConsumer
                    //å®šä¹‰æ¶ˆè´¹è€…                                      
                    var consumer = new EventingBasicConsumer(channel);
                    int i = 0;
                    consumer.Received += (model, ea) =>
                    {
                        var message = Encoding.UTF8.GetString(ea.Body.ToArray()); 
                        //æ‰‹åŠ¨ç¡®è®¤  æ¶ˆæ¯æ­£å¸¸æ¶ˆè´¹  å‘Šè¯‰Brokerï¼šä½ å¯ä»¥æŠŠå½“å‰è¿™æ¡æ¶ˆæ¯åˆ é™¤æ‰äº†
                        channel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: false);
                        Console.WriteLine(message);
                        Thread.Sleep(2000);
                    };
                    //autoAck: false  æ˜¾ç¤ºç¡®è®¤ï¼› 
                    channel.BasicConsume(queue: "ColonyProducerMessage", autoAck: false, consumer: consumer); 
                    Console.ReadKey();
                    #endregion
                }
            }
        }
```



## ç”Ÿäº§ç«¯æ¶ˆæ¯ç¡®è®¤

ç”Ÿäº§ç«¯å¦‚ä½•çŸ¥é“Brokeræ”¶åˆ°æ¶ˆæ¯å‘¢

### Txäº‹åŠ¡æ¨¡å¼

åŸºäºAMPQåè®®ï¼›å¯ä»¥è®©ä¿¡é“è®¾ç½®æˆä¸€ä¸ªå¸¦äº‹åŠ¡çš„ä¿¡é“ï¼Œä»AMQPåè®®å±‚é¢ä¸Šæ¥çš„äº‹åŠ¡æ¨¡å¼ï¼Œåˆ†ä¸ºä¸‰æ­¥ï¼š
channel.TxSelect(); å¼€å¯ä¸€ä¸ªäº‹åŠ¡
channel.TxCommit();æäº¤äº‹åŠ¡
channel.TxRollback(); //äº‹åŠ¡å›æ»š

**äº‹åŠ¡æ¨¡å¼æ˜¯åŒæ­¥æ¨¡å¼ï¼Œåœ¨äº‹åŠ¡æäº¤ä¹‹å‰ä¸èƒ½ç»§ç»­å‘é€æ¶ˆçš„ï¼Œæ‰€ä»¥äº‹åŠ¡æ¨¡å¼æ•ˆç‡å·®ä¸€äº›ï¼›**



**ç¤ºä¾‹**

```shell
//åˆ›å»ºé€šé“channel
using (var channel = connection.CreateModel())
{
    Console.WriteLine("ç”Ÿäº§è€…å‡†å¤‡å°±ç»ª....");
    channel.QueueDeclare(queue: "MessageTxQueue01", durable: true, exclusive: false, autoDelete: false, arguments: null);
    channel.QueueDeclare(queue: "MessageTxQueue02", durable: true, exclusive: false, autoDelete: false, arguments: null);
    //å£°æ˜äº¤æ¢æœºexchang
    channel.ExchangeDeclare(exchange: "MessageTxQueueExchange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);
    //ç»‘å®šexchangeå’Œqueue
    channel.QueueBind(queue: "MessageTxQueue01", exchange: "MessageTxQueueExchange", routingKey: "MessageTxKey01");
    channel.QueueBind(queue: "MessageTxQueue02", exchange: "MessageTxQueueExchange", routingKey: "MessageTxKey02");
    string message = "";
    
//å‘é€æ¶ˆæ¯
//åœ¨æ§åˆ¶å°è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰enteré”®å‘é€æ¶ˆæ¯
while (!message.Equals("quit", StringComparison.CurrentCultureIgnoreCase))
{
    message = Console.ReadLine();
    var body = Encoding.UTF8.GetBytes(message);
    try
    {
        //å¼€å¯äº‹åŠ¡æœºåˆ¶
        channel.TxSelect(); //äº‹åŠ¡æ˜¯åè®®æ”¯æŒçš„
        //å‘é€æ¶ˆæ¯
        //åŒæ—¶ç»™å¤šä¸ªé˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼›è¦ä¹ˆéƒ½æˆåŠŸï¼›è¦ä¹ˆéƒ½å¤±è´¥ï¼›
        channel.BasicPublish(exchange: "MessageTxQueueExchange", routingKey: "MessageTxKey01", basicProperties: null, body: body);
        channel.BasicPublish(exchange: "MessageTxQueueExchange", routingKey: "MessageTxKey02", basicProperties: null, body: body);

        //æ¨¡æ‹Ÿå¼‚å¸¸
        //int i = 0;
        //int j = 1;
        //int b = j / i;

        //äº‹åŠ¡æäº¤
        channel.TxCommit(); //åªæœ‰äº‹åŠ¡æäº¤æˆåŠŸä»¥åï¼Œæ‰ä¼šçœŸæ­£çš„å†™å…¥åˆ°é˜Ÿåˆ—é‡Œé¢å»
        Console.WriteLine($"ã€{message}ã€‘å‘é€åˆ°BrokeæˆåŠŸï¼");
    }
    catch (Exception ex)
    {
        Console.WriteLine($"ã€{message}ã€‘å‘é€åˆ°Brokerå¤±è´¥ï¼");
        channel.TxRollback(); //äº‹åŠ¡å›æ»š
        //å¯ä»¥åœ¨è¿™é‡Œè¿˜é‡è¯•ä¸€ä¸‹ã€‚ã€‚ã€‚
        throw;
    }
}
```



### Confirmæ¨¡å¼

ç”Ÿäº§è€…å°†ä¿¡é“è®¾ç½®æˆconfirmï¼ˆç¡®è®¤ï¼‰æ¨¡å¼ï¼Œä¸€æ—¦ä¿¡é“è¿›å…¥confirmæ¨¡å¼ï¼Œæ‰€æœ‰åœ¨è¯¥ä¿¡é“ä¸Šé¢å‘å¸ƒçš„æ¶ˆæ¯éƒ½ä¼šè¢«æŒ‡æ´¾ä¸€ä¸ªå”¯ä¸€çš„IDï¼ˆä»1å¼€å§‹ï¼‰ï¼Œä¸€æ—¦æ¶ˆæ¯è¢«æŠ•é€’åˆ°æ‰€æœ‰åŒ¹é…çš„é˜Ÿåˆ—ä¹‹åï¼ŒRabbitMQå°±ä¼šå‘é€ä¸€ä¸ªç¡®è®¤ï¼ˆBasic.Ackï¼‰ç»™ç”Ÿäº§è€…ï¼ˆåŒ…å«æ¶ˆæ¯çš„å”¯ä¸€IDï¼‰ï¼Œè¿™å°±ä½¿å¾—ç”Ÿäº§è€…çŸ¥æ™“æ¶ˆæ¯å·²ç»æ­£ç¡®åˆ°è¾¾äº†ç›®çš„åœ°äº†ã€‚å¦‚æœæ¶ˆæ¯å’Œé˜Ÿåˆ—æ˜¯å¯æŒä¹…åŒ–çš„ï¼Œé‚£ä¹ˆç¡®è®¤æ¶ˆæ¯ä¼šåœ¨æ¶ˆæ¯å†™å…¥ç£ç›˜ä¹‹åå‘å‡ºã€‚RabbitMQå›ä¼ ç»™ç”Ÿäº§è€…çš„ç¡®è®¤æ¶ˆæ¯ä¸­çš„deliveryTagåŒ…å«äº†ç¡®è®¤æ¶ˆæ¯çš„åºå·ï¼Œæ­¤å¤–RabbitMQä¹Ÿå¯ä»¥è®¾ç½®channel.basicAckæ–¹æ³•ä¸­çš„multipleå‚æ•°ï¼Œè¡¨ç¤ºåˆ°è¿™ä¸ªåºå·ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·²ç»å¾—åˆ°äº†å¤„ç†

<img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617767216573.png" alt="1617767216573" style="zoom:80%;" />

æ³¨æ„è¾¨åˆ«è¿™é‡Œçš„ç¡®è®¤(ç”Ÿäº§ç«¯çš„ç¡®è®¤ï¼Œæ˜¯ä¸Šå›¾å·¦è¾¹éƒ¨åˆ†)å’Œæ¶ˆè´¹æ—¶å€™çš„ç¡®è®¤(ä¸Šå›¾å³è¾¹éƒ¨åˆ†)ä¹‹é—´çš„å¼‚åŒ,



å°±æ˜¯åº”ç­”æ¨¡å¼ï¼Œç”Ÿäº§è€…å‘é€ä¸€æ¡æ¶ˆæ¯ä¹‹åï¼ŒRabbitmqæœåŠ¡å™¨åšäº†ä¸ªå“åº”ï¼ŒOK,æ”¶åˆ°äº†ï¼›

**Confirmæ¨¡å¼æ˜¯å¼‚æ­¥æ¨¡å¼**ï¼Œåœ¨åº”ç­”ä¹‹å‰ï¼Œå¯ä»¥ç»§ç»­å‘é€æ¶ˆæ¯ï¼›å•æ¡æ¶ˆæ¯ã€æ‰¹é‡æ¶ˆæ¯

**RabbitMQå¼•å…¥äº†publisher confirmæœºåˆ¶æ¥å¼¥è¡¥äº‹åŠ¡æœºåˆ¶çš„ç¼ºé™·ï¼Œæé«˜äº†æ•´ä½“çš„ååé‡**



**ç”Ÿäº§ç«¯ç¡®è®¤**

1  å•æ¡æ¶ˆæ¯ç¡®è®¤ï¼š channel.waitForConfirms()
2  æ‰¹é‡æ¶ˆæ¯ç¡®è®¤ï¼š channel.waitForConfirmsOrDie()æ‰¹é‡ç¡®è®¤æ¨¡å¼ 
3  å¼‚æ­¥ç›‘å¬æ¶ˆæ¯ç¡®è®¤ï¼šchannel.addConfirmListener()

channel.ConfirmSelect();å¼€å¯ç¡®è®¤æ¨¡å¼
æ¶ˆæ¯å‘é€ä»¥åï¼Œæä¾›ä¸€ä¸ªå›æ‰§æ–¹æ³•WaitForConfirms(); è¿”å›ä¸€ä¸ªbool å€¼ï¼›



**ç¤ºä¾‹**

```shell
Console.WriteLine("ç”Ÿäº§è€…å‡†å¤‡å°±ç»ª....");
channel.QueueDeclare(queue: "ConfirmSelectQueue", durable: true, exclusive: false, autoDelete: false, arguments: null);
//å£°æ˜äº¤æ¢æœºexchang
channel.ExchangeDeclare(exchange: "ConfirmSelectQueueExchange", type: ExchangeType.Direct, durable: true, autoDelete: false, arguments: null);
//ç»‘å®šexchangeå’Œqueue
channel.QueueBind(queue: "ConfirmSelectQueue", exchange: "ConfirmSelectQueueExchange", routingKey: "ConfirmSelectKey");
string message = "";
//å‘é€æ¶ˆæ¯
//åœ¨æ§åˆ¶å°è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰enteré”®å‘é€æ¶ˆæ¯
while (!message.Equals("quit", StringComparison.CurrentCultureIgnoreCase))
{
    message = Console.ReadLine();
    var body = Encoding.UTF8.GetBytes(message);
    try
    {
        //å¼€å¯æ¶ˆæ¯ç¡®è®¤æ¨¡å¼
        channel.ConfirmSelect();
        //å‘é€æ¶ˆæ¯
        channel.BasicPublish(exchange: "ConfirmSelectQueueExchange", routingKey: "ConfirmSelectKey", basicProperties: null, body: body);
        //äº‹åŠ¡æäº¤ 
        if (channel.WaitForConfirms()) //å¦‚æœä¸€æ¡æ¶ˆæ¯æˆ–å¤šæ¶ˆæ¯éƒ½ç¡®è®¤å‘é€
        {
           Console.WriteLine($"ã€{message}ã€‘å‘é€åˆ°BrokeæˆåŠŸï¼");
        }
        else
        { 
        //å¯ä»¥è®°å½•ä¸ªæ—¥å¿—ï¼Œé‡è¯•ä¸€ä¸‹ï¼›
        }

        //å¦‚æœæ‰€æœ‰æ¶ˆæ¯å‘é€æˆåŠŸ å°±æ­£å¸¸æ‰§è¡Œï¼›å¦‚æœæœ‰æ¶ˆæ¯å‘é€å¤±è´¥ï¼›å°±æŠ›å‡ºå¼‚å¸¸ï¼›
        channel.WaitForConfirmsOrDie();
        }
        catch (Exception)
        {
            Console.WriteLine($"ã€{message}ã€‘å‘é€åˆ°Brokerå¤±è´¥ï¼");
            //å°±åº”è¯¥é€šçŸ¥ç®¡ç†å‘˜
            // é‡æ–°è¯•ä¸€ä¸‹
        }
}
```



## æ¶ˆè´¹ç«¯æ¶ˆæ¯ç¡®è®¤

æ¶ˆè´¹ç«¯æ¶ˆæ¯ç¡®è®¤

- è‡ªåŠ¨ç¡®è®¤

  æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™ï¼Œåªè¦æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±ç›´æ¥å›æ‰§ç»™RabbitMQï¼ŒOKæ²¡é—®é¢˜ï¼›  

  å­˜åœ¨çš„é—®é¢˜ï¼šå¦‚æœåªæ˜¯æ¶ˆè´¹æˆåŠŸäº†ä¸€æ¡æ¶ˆæ¯ï¼›RabbitMQä¹Ÿä¼šè®¤ä¸ºä½ æ˜¯å…¨éƒ¨æˆåŠŸäº†ï¼Œä¼šæŠŠæ‰€æœ‰æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼›è¿™æ ·ä¼šå¯¼è‡´æ¶ˆæ¯çš„ä¸¢å¤±ï¼›

  ```shell
  //å®šä¹‰æ¶ˆè´¹è€…                                      
  var consumer = new EventingBasicConsumer(channel);
  int i = 0;
  consumer.Received += (model, ea) =>
  {
      var message = Encoding.UTF8.GetString(ea.Body.ToArray()); 
      Console.WriteLine(message);
      Thread.Sleep(2000);
  };
  //autoAck: true  è‡ªåŠ¨ç¡®è®¤ï¼› 
  channel.BasicConsume(queue: "ColonyProducerMessage", autoAck: ture, consumer: consumer); 
  Console.ReadKey();
  ```

  åªæœ‰è¦åœ¨`var message = ....`è¿™è¡Œä»£ç æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼Œåªè¦æœ‰ä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯é©¬ä¸Šæ¸…ç©ºï¼Œé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ç»™é»˜è®¤åˆ†ç»™è¯¥æ¶ˆè´¹è€…ï¼Œå…¶å®ƒæ¶ˆè´¹è€…æ˜¯æ²¡æœ‰åˆ†é…åˆ°æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

  <img src="images/.Net%E6%9E%B6%E6%9E%84%E5%B8%88%E4%B9%8B%E8%B7%AF(%E4%BA%8C)/1617782009411.png" alt="1617782009411" style="zoom:80%;" />

â€‹         **æ­¤æ—¶ï¼Œæ¶ˆè´¹è€…ç«¯å¯ä»¥è¿›è¡Œæ¶ˆè´¹æ¶ˆæ¯ï¼Œä½†æ˜¯è‡ªåŠ¨ç¡®è®¤ç•™ä¸‹ä¸€ä¸ªä¸¥é‡çš„éšæ‚£æ˜¯ï¼š**

â€‹         **å¦‚æœæ¶ˆè´¹è€…ç«¯åœ¨å‡ºç°å¼‚å¸¸ï¼Œé‡å¯æ¶ˆè´¹è€…åï¼Œå†ä¹Ÿæ— æ³•æ¶ˆè´¹æœªæ¶ˆè´¹çš„æ¶ˆæ¯**



- æ˜¾ç¤ºç¡®è®¤

  åˆç§°æ‰‹åŠ¨ç¡®è®¤ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¡ï¼Œå›æ‰§ç»™RabbitMqä¸€æ¡æ¶ˆæ¯ï¼ŒRabbitmq åªåˆ é™¤å½“å‰è¿™ä¸€æ¡æ¶ˆæ¯ï¼›ç›¸å½“äºæ˜¯ä¸€æ¡æ¶ˆè´¹äº†ï¼Œåˆ é™¤ä¸€æ¡æ¶ˆæ¯ï¼›
  æ€§èƒ½ç¨å¾®ä½ä¸€äº›ï¼›

  ```shell
  //å®šä¹‰æ¶ˆè´¹è€…                                      
  var consumer = new EventingBasicConsumer(channel);
  int i = 0;
  consumer.Received += (model, ea) =>
  {
      var message = Encoding.UTF8.GetString(ea.Body.ToArray());
      
      //æ‰‹åŠ¨ç¡®è®¤  æ¶ˆæ¯æ­£å¸¸æ¶ˆè´¹  å‘Šè¯‰Brokerï¼šä½ å¯ä»¥æŠŠå½“å‰è¿™æ¡æ¶ˆæ¯åˆ é™¤æ‰äº†
      channel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: false);
      Console.WriteLine(message);
      Thread.Sleep(2000);
  };
  //autoAck: false  æ˜¾ç¤ºç¡®è®¤ï¼› 
  channel.BasicConsume(queue: "ColonyProducerMessage", autoAck: false, consumer: consumer); 
  Console.ReadKey();
  ```



ç»¼ä¸Šï¼Œæ¨èä½¿ç”¨ æ˜¾ç¤ºç¡®è®¤æ¨¡å¼







